<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Explorar - Portfolio Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-white flex items-center gap-2">
                <span class="text-3xl">üìä</span> Portfolio Tracker
            </a>
            <div class="flex items-center gap-3">
                <a href="/" class="text-gray-400 hover:text-white transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    Dashboard
                </a>
                <span class="bg-purple-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Explorar
                </span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Secci√≥n Favoritos -->
        <div id="favoritos-section" class="bg-gray-800 rounded-xl border border-gray-700 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span>‚≠ê</span> Mis Favoritos
                </h2>
                <button onclick="toggleFavoritosSection()" class="text-gray-400 hover:text-white transition">
                    <svg id="favoritos-toggle-icon" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
            </div>
            
            <div id="favoritos-content">
                <div id="favoritos-loading" class="text-center py-4 text-gray-400">
                    <div class="loader mx-auto mb-2"></div>
                    Cargando favoritos...
                </div>
                
                <div id="favoritos-empty" class="hidden text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">‚≠ê</div>
                    <p>No tienes favoritos a√∫n</p>
                    <p class="text-sm mt-1">Busca activos y m√°rcalos con la estrella para seguirlos</p>
                </div>
                
                <div id="favoritos-grid" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
        </div>
        
        <!-- Buscador -->
        <div class="bg-gray-800 rounded-xl border border-gray-700 p-6 mb-6">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üîç</span> Buscar Activo
            </h2>
            <p class="text-gray-400 text-sm mb-4">
                Busca cualquier acci√≥n, ETF o fondo por nombre, ticker o ISIN para analizarlo sin a√±adirlo a tu cartera
            </p>
            
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <input type="text" id="search-input" 
                        placeholder="Ej: AAPL, Nestl√©, IE00B4L5Y983, Bitcoin..."
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-lg focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none transition"
                        onkeypress="if(event.key === 'Enter') buscarActivo()">
                </div>
                <button onclick="buscarActivo()" 
                    class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Analizar
                </button>
            </div>
            
            <!-- Ejemplos r√°pidos -->
            <div class="mt-4 flex flex-wrap gap-2">
                <span class="text-xs text-gray-500">Ejemplos:</span>
                <button onclick="buscarRapido('AAPL')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded transition">Apple (AAPL)</button>
                <button onclick="buscarRapido('MSFT')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded transition">Microsoft (MSFT)</button>
                <button onclick="buscarRapido('NESN.SW')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded transition">Nestl√©</button>
                <button onclick="buscarRapido('IBE.MC')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded transition">Iberdrola</button>
                <button onclick="buscarRapido('BTC-USD')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded transition">Bitcoin</button>
                <button onclick="buscarRapido('GC=F')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded transition">Oro</button>
                <button onclick="buscarRapido('IE00B4L5Y983')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded transition">iShares MSCI World</button>
            </div>
        </div>

        <!-- Resultado del an√°lisis -->
        <div id="resultado-container" class="hidden">
            <!-- Info b√°sica del activo -->
            <div class="bg-gray-800 rounded-xl border border-gray-700 p-6 mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h2 id="activo-nombre" class="text-2xl font-bold">-</h2>
                        <p id="activo-ticker" class="text-gray-400">-</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="btn-favorito" onclick="toggleFavorito()" class="p-2 rounded-lg border border-gray-600 hover:bg-gray-700 transition" title="A√±adir a favoritos">
                            <svg id="icon-favorito" class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                            </svg>
                        </button>
                        <div class="text-right">
                            <div id="activo-precio" class="text-3xl font-bold">-</div>
                            <div id="activo-cambio" class="text-sm">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Estad√≠sticas clave -->
                <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-4 mt-6" id="stats-grid">
                    <div class="p-3 bg-gray-700/30 rounded-lg text-center">
                        <span class="text-gray-400 text-xs">M√°x 52 sem</span>
                        <div class="font-medium" id="stat-high52">-</div>
                    </div>
                    <div class="p-3 bg-gray-700/30 rounded-lg text-center">
                        <span class="text-gray-400 text-xs">M√≠n 52 sem</span>
                        <div class="font-medium" id="stat-low52">-</div>
                    </div>
                    <div class="p-3 bg-gray-700/30 rounded-lg text-center">
                        <span class="text-gray-400 text-xs">Media 50d</span>
                        <div class="font-medium" id="stat-avg50">-</div>
                    </div>
                    <div class="p-3 bg-gray-700/30 rounded-lg text-center">
                        <span class="text-gray-400 text-xs">Media 200d</span>
                        <div class="font-medium" id="stat-avg200">-</div>
                    </div>
                    <div class="p-3 bg-gray-700/30 rounded-lg text-center">
                        <span class="text-gray-400 text-xs">Volumen</span>
                        <div class="font-medium" id="stat-volume">-</div>
                    </div>
                    <div class="p-3 bg-gray-700/30 rounded-lg text-center">
                        <span class="text-gray-400 text-xs">Cap. Mercado</span>
                        <div class="font-medium" id="stat-marketcap">-</div>
                    </div>
                    <div class="p-3 bg-gray-700/30 rounded-lg text-center">
                        <span class="text-gray-400 text-xs">PER</span>
                        <div class="font-medium" id="stat-per">-</div>
                    </div>
                    <div class="p-3 bg-gray-700/30 rounded-lg text-center">
                        <span class="text-gray-400 text-xs">Dividendo</span>
                        <div class="font-medium" id="stat-dividend">-</div>
                    </div>
                </div>
                
                <!-- Botones de acci√≥n -->
                <div class="mt-6 flex flex-wrap justify-center gap-4">
                    <button onclick="anadirACartera()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        A√±adir a mi Cartera
                    </button>
                    <button onclick="mostrarModalAlerta()" class="px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                        Crear Alerta de Precio
                    </button>
                </div>
            </div>

            <!-- Gr√°fico y an√°lisis t√©cnico -->
            <div class="bg-gray-800 rounded-xl border border-gray-700 p-6 mb-6">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                    <div class="flex items-center gap-4">
                        <h3 class="text-lg font-semibold flex items-center gap-2">
                            <span>üìà</span> Hist√≥rico de Precios
                        </h3>
                        <!-- Indicador de rentabilidad del per√≠odo -->
                        <div id="period-return" class="hidden px-3 py-1 rounded-lg text-sm font-semibold">
                            <span id="period-return-value">+0.00%</span>
                            <span id="period-return-label" class="text-xs text-gray-400 ml-1">(1A)</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadChart('1mo')" class="period-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600 transition" data-period="1mo">1M</button>
                        <button onclick="loadChart('3mo')" class="period-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600 transition" data-period="3mo">3M</button>
                        <button onclick="loadChart('6mo')" class="period-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600 transition" data-period="6mo">6M</button>
                        <button onclick="loadChart('1y')" class="period-btn px-3 py-1 rounded text-sm bg-blue-600 transition" data-period="1y">1A</button>
                        <button onclick="loadChart('5y')" class="period-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600 transition" data-period="5y">5A</button>
                        <button onclick="loadChart('10y')" class="period-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600 transition" data-period="10y">10A</button>
                        <button onclick="loadChart('max')" class="period-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600 transition" data-period="max">M√°x</button>
                    </div>
                </div>
                
                <!-- Controles de indicadores -->
                <div class="flex flex-wrap items-center gap-4 mb-4 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-gray-400">üìä Medias:</span>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="sma-20" class="sma-toggle rounded" data-period="20" data-color="#eab308">
                            <span class="text-xs text-yellow-400">SMA20</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="sma-50" class="sma-toggle rounded" data-period="50" data-color="#3b82f6">
                            <span class="text-xs text-blue-400">SMA50</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="sma-200" class="sma-toggle rounded" data-period="200" data-color="#a855f7">
                            <span class="text-xs text-purple-400">SMA200</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="bollinger-toggle" class="rounded">
                            <span class="text-xs text-pink-400">BB</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="rsi-toggle" class="rounded">
                            <span class="text-xs text-cyan-400">RSI</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer" title="MACD (12,26,9) - Cruces indican cambio de tendencia">
                            <input type="checkbox" id="macd-toggle" class="rounded">
                            <span class="text-xs text-orange-400">MACD</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer" title="Volumen de operaciones">
                            <input type="checkbox" id="volume-toggle" class="rounded">
                            <span class="text-xs text-emerald-400">Vol</span>
                        </label>
                    </div>
                    
                    <div class="w-px h-6 bg-gray-600"></div>
                    
                    <button onclick="toggleSoportesResistencias()" class="px-2 py-1 bg-blue-600/50 hover:bg-blue-600 text-blue-200 rounded text-xs transition">
                        üìè S/R
                    </button>
                    <button onclick="toggleCorrelacion()" class="px-2 py-1 bg-green-600/50 hover:bg-green-600 text-green-200 rounded text-xs transition">
                        üîó Correlaci√≥n
                    </button>
                    <button onclick="toggleDCASimulator()" class="px-2 py-1 bg-purple-600/50 hover:bg-purple-600 text-purple-200 rounded text-xs transition">
                        üí∞ DCA
                    </button>
                </div>
                
                <!-- Gr√°fico -->
                <div class="h-80 relative">
                    <div id="chart-loader" class="absolute inset-0 flex items-center justify-center bg-gray-800">
                        <div class="loader"></div>
                    </div>
                    <canvas id="price-chart"></canvas>
                </div>
                
                <!-- Gr√°fico RSI -->
                <div id="rsi-container" class="hidden mt-4">
                    <div class="h-32 relative bg-gray-900/50 rounded-lg p-2">
                        <canvas id="rsi-chart"></canvas>
                    </div>
                    <div class="flex items-center justify-between mt-1 text-xs text-gray-500">
                        <span>RSI (14 d√≠as)</span>
                        <div class="flex gap-4">
                            <span class="text-red-400">Sobrecompra &gt;70</span>
                            <span class="text-green-400">Sobreventa &lt;30</span>
                        </div>
                    </div>
                </div>
                
                <!-- Gr√°fico MACD -->
                <div id="macd-container" class="hidden mt-4">
                    <div class="h-40 relative bg-gray-900/50 rounded-lg p-2">
                        <canvas id="macd-chart"></canvas>
                    </div>
                    <div class="flex items-center justify-between mt-1 text-xs text-gray-500">
                        <span>MACD (12, 26, 9)</span>
                        <div class="flex gap-4">
                            <span class="text-blue-400">‚óè MACD</span>
                            <span class="text-orange-400">‚óè Signal</span>
                            <span class="text-gray-400">‚ñà Histograma</span>
                        </div>
                    </div>
                    
                    <!-- Panel de An√°lisis MACD -->
                    <div id="macd-analysis" class="mt-3 bg-gray-900/70 rounded-lg p-4 border border-gray-700">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-orange-400">üìä</span>
                            <span class="font-semibold text-white">An√°lisis MACD</span>
                        </div>
                        <div id="macd-analysis-content" class="space-y-2 text-sm">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Gr√°fico Volumen -->
                <div id="volume-container" class="hidden mt-4">
                    <div class="h-32 relative bg-gray-900/50 rounded-lg p-2">
                        <canvas id="volume-chart"></canvas>
                    </div>
                    <div class="flex items-center justify-between mt-1 text-xs text-gray-500">
                        <span>Volumen de operaciones</span>
                        <div class="flex gap-4">
                            <span class="text-emerald-400">‚ñà Subida</span>
                            <span class="text-red-400">‚ñà Bajada</span>
                            <span class="text-gray-400">‚Äï Media 20d</span>
                        </div>
                    </div>
                    
                    <!-- Panel de An√°lisis Volumen -->
                    <div id="volume-analysis" class="mt-3 bg-gray-900/70 rounded-lg p-4 border border-gray-700">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-emerald-400">üìà</span>
                            <span class="font-semibold text-white">An√°lisis de Volumen</span>
                        </div>
                        <div id="volume-analysis-content" class="space-y-2 text-sm">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Zona de Alertas -->
                <div id="alerts-container" class="mt-3 space-y-2"></div>
                
                <!-- Indicadores r√°pidos -->
                <div id="quick-indicators" class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <div class="p-3 bg-gray-700/30 rounded-lg text-center">
                        <div class="text-xs text-gray-400 mb-1">üìä RSI Actual</div>
                        <div class="text-xl font-bold" id="rsi-value">-</div>
                        <div class="text-xs mt-1" id="rsi-signal">-</div>
                    </div>
                    <div class="p-3 bg-gray-700/30 rounded-lg text-center">
                        <div class="text-xs text-gray-400 mb-1">üî• Racha Actual</div>
                        <div class="text-xl font-bold" id="streak-value">-</div>
                        <div class="text-xs mt-1" id="streak-detail">-</div>
                    </div>
                    <div class="p-3 bg-gray-700/30 rounded-lg text-center">
                        <div class="text-xs text-gray-400 mb-1">üìà Beta vs S&P500</div>
                        <div class="text-xl font-bold" id="beta-value">-</div>
                        <div class="text-xs mt-1" id="beta-signal">-</div>
                    </div>
                    <div class="p-3 bg-gray-700/30 rounded-lg text-center">
                        <div class="text-xs text-gray-400 mb-1">üìâ Volatilidad</div>
                        <div class="text-xl font-bold" id="volatility-value">-</div>
                        <div class="text-xs mt-1" id="volatility-signal">-</div>
                    </div>
                </div>
                
                <!-- Panel DCA -->
                <div id="dca-simulator" class="hidden mt-4 p-4 bg-purple-900/20 border border-purple-700/50 rounded-lg">
                    <h4 class="text-sm font-semibold text-purple-400 mb-3">üí∞ Simulador DCA</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label class="text-xs text-gray-400">Aportaci√≥n mensual</label>
                            <div class="flex items-center gap-1 mt-1">
                                <input type="number" id="dca-amount" value="100" min="10" max="10000" step="10"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                                <span class="text-gray-400">‚Ç¨</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Desde hace</label>
                            <select id="dca-period" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                                <option value="1y">1 a√±o</option>
                                <option value="2y">2 a√±os</option>
                                <option value="3y">3 a√±os</option>
                                <option value="5y" selected>5 a√±os</option>
                                <option value="10y">10 a√±os</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="calcularDCA()" class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm transition">
                                Calcular
                            </button>
                        </div>
                    </div>
                    <div id="dca-results" class="hidden mt-4">
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <div class="p-3 bg-gray-800/50 rounded-lg text-center">
                                <div class="text-xs text-gray-400">Total invertido</div>
                                <div class="text-lg font-bold text-white" id="dca-invested">0‚Ç¨</div>
                            </div>
                            <div class="p-3 bg-gray-800/50 rounded-lg text-center">
                                <div class="text-xs text-gray-400">Valor actual</div>
                                <div class="text-lg font-bold text-green-400" id="dca-current">0‚Ç¨</div>
                            </div>
                            <div class="p-3 bg-gray-800/50 rounded-lg text-center">
                                <div class="text-xs text-gray-400">Beneficio</div>
                                <div class="text-lg font-bold" id="dca-profit">0‚Ç¨</div>
                            </div>
                            <div class="p-3 bg-gray-800/50 rounded-lg text-center">
                                <div class="text-xs text-gray-400">Rentabilidad</div>
                                <div class="text-lg font-bold" id="dca-return">0%</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 text-center mt-3" id="dca-summary"></div>
                    </div>
                </div>
                
                <!-- Panel S/R -->
                <div id="sr-panel" class="hidden mt-4 p-4 bg-blue-900/20 border border-blue-700/50 rounded-lg">
                    <h4 class="text-sm font-semibold text-blue-400 mb-3 flex items-center gap-2">
                        üìè Soportes y Resistencias
                    </h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs text-green-400 mb-2 font-medium">üõ°Ô∏è Soportes</div>
                            <div id="soportes-list" class="space-y-1"></div>
                        </div>
                        <div>
                            <div class="text-xs text-red-400 mb-2 font-medium">üöß Resistencias</div>
                            <div id="resistencias-list" class="space-y-1"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Panel Correlaci√≥n -->
                <div id="correlacion-panel" class="hidden mt-4 p-4 bg-green-900/20 border border-green-700/50 rounded-lg">
                    <h4 class="text-sm font-semibold text-green-400 mb-3 flex items-center gap-2">
                        üîó Correlaci√≥n con tu Cartera
                    </h4>
                    <div id="correlacion-content">
                        <div id="correlacion-loading" class="text-center py-4 text-gray-400">
                            Calculando correlaciones...
                        </div>
                        <div id="correlacion-results" class="hidden">
                            <div id="correlacion-list" class="space-y-2"></div>
                            <div class="mt-3 p-2 bg-gray-800/50 rounded text-xs text-gray-400">
                                <strong>Interpretaci√≥n:</strong> 
                                <span class="text-green-400">+1</span> = se mueven igual, 
                                <span class="text-gray-400">0</span> = sin relaci√≥n, 
                                <span class="text-red-400">-1</span> = se mueven opuesto.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Heatmap y rentabilidad por a√±o -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-gray-800 rounded-xl border border-gray-700 p-6">
                    <h3 class="text-lg font-semibold mb-4">üìÖ Rentabilidad por A√±o</h3>
                    <div id="yearly-returns"></div>
                </div>
                <div class="bg-gray-800 rounded-xl border border-gray-700 p-6">
                    <h3 class="text-lg font-semibold mb-4">üóìÔ∏è Heatmap Mensual</h3>
                    <div id="monthly-heatmap" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>

        <!-- Estado inicial -->
        <div id="estado-inicial" class="text-center py-20">
            <div class="text-6xl mb-4">üîç</div>
            <h2 class="text-2xl font-bold mb-2">Explora cualquier activo</h2>
            <p class="text-gray-400 mb-6">Analiza acciones, ETFs, fondos y criptomonedas antes de invertir</p>
            <div class="flex flex-wrap justify-center gap-3">
                <button onclick="buscarRapido('AAPL')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">Apple</button>
                <button onclick="buscarRapido('GOOGL')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">Google</button>
                <button onclick="buscarRapido('AMZN')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">Amazon</button>
                <button onclick="buscarRapido('TSLA')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">Tesla</button>
                <button onclick="buscarRapido('BTC-USD')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">Bitcoin</button>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden text-center py-20">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-400">Buscando activo...</p>
        </div>

        <!-- Error -->
        <div id="error" class="hidden text-center py-20">
            <div class="text-6xl mb-4">üòï</div>
            <h2 class="text-2xl font-bold mb-2">No se encontr√≥ el activo</h2>
            <p class="text-gray-400 mb-6" id="error-message">Intenta con otro ticker o ISIN</p>
        </div>
    </main>

    <script>
        let priceChart = null;
        let rsiChart = null;
        let activoActual = null;
        
        function buscarRapido(ticker) {
            document.getElementById('search-input').value = ticker;
            buscarActivo();
        }
        
        async function buscarActivo() {
            const input = document.getElementById('search-input').value.trim();
            if (!input) return;
            
            // Mostrar loading
            document.getElementById('estado-inicial').classList.add('hidden');
            document.getElementById('resultado-container').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                // Determinar si es ISIN o ticker
                const esISIN = /^[A-Z]{2}[A-Z0-9]{9}[0-9]$/.test(input.toUpperCase());
                let ticker = input;
                let isin = '';
                
                if (esISIN) {
                    isin = input.toUpperCase();
                    // Buscar ticker para el ISIN
                    const searchResponse = await fetch(`/api/ticker/search/${isin}`);
                    const searchResult = await searchResponse.json();
                    if (searchResult.success && searchResult.ticker) {
                        ticker = searchResult.ticker;
                    }
                }
                
                // Obtener datos del activo
                const response = await fetch(`/api/historical/${encodeURIComponent(ticker)}?periodo=1y&isin=${encodeURIComponent(isin)}`);
                const result = await response.json();
                
                if (!result.success || !result.data.precios || result.data.precios.length === 0) {
                    throw new Error('No se encontraron datos para este activo');
                }
                
                // Guardar datos del activo
                activoActual = {
                    ticker: ticker,
                    isin: isin,
                    nombre: result.data.nombre || ticker,
                    precios: result.data.precios,
                    fechas: result.data.fechas,
                    volumen: result.data.volumen || null
                };
                
                // Mostrar resultado
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('resultado-container').classList.remove('hidden');
                
                // Actualizar info b√°sica
                document.getElementById('activo-nombre').textContent = activoActual.nombre;
                document.getElementById('activo-ticker').textContent = `${ticker}${isin ? ' ‚Ä¢ ' + isin : ''}`;
                
                const precioActual = result.data.precios[result.data.precios.length - 1];
                // Usar cambio_diario del backend si est√° disponible (m√°s preciso)
                let cambio;
                if (result.data.cambio_diario !== null && result.data.cambio_diario !== undefined) {
                    cambio = result.data.cambio_diario;
                } else {
                    // Fallback: calcular desde hist√≥rico
                    const precioAnterior = result.data.precios[result.data.precios.length - 2] || precioActual;
                    cambio = ((precioActual - precioAnterior) / precioAnterior) * 100;
                }
                
                const mensajeCierre = result.data.mensaje_cierre || '';
                
                document.getElementById('activo-precio').textContent = precioActual.toFixed(2) + '‚Ç¨';
                document.getElementById('activo-cambio').innerHTML = `
                    <span class="${cambio >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${cambio >= 0 ? '+' : ''}${cambio.toFixed(2)}%
                    </span>
                    <span class="text-gray-500 text-xs ml-1">${mensajeCierre || 'hoy'}</span>
                `;
                
                // Cargar gr√°fico primero (para tener datos para estad√≠sticas)
                await loadChart('1y');
                
                // Luego cargar estad√≠sticas (con fallback a datos del gr√°fico)
                cargarEstadisticas(ticker);
                
                // Verificar si est√° en favoritos
                verificarFavorito();
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('error-message').textContent = error.message;
            }
        }
        
        async function cargarEstadisticas(ticker) {
            try {
                const response = await fetch(`/api/stats/${encodeURIComponent(ticker)}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    document.getElementById('stat-high52').textContent = data.high52w ? data.high52w.toFixed(2) + '‚Ç¨' : '-';
                    document.getElementById('stat-low52').textContent = data.low52w ? data.low52w.toFixed(2) + '‚Ç¨' : '-';
                    document.getElementById('stat-avg50').textContent = data.avg50d ? data.avg50d.toFixed(2) + '‚Ç¨' : '-';
                    document.getElementById('stat-avg200').textContent = data.avg200d ? data.avg200d.toFixed(2) + '‚Ç¨' : '-';
                    document.getElementById('stat-volume').textContent = data.volume ? formatNumber(data.volume) : '-';
                    document.getElementById('stat-marketcap').textContent = data.marketCap ? formatNumber(data.marketCap) : '-';
                    document.getElementById('stat-per').textContent = data.per ? data.per.toFixed(2) : '-';
                    document.getElementById('stat-dividend').textContent = data.dividendYield ? data.dividendYield.toFixed(2) + '%' : '-';
                    return; // Datos cargados correctamente
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas desde API:', error);
            }
            
            // Fallback: calcular desde datos hist√≥ricos
            calcularEstadisticasDesdeHistorico();
        }
        
        function calcularEstadisticasDesdeHistorico() {
            if (!window.chartData || !window.chartData.precios || window.chartData.precios.length < 50) {
                return;
            }
            
            const precios = window.chartData.precios;
            const n = precios.length;
            
            // √öltimos 252 d√≠as de trading ~ 1 a√±o
            const diasAnio = Math.min(252, n);
            const preciosAnio = precios.slice(-diasAnio);
            
            // M√°x y M√≠n 52 semanas
            const high52w = Math.max(...preciosAnio);
            const low52w = Math.min(...preciosAnio);
            
            // Media 50 d√≠as
            const precios50 = precios.slice(-50);
            const avg50d = precios50.reduce((a, b) => a + b, 0) / precios50.length;
            
            // Media 200 d√≠as
            let avg200d = null;
            if (n >= 200) {
                const precios200 = precios.slice(-200);
                avg200d = precios200.reduce((a, b) => a + b, 0) / precios200.length;
            }
            
            // Actualizar UI
            document.getElementById('stat-high52').textContent = high52w.toFixed(2) + '‚Ç¨';
            document.getElementById('stat-low52').textContent = low52w.toFixed(2) + '‚Ç¨';
            document.getElementById('stat-avg50').textContent = avg50d.toFixed(2) + '‚Ç¨';
            document.getElementById('stat-avg200').textContent = avg200d ? avg200d.toFixed(2) + '‚Ç¨' : '-';
            document.getElementById('stat-volume').textContent = '-';
            document.getElementById('stat-marketcap').textContent = '-';
            document.getElementById('stat-per').textContent = '-';
            document.getElementById('stat-dividend').textContent = '-';
        }
        
        function formatNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toFixed(0);
        }
        
        async function loadChart(periodo) {
            if (!activoActual) return;
            
            // Mapeo de per√≠odo a etiqueta
            const periodLabels = {
                '1mo': '1M',
                '3mo': '3M',
                '6mo': '6M',
                '1y': '1A',
                '5y': '5A',
                '10y': '10A',
                'max': 'M√°x'
            };
            const periodLabel = periodLabels[periodo] || periodo;
            
            // Actualizar botones
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-700');
            });
            document.querySelector(`.period-btn[data-period="${periodo}"]`).classList.remove('bg-gray-700');
            document.querySelector(`.period-btn[data-period="${periodo}"]`).classList.add('bg-blue-600');
            
            document.getElementById('chart-loader').classList.remove('hidden');
            
            try {
                const response = await fetch(`/api/historical/${encodeURIComponent(activoActual.ticker)}?periodo=${periodo}&isin=${encodeURIComponent(activoActual.isin || '')}`);
                const result = await response.json();
                
                if (result.success && result.data.precios) {
                    window.chartData = {
                        precios: result.data.precios,
                        fechas: result.data.fechas,
                        volumen: result.data.volumen || null
                    };
                    
                    renderChart(result.data.fechas, result.data.precios, periodLabel);
                    ejecutarAnalisisRendimiento();
                } else {
                    // Ocultar indicador si no hay datos
                    document.getElementById('period-return')?.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error cargando gr√°fico:', error);
                document.getElementById('period-return')?.classList.add('hidden');
            }
            
            document.getElementById('chart-loader').classList.add('hidden');
            
            // Limpiar alertas previas
            document.getElementById('alerts-container').innerHTML = '';
            
            // Resetear SMAs y BB (no se activan por defecto)
            document.querySelectorAll('.sma-toggle').forEach(cb => cb.checked = false);
            document.getElementById('bollinger-toggle').checked = false;
            
            // Activar indicadores por defecto: RSI, MACD, Volumen
            document.getElementById('rsi-toggle').checked = true;
            toggleRSI(true);
            
            document.getElementById('macd-toggle').checked = true;
            toggleMACD(true);
            
            if (window.chartData && window.chartData.volumen) {
                document.getElementById('volume-toggle').checked = true;
                toggleVolume(true);
            } else {
                document.getElementById('volume-toggle').checked = false;
                document.getElementById('volume-container').classList.add('hidden');
            }
            
            // Activar S/R y Correlaci√≥n por defecto (asegurar que est√©n ocultos primero)
            setTimeout(() => {
                const srPanel = document.getElementById('sr-panel');
                const corrPanel = document.getElementById('correlacion-panel');
                
                // Si est√°n ocultos, mostrarlos
                if (srPanel && srPanel.classList.contains('hidden')) {
                    toggleSoportesResistencias();
                }
                if (corrPanel && corrPanel.classList.contains('hidden')) {
                    toggleCorrelacion();
                }
            }, 500);
        }
        
        function renderChart(fechas, precios, periodLabel = '1A') {
            const ctx = document.getElementById('price-chart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }
            
            // Calcular rentabilidad del per√≠odo
            const firstPrice = precios[0];
            const lastPrice = precios[precios.length - 1];
            const isPositive = lastPrice >= firstPrice;
            const rentabilidad = ((lastPrice - firstPrice) / firstPrice) * 100;
            
            // Mostrar indicador de rentabilidad
            const periodReturnEl = document.getElementById('period-return');
            const periodReturnValue = document.getElementById('period-return-value');
            const periodReturnLabel = document.getElementById('period-return-label');
            
            if (periodReturnEl && periodReturnValue && periodReturnLabel) {
                periodReturnEl.classList.remove('hidden', 'bg-green-900/50', 'text-green-400', 'bg-red-900/50', 'text-red-400');
                
                if (isPositive) {
                    periodReturnEl.classList.add('bg-green-900/50', 'text-green-400');
                    periodReturnValue.textContent = `+${rentabilidad.toFixed(2)}%`;
                } else {
                    periodReturnEl.classList.add('bg-red-900/50', 'text-red-400');
                    periodReturnValue.textContent = `${rentabilidad.toFixed(2)}%`;
                }
                periodReturnLabel.textContent = `(${periodLabel})`;
            }
            
            // Color de la l√≠nea seg√∫n rendimiento
            const lineColor = isPositive ? '#10b981' : '#ef4444';
            const bgColor = isPositive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: fechas,
                    datasets: [{
                        label: 'Precio',
                        data: precios,
                        borderColor: lineColor,
                        backgroundColor: bgColor,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af', maxTicksLimit: 8 }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: {
                                color: '#9ca3af',
                                callback: value => value.toFixed(2) + '‚Ç¨'
                            }
                        }
                    }
                }
            });
        }
        
        // Funciones de indicadores t√©cnicos (copiadas de details.html)
        function calcularSMA(precios, periodo) {
            const sma = [];
            for (let i = 0; i < precios.length; i++) {
                if (i < periodo - 1) {
                    sma.push(null);
                } else {
                    let sum = 0;
                    for (let j = 0; j < periodo; j++) {
                        sum += precios[i - j];
                    }
                    sma.push(sum / periodo);
                }
            }
            return sma;
        }
        
        function toggleSMA(periodo, color, enabled) {
            if (!priceChart || !window.chartData) return;
            
            const label = `SMA${periodo}`;
            priceChart.data.datasets = priceChart.data.datasets.filter(ds => ds.label !== label);
            
            if (enabled) {
                const sma = calcularSMA(window.chartData.precios, periodo);
                priceChart.data.datasets.push({
                    label: label,
                    data: sma,
                    borderColor: color,
                    borderWidth: 1.5,
                    pointRadius: 0,
                    fill: false,
                    tension: 0.1
                });
            }
            
            priceChart.update();
            detectarCruces();
        }
        
        function detectarCruces() {
            if (!window.chartData) return;
            
            const sma50Enabled = document.getElementById('sma-50').checked;
            const sma200Enabled = document.getElementById('sma-200').checked;
            
            const existing = document.getElementById('cruce-badge');
            if (existing) existing.remove();
            
            if (!sma50Enabled || !sma200Enabled) return;
            
            const sma50 = calcularSMA(window.chartData.precios, 50);
            const sma200 = calcularSMA(window.chartData.precios, 200);
            
            let ultimoCruce = null;
            for (let i = sma200.length - 1; i > 0; i--) {
                if (sma50[i] !== null && sma200[i] !== null && sma50[i-1] !== null && sma200[i-1] !== null) {
                    const cruzaArriba = sma50[i] > sma200[i] && sma50[i-1] <= sma200[i-1];
                    const cruzaAbajo = sma50[i] < sma200[i] && sma50[i-1] >= sma200[i-1];
                    
                    if (cruzaArriba) {
                        ultimoCruce = { tipo: 'dorado', fecha: window.chartData.fechas[i] };
                        break;
                    } else if (cruzaAbajo) {
                        ultimoCruce = { tipo: 'mortal', fecha: window.chartData.fechas[i] };
                        break;
                    }
                }
            }
            
            if (ultimoCruce) {
                const badge = document.createElement('div');
                badge.id = 'cruce-badge';
                
                if (ultimoCruce.tipo === 'dorado') {
                    badge.className = 'p-3 bg-yellow-900/30 border border-yellow-700/50 rounded-lg';
                    badge.innerHTML = `
                        <div class="flex items-start gap-2">
                            <span class="text-xl">‚ú®</span>
                            <div>
                                <div class="font-medium text-yellow-400">Cruce Dorado el ${ultimoCruce.fecha}</div>
                                <div class="text-xs text-yellow-200/70 mt-1">Se√±al alcista: buen momento para comprar.</div>
                            </div>
                        </div>
                    `;
                } else {
                    badge.className = 'p-3 bg-red-900/30 border border-red-700/50 rounded-lg';
                    badge.innerHTML = `
                        <div class="flex items-start gap-2">
                            <span class="text-xl">üíÄ</span>
                            <div>
                                <div class="font-medium text-red-400">Cruce Mortal el ${ultimoCruce.fecha}</div>
                                <div class="text-xs text-red-200/70 mt-1">Se√±al bajista: momento de esperar.</div>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('alerts-container').appendChild(badge);
            }
        }
        
        // Event listeners para SMAs
        document.querySelectorAll('.sma-toggle').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const periodo = parseInt(this.dataset.period);
                const color = this.dataset.color;
                toggleSMA(periodo, color, this.checked);
            });
        });
        
        // RSI
        function calcularRSI(precios, periodo = 14) {
            const rsi = [];
            for (let i = 0; i < precios.length; i++) {
                if (i < periodo) {
                    rsi.push(null);
                } else {
                    let ganancias = 0, perdidas = 0;
                    for (let j = i - periodo + 1; j <= i; j++) {
                        const cambio = precios[j] - precios[j-1];
                        if (cambio > 0) ganancias += cambio;
                        else perdidas -= cambio;
                    }
                    const avgGain = ganancias / periodo;
                    const avgLoss = perdidas / periodo;
                    const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
                    rsi.push(100 - (100 / (1 + rs)));
                }
            }
            return rsi;
        }
        
        function toggleRSI(enabled) {
            const container = document.getElementById('rsi-container');
            if (enabled) {
                container.classList.remove('hidden');
                renderRSIChart();
            } else {
                container.classList.add('hidden');
            }
        }
        
        function renderRSIChart() {
            if (!window.chartData) return;
            
            const ctx = document.getElementById('rsi-chart').getContext('2d');
            const rsi = calcularRSI(window.chartData.precios);
            
            if (rsiChart) rsiChart.destroy();
            
            rsiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: window.chartData.fechas,
                    datasets: [{
                        label: 'RSI',
                        data: rsi,
                        borderColor: '#06b6d4',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: {
                            min: 0, max: 100,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af', stepSize: 30 }
                        }
                    }
                }
            });
        }
        
        document.getElementById('rsi-toggle').addEventListener('change', function() {
            toggleRSI(this.checked);
        });
        
        // =====================
        // MACD
        // =====================
        
        let macdChart = null;
        
        function calcularEMA(precios, periodo) {
            const ema = [];
            const multiplicador = 2 / (periodo + 1);
            
            let suma = 0;
            for (let i = 0; i < periodo && i < precios.length; i++) {
                suma += precios[i];
            }
            ema.push(suma / Math.min(periodo, precios.length));
            
            for (let i = 1; i < precios.length; i++) {
                if (i < periodo) {
                    suma = 0;
                    for (let j = 0; j <= i; j++) suma += precios[j];
                    ema.push(suma / (i + 1));
                } else {
                    ema.push((precios[i] - ema[i - 1]) * multiplicador + ema[i - 1]);
                }
            }
            return ema;
        }
        
        function calcularMACD(precios, rapido = 12, lento = 26, signal = 9) {
            const ema12 = calcularEMA(precios, rapido);
            const ema26 = calcularEMA(precios, lento);
            
            const macdLine = [];
            for (let i = 0; i < precios.length; i++) {
                macdLine.push(i < lento - 1 ? null : ema12[i] - ema26[i]);
            }
            
            const macdValidos = macdLine.filter(v => v !== null);
            const signalEMA = calcularEMA(macdValidos, signal);
            
            const signalLine = [];
            let signalIndex = 0;
            for (let i = 0; i < precios.length; i++) {
                if (macdLine[i] === null) {
                    signalLine.push(null);
                } else {
                    signalLine.push(signalIndex < signal - 1 ? null : signalEMA[signalIndex]);
                    signalIndex++;
                }
            }
            
            const histograma = [];
            for (let i = 0; i < precios.length; i++) {
                histograma.push(macdLine[i] === null || signalLine[i] === null ? null : macdLine[i] - signalLine[i]);
            }
            
            return { macdLine, signalLine, histograma };
        }
        
        function toggleMACD(enabled) {
            const container = document.getElementById('macd-container');
            if (enabled && window.chartData) {
                container.classList.remove('hidden');
                renderMACDChart();
            } else {
                container.classList.add('hidden');
                if (macdChart) { macdChart.destroy(); macdChart = null; }
            }
        }
        
        function renderMACDChart() {
            if (!window.chartData) return;
            
            const { macdLine, signalLine, histograma } = calcularMACD(window.chartData.precios);
            if (macdChart) macdChart.destroy();
            
            const ctx = document.getElementById('macd-chart').getContext('2d');
            const histColores = histograma.map(v => v === null ? 'transparent' : v >= 0 ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)');
            
            macdChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: window.chartData.fechas,
                    datasets: [
                        { type: 'bar', label: 'Histograma', data: histograma, backgroundColor: histColores, borderWidth: 0, order: 2 },
                        { type: 'line', label: 'MACD', data: macdLine, borderColor: '#3b82f6', backgroundColor: 'transparent', tension: 0.1, pointRadius: 0, borderWidth: 2, order: 1 },
                        { type: 'line', label: 'Signal', data: signalLine, borderColor: '#f97316', backgroundColor: 'transparent', tension: 0.1, pointRadius: 0, borderWidth: 1.5, borderDash: [3, 3], order: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { grid: { color: '#374151' }, ticks: { color: '#9ca3af', callback: v => v.toFixed(2) } }
                    }
                }
            });
            
            analizarMACD(macdLine, signalLine, histograma);
        }
        
        function analizarMACD(macdLine, signalLine, histograma) {
            const container = document.getElementById('macd-analysis-content');
            if (!container) return;
            
            let macdActual = null, signalActual = null, histActual = null, histAnterior = null;
            for (let i = macdLine.length - 1; i >= 0; i--) {
                if (macdActual === null && macdLine[i] !== null) {
                    macdActual = macdLine[i]; signalActual = signalLine[i]; histActual = histograma[i];
                } else if (macdActual !== null && histAnterior === null && histograma[i] !== null) {
                    histAnterior = histograma[i]; break;
                }
            }
            
            if (macdActual === null) { container.innerHTML = '<p class="text-gray-400">No hay suficientes datos</p>'; return; }
            
            // Detectar √∫ltimo cruce
            let ultimoCruce = null, tipoCruce = null, diasDesdeCruce = 0;
            for (let i = macdLine.length - 1; i > 0; i--) {
                if (macdLine[i] === null || signalLine[i] === null || macdLine[i-1] === null || signalLine[i-1] === null) continue;
                const arriba = macdLine[i] > signalLine[i], arribaAntes = macdLine[i-1] > signalLine[i-1];
                if (arriba && !arribaAntes) { ultimoCruce = window.chartData.fechas[i]; tipoCruce = 'alcista'; diasDesdeCruce = macdLine.length - 1 - i; break; }
                if (!arriba && arribaAntes) { ultimoCruce = window.chartData.fechas[i]; tipoCruce = 'bajista'; diasDesdeCruce = macdLine.length - 1 - i; break; }
            }
            
            const tendencia = macdActual > signalActual ? 'alcista' : 'bajista';
            const momentumCreciendo = histActual > histAnterior;
            const sobreCero = macdActual > 0;
            
            let html = `
                <div class="flex items-start gap-2">
                    <span>${tendencia === 'alcista' ? 'üìà' : 'üìâ'}</span>
                    <div>
                        <span class="text-gray-300">Tendencia:</span>
                        <span class="${tendencia === 'alcista' ? 'text-green-400' : 'text-red-400'} font-semibold ml-1">${tendencia.toUpperCase()}</span>
                        <p class="text-gray-500 text-xs mt-1">${tendencia === 'alcista' ? 'MACD por encima de Signal ‚Üí impulso alcista' : 'MACD por debajo de Signal ‚Üí impulso bajista'}</p>
                    </div>
                </div>
            `;
            
            if (tipoCruce) {
                html += `
                    <div class="flex items-start gap-2 mt-3">
                        <span>${tipoCruce === 'alcista' ? '‚ú®' : '‚ö†Ô∏è'}</span>
                        <div>
                            <span class="text-gray-300">√öltimo cruce:</span>
                            <span class="${tipoCruce === 'alcista' ? 'text-green-400' : 'text-red-400'} font-semibold ml-1">${tipoCruce === 'alcista' ? 'DORADO' : 'MORTAL'}</span>
                            <span class="text-gray-500 ml-1">(${ultimoCruce}, hace ${diasDesdeCruce} d√≠as)</span>
                            <p class="text-gray-500 text-xs mt-1">${tipoCruce === 'alcista' ? 'Se√±al de compra' : 'Se√±al de venta'}${diasDesdeCruce <= 5 ? ' - ¬°Reciente!' : ''}</p>
                        </div>
                    </div>
                `;
            }
            
            html += `
                <div class="flex items-start gap-2 mt-3">
                    <span>${momentumCreciendo ? 'üöÄ' : 'üêå'}</span>
                    <div>
                        <span class="text-gray-300">Momentum:</span>
                        <span class="${momentumCreciendo ? 'text-green-400' : 'text-red-400'} font-semibold ml-1">${momentumCreciendo ? 'ACELERANDO' : 'DESACELERANDO'}</span>
                    </div>
                </div>
                <div class="flex items-start gap-2 mt-3">
                    <span>${sobreCero ? '‚òÄÔ∏è' : 'üåô'}</span>
                    <div>
                        <span class="text-gray-300">Zona:</span>
                        <span class="${sobreCero ? 'text-green-400' : 'text-yellow-400'} font-semibold ml-1">${sobreCero ? 'ALCISTA' : 'BAJISTA'}</span>
                    </div>
                </div>
            `;
            
            // Resumen
            let resumen, color, icon;
            if (tendencia === 'alcista' && sobreCero && momentumCreciendo) {
                resumen = 'FUERTE SE√ëAL ALCISTA'; color = 'text-green-400 bg-green-500/10 border-green-500/30'; icon = '‚úÖ';
            } else if (tendencia === 'bajista' && !sobreCero && !momentumCreciendo) {
                resumen = 'FUERTE SE√ëAL BAJISTA'; color = 'text-red-400 bg-red-500/10 border-red-500/30'; icon = 'üõë';
            } else {
                resumen = 'SE√ëALES MIXTAS'; color = 'text-yellow-400 bg-yellow-500/10 border-yellow-500/30'; icon = '‚ö†Ô∏è';
            }
            
            html += `<div class="mt-4 p-3 rounded-lg border ${color}"><span class="text-lg">${icon}</span> <span class="font-semibold">${resumen}</span></div>`;
            container.innerHTML = html;
        }
        
        document.getElementById('macd-toggle').addEventListener('change', function() {
            toggleMACD(this.checked);
        });
        
        // =====================
        // VOLUMEN
        // =====================
        
        let volumeChart = null;
        
        function toggleVolume(enabled) {
            const container = document.getElementById('volume-container');
            if (enabled && window.chartData && window.chartData.volumen) {
                container.classList.remove('hidden');
                renderVolumeChart();
            } else if (enabled) {
                alert('No hay datos de volumen disponibles para este activo');
                document.getElementById('volume-toggle').checked = false;
            } else {
                container.classList.add('hidden');
                if (volumeChart) { volumeChart.destroy(); volumeChart = null; }
            }
        }
        
        function renderVolumeChart() {
            if (!window.chartData || !window.chartData.volumen) return;
            
            const volumenes = window.chartData.volumen;
            const precios = window.chartData.precios;
            
            // Media m√≥vil 20 d√≠as
            const mediaVol = [];
            for (let i = 0; i < volumenes.length; i++) {
                if (i < 19) { mediaVol.push(null); }
                else {
                    let suma = 0;
                    for (let j = i - 19; j <= i; j++) suma += volumenes[j];
                    mediaVol.push(suma / 20);
                }
            }
            
            // Colores seg√∫n precio
            const colores = precios.map((p, i) => i === 0 || p >= precios[i-1] ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)');
            
            if (volumeChart) volumeChart.destroy();
            const ctx = document.getElementById('volume-chart').getContext('2d');
            
            volumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: window.chartData.fechas,
                    datasets: [
                        { type: 'bar', label: 'Volumen', data: volumenes, backgroundColor: colores, borderWidth: 0, order: 2 },
                        { type: 'line', label: 'Media 20d', data: mediaVol, borderColor: '#9ca3af', backgroundColor: 'transparent', tension: 0.1, pointRadius: 0, borderWidth: 1.5, borderDash: [3, 3], order: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { grid: { color: '#374151' }, ticks: { color: '#9ca3af', callback: v => v >= 1e9 ? (v/1e9).toFixed(1)+'B' : v >= 1e6 ? (v/1e6).toFixed(1)+'M' : v >= 1e3 ? (v/1e3).toFixed(1)+'K' : v } }
                    }
                }
            });
            
            analizarVolumen(volumenes, precios, mediaVol);
        }
        
        function analizarVolumen(volumenes, precios, mediaVol) {
            const container = document.getElementById('volume-analysis-content');
            if (!container) return;
            
            const volActual = volumenes[volumenes.length - 1];
            const mediaActual = mediaVol[mediaVol.length - 1];
            const precioActual = precios[precios.length - 1];
            const precioAnterior = precios[precios.length - 2];
            
            const volRelativo = mediaActual ? volActual / mediaActual : 1;
            const volAlto = volRelativo > 1;
            const precioSubio = precioActual > precioAnterior;
            
            // Tendencia volumen √∫ltimos 5 d√≠as
            const ultimos5 = volumenes.slice(-5);
            let creciendo = 0;
            for (let i = 1; i < ultimos5.length; i++) if (ultimos5[i] > ultimos5[i-1]) creciendo++;
            const tendencia = creciendo >= 3 ? 'creciente' : creciendo <= 1 ? 'decreciente' : 'estable';
            
            let html = `
                <div class="flex items-start gap-2">
                    <span>${volAlto ? 'üî•' : 'üí§'}</span>
                    <div>
                        <span class="text-gray-300">Volumen:</span>
                        <span class="${volAlto ? 'text-emerald-400' : 'text-yellow-400'} font-semibold ml-1">${volAlto ? 'ALTO' : 'BAJO'}</span>
                        <span class="text-gray-500 ml-1">(${(volRelativo * 100).toFixed(0)}% de la media)</span>
                    </div>
                </div>
                <div class="flex items-start gap-2 mt-3">
                    <span>${tendencia === 'creciente' ? 'üìà' : tendencia === 'decreciente' ? 'üìâ' : '‚û°Ô∏è'}</span>
                    <div>
                        <span class="text-gray-300">Tendencia 5d:</span>
                        <span class="font-semibold ml-1 ${tendencia === 'creciente' ? 'text-emerald-400' : tendencia === 'decreciente' ? 'text-red-400' : 'text-gray-400'}">${tendencia.toUpperCase()}</span>
                    </div>
                </div>
            `;
            
            // Se√±al
            let se√±al, se√±alIcon, se√±alColor;
            if (precioSubio && volAlto) { se√±al = 'SUBIDA CONFIRMADA'; se√±alIcon = '‚úÖ'; se√±alColor = 'text-green-400'; }
            else if (!precioSubio && volAlto) { se√±al = 'BAJADA CONFIRMADA'; se√±alIcon = 'üö®'; se√±alColor = 'text-red-400'; }
            else if (precioSubio) { se√±al = 'SUBIDA D√âBIL'; se√±alIcon = '‚ö†Ô∏è'; se√±alColor = 'text-yellow-400'; }
            else { se√±al = 'BAJADA D√âBIL'; se√±alIcon = 'üí§'; se√±alColor = 'text-gray-400'; }
            
            html += `
                <div class="flex items-start gap-2 mt-3">
                    <span>${se√±alIcon}</span>
                    <div>
                        <span class="text-gray-300">Se√±al:</span>
                        <span class="${se√±alColor} font-semibold ml-1">${se√±al}</span>
                        <p class="text-gray-500 text-xs mt-1">${precioSubio && volAlto ? 'Precio sube con volumen alto ‚Üí fiable' : !precioSubio && volAlto ? 'Precio baja con volumen alto ‚Üí precauci√≥n' : precioSubio ? 'Subida con poco volumen ‚Üí puede revertir' : 'Bajada con poco volumen ‚Üí correcci√≥n menor'}</p>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        document.getElementById('volume-toggle').addEventListener('change', function() {
            toggleVolume(this.checked);
        });
        
        // Bollinger
        function calcularBollinger(precios, periodo = 20, desviaciones = 2) {
            const sma = [], upper = [], lower = [];
            for (let i = 0; i < precios.length; i++) {
                if (i < periodo - 1) {
                    sma.push(null); upper.push(null); lower.push(null);
                } else {
                    let sum = 0;
                    for (let j = 0; j < periodo; j++) sum += precios[i - j];
                    const media = sum / periodo;
                    sma.push(media);
                    
                    let sumCuadrados = 0;
                    for (let j = 0; j < periodo; j++) sumCuadrados += Math.pow(precios[i - j] - media, 2);
                    const std = Math.sqrt(sumCuadrados / periodo);
                    
                    upper.push(media + desviaciones * std);
                    lower.push(media - desviaciones * std);
                }
            }
            return { sma, upper, lower };
        }
        
        function toggleBollinger(enabled) {
            if (!priceChart || !window.chartData) return;
            
            priceChart.data.datasets = priceChart.data.datasets.filter(ds => 
                !['BB Superior', 'BB Inferior'].includes(ds.label)
            );
            
            if (enabled) {
                const bollinger = calcularBollinger(window.chartData.precios);
                
                priceChart.data.datasets.push({
                    label: 'BB Superior',
                    data: bollinger.upper,
                    borderColor: '#ec4899',
                    borderWidth: 1,
                    borderDash: [3, 3],
                    pointRadius: 0,
                    fill: false
                });
                
                priceChart.data.datasets.push({
                    label: 'BB Inferior',
                    data: bollinger.lower,
                    borderColor: '#ec4899',
                    backgroundColor: 'rgba(236, 72, 153, 0.1)',
                    borderWidth: 1,
                    borderDash: [3, 3],
                    pointRadius: 0,
                    fill: '-1'
                });
                
                actualizarInfoBollinger();
            } else {
                const badge = document.getElementById('bollinger-badge');
                if (badge) badge.remove();
            }
            
            priceChart.update();
        }
        
        function actualizarInfoBollinger() {
            if (!window.chartData) return;
            
            const precios = window.chartData.precios;
            const bollinger = calcularBollinger(precios);
            const precioActual = precios[precios.length - 1];
            const upperActual = bollinger.upper[bollinger.upper.length - 1];
            const lowerActual = bollinger.lower[bollinger.lower.length - 1];
            
            const posicionBB = ((precioActual - lowerActual) / (upperActual - lowerActual)) * 100;
            
            let mensaje, clase;
            if (posicionBB >= 95) {
                mensaje = '‚ö†Ô∏è Tocando banda superior - Posible sobrecompra';
                clase = 'text-red-400';
            } else if (posicionBB <= 5) {
                mensaje = '‚ú® Tocando banda inferior - Posible sobreventa';
                clase = 'text-green-400';
            } else if (posicionBB >= 80) {
                mensaje = 'üìà Cerca de banda superior';
                clase = 'text-yellow-400';
            } else if (posicionBB <= 20) {
                mensaje = 'üìâ Cerca de banda inferior';
                clase = 'text-blue-400';
            } else {
                mensaje = '‚û°Ô∏è Zona neutral';
                clase = 'text-gray-400';
            }
            
            let badge = document.getElementById('bollinger-badge');
            if (!badge) {
                badge = document.createElement('div');
                badge.id = 'bollinger-badge';
                document.getElementById('alerts-container').appendChild(badge);
            }
            badge.className = `p-2 bg-pink-900/20 border border-pink-700/30 rounded text-xs ${clase}`;
            badge.innerHTML = `üéÄ <strong>Bandas Bollinger:</strong> ${mensaje} (${posicionBB.toFixed(0)}%)`;
        }
        
        document.getElementById('bollinger-toggle').addEventListener('change', function() {
            toggleBollinger(this.checked);
        });
        
        // Indicadores r√°pidos
        function ejecutarAnalisisRendimiento() {
            if (!window.chartData || !window.chartData.precios) return;
            
            const precios = window.chartData.precios;
            
            // RSI
            const rsi = calcularRSI(precios);
            const rsiActual = rsi[rsi.length - 1];
            if (rsiActual !== null) {
                document.getElementById('rsi-value').textContent = rsiActual.toFixed(1);
                const rsiSignal = document.getElementById('rsi-signal');
                if (rsiActual >= 70) {
                    document.getElementById('rsi-value').className = 'text-xl font-bold text-red-400';
                    rsiSignal.textContent = '‚ö†Ô∏è Sobrecompra';
                    rsiSignal.className = 'text-xs mt-1 text-red-400';
                } else if (rsiActual <= 30) {
                    document.getElementById('rsi-value').className = 'text-xl font-bold text-green-400';
                    rsiSignal.textContent = '‚ú® Sobreventa';
                    rsiSignal.className = 'text-xs mt-1 text-green-400';
                } else {
                    document.getElementById('rsi-value').className = 'text-xl font-bold text-cyan-400';
                    rsiSignal.textContent = 'Neutral';
                    rsiSignal.className = 'text-xs mt-1 text-gray-400';
                }
            }
            
            // Racha
            let racha = 0;
            let tipoRacha = precios[precios.length - 1] >= precios[precios.length - 2] ? 'subida' : 'bajada';
            for (let i = precios.length - 1; i > 0; i--) {
                const sube = precios[i] >= precios[i-1];
                if ((tipoRacha === 'subida' && sube) || (tipoRacha === 'bajada' && !sube)) {
                    racha++;
                } else {
                    break;
                }
            }
            document.getElementById('streak-value').textContent = racha + 'd';
            document.getElementById('streak-value').className = `text-xl font-bold ${tipoRacha === 'subida' ? 'text-green-400' : 'text-red-400'}`;
            document.getElementById('streak-detail').textContent = tipoRacha === 'subida' ? 'üìà Consecutivos subiendo' : 'üìâ Consecutivos bajando';
            
            // Volatilidad
            const retornos = [];
            for (let i = 1; i < precios.length; i++) {
                retornos.push((precios[i] - precios[i-1]) / precios[i-1]);
            }
            const mediaRetornos = retornos.reduce((a, b) => a + b, 0) / retornos.length;
            const varianza = retornos.reduce((sum, r) => sum + Math.pow(r - mediaRetornos, 2), 0) / retornos.length;
            const volatilidad = Math.sqrt(varianza) * Math.sqrt(252) * 100;
            
            document.getElementById('volatility-value').textContent = volatilidad.toFixed(1) + '%';
            if (volatilidad < 15) {
                document.getElementById('volatility-value').className = 'text-xl font-bold text-green-400';
                document.getElementById('volatility-signal').textContent = 'Baja volatilidad';
            } else if (volatilidad < 25) {
                document.getElementById('volatility-value').className = 'text-xl font-bold text-yellow-400';
                document.getElementById('volatility-signal').textContent = 'Volatilidad media';
            } else {
                document.getElementById('volatility-value').className = 'text-xl font-bold text-red-400';
                document.getElementById('volatility-signal').textContent = 'Alta volatilidad';
            }
            
            // Beta (as√≠ncrono)
            calcularBeta();
            
            // Rentabilidad por a√±o y heatmap
            calcularRentabilidadAnual();
            calcularHeatmapMensual();
        }
        
        async function calcularBeta() {
            try {
                const response = await fetch('/api/historical/%5EGSPC?periodo=1y');
                const result = await response.json();
                
                if (result.success && result.data.precios && window.chartData) {
                    const retornosActivo = [];
                    const retornosSP = [];
                    
                    const preciosActivo = window.chartData.precios;
                    const preciosSP = result.data.precios;
                    const n = Math.min(preciosActivo.length, preciosSP.length);
                    
                    for (let i = 1; i < n; i++) {
                        retornosActivo.push((preciosActivo[i] - preciosActivo[i-1]) / preciosActivo[i-1]);
                        retornosSP.push((preciosSP[i] - preciosSP[i-1]) / preciosSP[i-1]);
                    }
                    
                    // Calcular covarianza y varianza
                    const mediaActivo = retornosActivo.reduce((a, b) => a + b, 0) / retornosActivo.length;
                    const mediaSP = retornosSP.reduce((a, b) => a + b, 0) / retornosSP.length;
                    
                    let covarianza = 0, varianzaSP = 0;
                    for (let i = 0; i < retornosActivo.length; i++) {
                        covarianza += (retornosActivo[i] - mediaActivo) * (retornosSP[i] - mediaSP);
                        varianzaSP += Math.pow(retornosSP[i] - mediaSP, 2);
                    }
                    
                    const beta = varianzaSP === 0 ? 0 : covarianza / varianzaSP;
                    
                    document.getElementById('beta-value').textContent = beta.toFixed(2);
                    if (beta < 0.8) {
                        document.getElementById('beta-value').className = 'text-xl font-bold text-green-400';
                        document.getElementById('beta-signal').textContent = 'Defensivo';
                    } else if (beta <= 1.2) {
                        document.getElementById('beta-value').className = 'text-xl font-bold text-blue-400';
                        document.getElementById('beta-signal').textContent = 'Similar al mercado';
                    } else {
                        document.getElementById('beta-value').className = 'text-xl font-bold text-red-400';
                        document.getElementById('beta-signal').textContent = 'Agresivo';
                    }
                }
            } catch (error) {
                console.error('Error calculando beta:', error);
            }
        }
        
        function calcularRentabilidadAnual() {
            if (!window.chartData) return;
            
            const precios = window.chartData.precios;
            const fechas = window.chartData.fechas;
            
            const porAnio = {};
            fechas.forEach((fecha, i) => {
                const anio = fecha.substring(0, 4);
                if (!porAnio[anio]) porAnio[anio] = { primero: precios[i], ultimo: precios[i] };
                porAnio[anio].ultimo = precios[i];
            });
            
            const container = document.getElementById('yearly-returns');
            let html = '';
            
            const anios = Object.keys(porAnio).sort();
            const rentabilidades = anios.map(anio => {
                return ((porAnio[anio].ultimo - porAnio[anio].primero) / porAnio[anio].primero) * 100;
            });
            const maxAbs = Math.max(...rentabilidades.map(Math.abs), 1);
            
            anios.forEach((anio, i) => {
                const rent = rentabilidades[i];
                const width = (Math.abs(rent) / maxAbs) * 100;
                const color = rent >= 0 ? 'bg-green-500' : 'bg-red-500';
                const textColor = rent >= 0 ? 'text-green-400' : 'text-red-400';
                
                html += `
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-12 text-sm text-gray-400">${anio}</span>
                        <div class="flex-1 h-6 bg-gray-700 rounded overflow-hidden">
                            <div class="${color} h-full rounded" style="width: ${width}%"></div>
                        </div>
                        <span class="w-16 text-right text-sm ${textColor}">${rent >= 0 ? '+' : ''}${rent.toFixed(1)}%</span>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-gray-500">No hay datos suficientes</p>';
        }
        
        function calcularHeatmapMensual() {
            if (!window.chartData) return;
            
            const precios = window.chartData.precios;
            const fechas = window.chartData.fechas;
            
            const porMes = {};
            fechas.forEach((fecha, i) => {
                const key = fecha.substring(0, 7); // YYYY-MM
                if (!porMes[key]) porMes[key] = { primero: precios[i], ultimo: precios[i] };
                porMes[key].ultimo = precios[i];
            });
            
            // Agrupar por a√±o
            const porAnio = {};
            Object.keys(porMes).forEach(key => {
                const [anio, mes] = key.split('-');
                if (!porAnio[anio]) porAnio[anio] = {};
                const rent = ((porMes[key].ultimo - porMes[key].primero) / porMes[key].primero) * 100;
                porAnio[anio][parseInt(mes)] = rent;
            });
            
            const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const anios = Object.keys(porAnio).sort();
            
            let html = '<table class="w-full text-xs"><thead><tr><th></th>';
            meses.forEach(m => html += `<th class="p-1 text-gray-400">${m}</th>`);
            html += '<th class="p-1 text-gray-400">Total</th></tr></thead><tbody>';
            
            anios.forEach(anio => {
                html += `<tr><td class="p-1 text-gray-400">${anio}</td>`;
                let totalAnio = 0, mesesConDatos = 0;
                
                for (let m = 1; m <= 12; m++) {
                    const rent = porAnio[anio][m];
                    if (rent !== undefined) {
                        totalAnio += rent;
                        mesesConDatos++;
                        const color = getHeatmapColor(rent);
                        html += `<td class="p-1"><div class="${color} rounded p-1 text-center">${rent >= 0 ? '+' : ''}${rent.toFixed(1)}</div></td>`;
                    } else {
                        html += '<td class="p-1"><div class="bg-gray-700 rounded p-1 text-center text-gray-500">-</div></td>';
                    }
                }
                
                const colorTotal = getHeatmapColor(totalAnio);
                html += `<td class="p-1"><div class="${colorTotal} rounded p-1 text-center font-medium">${totalAnio >= 0 ? '+' : ''}${totalAnio.toFixed(1)}</div></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            document.getElementById('monthly-heatmap').innerHTML = html;
        }
        
        function getHeatmapColor(valor) {
            if (valor <= -5) return 'bg-red-600 text-white';
            if (valor < 0) return 'bg-red-400/50 text-red-200';
            if (valor === 0) return 'bg-gray-600 text-gray-300';
            if (valor <= 5) return 'bg-green-400/50 text-green-200';
            return 'bg-green-600 text-white';
        }
        
        // DCA Simulator
        function toggleDCASimulator() {
            document.getElementById('dca-simulator').classList.toggle('hidden');
        }
        
        function calcularDCA() {
            if (!window.chartData) return;
            
            const aportacion = parseFloat(document.getElementById('dca-amount').value) || 100;
            const periodoSelect = document.getElementById('dca-period').value;
            const mesesMap = { '1y': 12, '2y': 24, '3y': 36, '5y': 60, '10y': 120 };
            const mesesSimular = mesesMap[periodoSelect] || 60;
            
            const precios = window.chartData.precios;
            const diasTotales = precios.length;
            const mesesDisponibles = Math.floor(diasTotales / 21);
            const mesesUsar = Math.min(mesesSimular, mesesDisponibles);
            
            if (mesesUsar < 2) {
                alert('No hay suficientes datos hist√≥ricos');
                return;
            }
            
            let totalInvertido = 0;
            let totalUnidades = 0;
            const intervalo = Math.floor(diasTotales / mesesUsar);
            
            for (let i = 0; i < mesesUsar; i++) {
                const idx = diasTotales - 1 - (i * intervalo);
                if (idx >= 0) {
                    const precio = precios[idx];
                    const unidades = aportacion / precio;
                    totalUnidades += unidades;
                    totalInvertido += aportacion;
                }
            }
            
            const precioActual = precios[precios.length - 1];
            const valorActual = totalUnidades * precioActual;
            const beneficio = valorActual - totalInvertido;
            const rentabilidad = ((valorActual - totalInvertido) / totalInvertido) * 100;
            const precioMedio = totalInvertido / totalUnidades;
            
            document.getElementById('dca-invested').textContent = totalInvertido.toFixed(0) + '‚Ç¨';
            document.getElementById('dca-current').textContent = valorActual.toFixed(0) + '‚Ç¨';
            document.getElementById('dca-profit').textContent = (beneficio >= 0 ? '+' : '') + beneficio.toFixed(0) + '‚Ç¨';
            document.getElementById('dca-profit').className = `text-lg font-bold ${beneficio >= 0 ? 'text-green-400' : 'text-red-400'}`;
            document.getElementById('dca-return').textContent = (rentabilidad >= 0 ? '+' : '') + rentabilidad.toFixed(1) + '%';
            document.getElementById('dca-return').className = `text-lg font-bold ${rentabilidad >= 0 ? 'text-green-400' : 'text-red-400'}`;
            document.getElementById('dca-summary').textContent = `Invirtiendo ${aportacion}‚Ç¨/mes durante ${mesesUsar} meses. Precio medio: ${precioMedio.toFixed(2)}‚Ç¨. Precio actual: ${precioActual.toFixed(2)}‚Ç¨`;
            
            document.getElementById('dca-results').classList.remove('hidden');
        }
        
        // Soportes y Resistencias
        function toggleSoportesResistencias() {
            const panel = document.getElementById('sr-panel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                calcularSoportesResistencias();
            }
        }
        
        function calcularSoportesResistencias() {
            if (!window.chartData) return;
            
            const precios = window.chartData.precios;
            const precioActual = precios[precios.length - 1];
            const ventana = Math.max(5, Math.floor(precios.length / 20));
            
            const pivotes = [];
            for (let i = ventana; i < precios.length - ventana; i++) {
                let esMinimo = true, esMaximo = true;
                for (let j = i - ventana; j <= i + ventana; j++) {
                    if (j !== i) {
                        if (precios[j] <= precios[i]) esMinimo = false;
                        if (precios[j] >= precios[i]) esMaximo = false;
                    }
                }
                if (esMinimo) pivotes.push({ tipo: 'soporte', precio: precios[i] });
                if (esMaximo) pivotes.push({ tipo: 'resistencia', precio: precios[i] });
            }
            
            // Agrupar niveles cercanos
            const tolerancia = precioActual * 0.02;
            const niveles = [];
            pivotes.forEach(p => {
                const existente = niveles.find(n => n.tipo === p.tipo && Math.abs(n.precio - p.precio) < tolerancia);
                if (existente) {
                    existente.toques++;
                    existente.precio = (existente.precio + p.precio) / 2;
                } else {
                    niveles.push({ ...p, toques: 1 });
                }
            });
            
            const soportes = niveles.filter(n => n.tipo === 'soporte' && n.precio < precioActual).sort((a, b) => b.precio - a.precio).slice(0, 3);
            const resistencias = niveles.filter(n => n.tipo === 'resistencia' && n.precio > precioActual).sort((a, b) => a.precio - b.precio).slice(0, 3);
            
            // Mostrar
            const soportesList = document.getElementById('soportes-list');
            const resistenciasList = document.getElementById('resistencias-list');
            
            soportesList.innerHTML = soportes.length === 0 ? '<div class="text-gray-500 text-xs">No detectados</div>' :
                soportes.map(s => {
                    const dist = ((s.precio - precioActual) / precioActual * 100).toFixed(1);
                    const fuerza = s.toques >= 3 ? 'üü¢üü¢üü¢' : s.toques >= 2 ? 'üü¢üü¢' : 'üü¢';
                    return `<div class="flex justify-between p-2 bg-green-900/20 rounded text-xs"><span class="text-green-400">${s.precio.toFixed(2)}‚Ç¨</span><span class="text-gray-400">${dist}%</span><span>${fuerza}</span></div>`;
                }).join('');
            
            resistenciasList.innerHTML = resistencias.length === 0 ? '<div class="text-gray-500 text-xs">No detectadas</div>' :
                resistencias.map(r => {
                    const dist = ((r.precio - precioActual) / precioActual * 100).toFixed(1);
                    const fuerza = r.toques >= 3 ? 'üî¥üî¥üî¥' : r.toques >= 2 ? 'üî¥üî¥' : 'üî¥';
                    return `<div class="flex justify-between p-2 bg-red-900/20 rounded text-xs"><span class="text-red-400">${r.precio.toFixed(2)}‚Ç¨</span><span class="text-gray-400">+${dist}%</span><span>${fuerza}</span></div>`;
                }).join('');
        }
        
        // Correlaci√≥n con cartera
        function toggleCorrelacion() {
            const panel = document.getElementById('correlacion-panel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                calcularCorrelaciones();
            }
        }
        
        async function calcularCorrelaciones() {
            document.getElementById('correlacion-loading').classList.remove('hidden');
            document.getElementById('correlacion-results').classList.add('hidden');
            
            if (!window.chartData) {
                document.getElementById('correlacion-loading').textContent = 'No hay datos del gr√°fico';
                return;
            }
            
            try {
                const portfolioResponse = await fetch('/api/portfolio');
                const portfolioResult = await portfolioResponse.json();
                
                if (!portfolioResult.success || !portfolioResult.data.posiciones || portfolioResult.data.posiciones.length === 0) {
                    document.getElementById('correlacion-loading').textContent = 'No tienes activos en tu cartera para comparar';
                    return;
                }
                
                const posiciones = portfolioResult.data.posiciones.filter(p => p.ticker || p.isin);
                const correlaciones = [];
                
                // Retornos del activo actual por fecha
                const retornosActivoPorFecha = {};
                for (let i = 1; i < window.chartData.precios.length; i++) {
                    const retorno = (window.chartData.precios[i] - window.chartData.precios[i-1]) / window.chartData.precios[i-1];
                    retornosActivoPorFecha[window.chartData.fechas[i]] = retorno;
                }
                
                for (const pos of posiciones.slice(0, 5)) {
                    try {
                        const ticker = pos.ticker || pos.isin;
                        const response = await fetch(`/api/historical/${encodeURIComponent(ticker)}?periodo=1y&isin=${encodeURIComponent(pos.isin || '')}`);
                        const result = await response.json();
                        
                        if (result.success && result.data.precios && result.data.fechas) {
                            const retornosOtroPorFecha = {};
                            for (let i = 1; i < result.data.precios.length; i++) {
                                const retorno = (result.data.precios[i] - result.data.precios[i-1]) / result.data.precios[i-1];
                                retornosOtroPorFecha[result.data.fechas[i]] = retorno;
                            }
                            
                            const fechasComunes = Object.keys(retornosActivoPorFecha).filter(f => retornosOtroPorFecha[f] !== undefined);
                            
                            if (fechasComunes.length >= 30) {
                                const x = fechasComunes.map(f => retornosActivoPorFecha[f]);
                                const y = fechasComunes.map(f => retornosOtroPorFecha[f]);
                                
                                const mediaX = x.reduce((a, b) => a + b, 0) / x.length;
                                const mediaY = y.reduce((a, b) => a + b, 0) / y.length;
                                
                                let num = 0, denX = 0, denY = 0;
                                for (let i = 0; i < x.length; i++) {
                                    num += (x[i] - mediaX) * (y[i] - mediaY);
                                    denX += Math.pow(x[i] - mediaX, 2);
                                    denY += Math.pow(y[i] - mediaY, 2);
                                }
                                
                                const corr = Math.sqrt(denX * denY) === 0 ? 0 : num / Math.sqrt(denX * denY);
                                correlaciones.push({ nombre: pos.nombre, correlacion: corr, dias: fechasComunes.length });
                            }
                        }
                    } catch (e) {
                        console.error('Error:', e);
                    }
                }
                
                // A√±adir benchmarks
                for (const bench of [{ ticker: '%5EGSPC', nombre: 'S&P 500 üìä' }, { ticker: '%5EIXIC', nombre: 'NASDAQ üìä' }]) {
                    try {
                        const response = await fetch(`/api/historical/${bench.ticker}?periodo=1y`);
                        const result = await response.json();
                        
                        if (result.success && result.data.precios && result.data.fechas) {
                            const retornosBenchPorFecha = {};
                            for (let i = 1; i < result.data.precios.length; i++) {
                                const retorno = (result.data.precios[i] - result.data.precios[i-1]) / result.data.precios[i-1];
                                retornosBenchPorFecha[result.data.fechas[i]] = retorno;
                            }
                            
                            const fechasComunes = Object.keys(retornosActivoPorFecha).filter(f => retornosBenchPorFecha[f] !== undefined);
                            
                            if (fechasComunes.length >= 30) {
                                const x = fechasComunes.map(f => retornosActivoPorFecha[f]);
                                const y = fechasComunes.map(f => retornosBenchPorFecha[f]);
                                
                                const mediaX = x.reduce((a, b) => a + b, 0) / x.length;
                                const mediaY = y.reduce((a, b) => a + b, 0) / y.length;
                                
                                let num = 0, denX = 0, denY = 0;
                                for (let i = 0; i < x.length; i++) {
                                    num += (x[i] - mediaX) * (y[i] - mediaY);
                                    denX += Math.pow(x[i] - mediaX, 2);
                                    denY += Math.pow(y[i] - mediaY, 2);
                                }
                                
                                const corr = Math.sqrt(denX * denY) === 0 ? 0 : num / Math.sqrt(denX * denY);
                                correlaciones.push({ nombre: bench.nombre, correlacion: corr, dias: fechasComunes.length });
                            }
                        }
                    } catch (e) {
                        console.error('Error:', e);
                    }
                }
                
                correlaciones.sort((a, b) => Math.abs(b.correlacion) - Math.abs(a.correlacion));
                mostrarCorrelaciones(correlaciones);
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('correlacion-loading').textContent = 'Error al calcular correlaciones';
            }
        }
        
        function mostrarCorrelaciones(correlaciones) {
            document.getElementById('correlacion-loading').classList.add('hidden');
            document.getElementById('correlacion-results').classList.remove('hidden');
            
            const list = document.getElementById('correlacion-list');
            
            if (correlaciones.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-center py-4">No hay activos para comparar</div>';
                return;
            }
            
            list.innerHTML = correlaciones.map(c => {
                const corr = c.correlacion;
                const corrPct = (corr * 100).toFixed(0);
                
                let colorClass, barColor, interpretacion;
                if (corr >= 0.7) {
                    colorClass = 'text-red-400'; barColor = 'bg-red-500'; interpretacion = 'Alta correlaci√≥n';
                } else if (corr >= 0.4) {
                    colorClass = 'text-yellow-400'; barColor = 'bg-yellow-500'; interpretacion = 'Correlaci√≥n moderada';
                } else if (corr >= -0.4) {
                    colorClass = 'text-green-400'; barColor = 'bg-green-500'; interpretacion = 'Baja correlaci√≥n ‚úì';
                } else if (corr >= -0.7) {
                    colorClass = 'text-blue-400'; barColor = 'bg-blue-500'; interpretacion = 'Correlaci√≥n inversa';
                } else {
                    colorClass = 'text-purple-400'; barColor = 'bg-purple-500'; interpretacion = 'Alta correlaci√≥n inversa';
                }
                
                return `
                    <div class="p-2 bg-gray-800/50 rounded">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm text-gray-300 truncate">${c.nombre}</span>
                            <span class="${colorClass} font-medium">${corr >= 0 ? '+' : ''}${corrPct}%</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="flex-1 h-2 bg-gray-700 rounded overflow-hidden">
                                <div class="${barColor} h-full rounded" style="width: ${Math.abs(corr) * 100}%"></div>
                            </div>
                            <span class="text-xs text-gray-500">${interpretacion} (${c.dias}d)</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // A√±adir a cartera
        function anadirACartera() {
            if (!activoActual) return;
            
            const url = `/add?nombre=${encodeURIComponent(activoActual.nombre)}&ticker=${encodeURIComponent(activoActual.ticker)}&isin=${encodeURIComponent(activoActual.isin || '')}`;
            window.location.href = url;
        }
        
        // =====================
        // SISTEMA DE ALERTAS
        // =====================
        
        function mostrarModalAlerta() {
            if (!activoActual) {
                alert('Primero busca un activo');
                return;
            }
            
            // Obtener precio actual
            const precioActual = window.chartData?.precios?.[window.chartData.precios.length - 1] || 0;
            
            document.getElementById('alerta-nombre').textContent = activoActual.nombre;
            document.getElementById('alerta-ticker').textContent = activoActual.ticker;
            document.getElementById('alerta-precio-actual').textContent = precioActual.toFixed(2) + '‚Ç¨';
            document.getElementById('alerta-porcentaje').value = 8;
            
            // Calcular precio objetivo inicial
            calcularPrecioObjetivo();
            
            document.getElementById('modal-alerta').classList.remove('hidden');
        }
        
        function cerrarModalAlerta() {
            document.getElementById('modal-alerta').classList.add('hidden');
        }
        
        function calcularPrecioObjetivo() {
            const precioActual = window.chartData?.precios?.[window.chartData.precios.length - 1] || 0;
            const porcentaje = parseFloat(document.getElementById('alerta-porcentaje').value) || 0;
            const tipo = document.getElementById('alerta-tipo').value;
            
            let precioObjetivo;
            if (tipo === 'baja') {
                precioObjetivo = precioActual * (1 - porcentaje / 100);
            } else {
                precioObjetivo = precioActual * (1 + porcentaje / 100);
            }
            
            document.getElementById('alerta-precio-objetivo').textContent = precioObjetivo.toFixed(2) + '‚Ç¨';
            
            // Actualizar texto descriptivo
            const descripcion = tipo === 'baja' 
                ? `Te avisaremos cuando baje un ${porcentaje}% (a ${precioObjetivo.toFixed(2)}‚Ç¨)`
                : `Te avisaremos cuando suba un ${porcentaje}% (a ${precioObjetivo.toFixed(2)}‚Ç¨)`;
            document.getElementById('alerta-descripcion').textContent = descripcion;
        }
        
        async function crearAlerta() {
            if (!activoActual) return;
            
            const porcentaje = parseFloat(document.getElementById('alerta-porcentaje').value) || 0;
            const tipo = document.getElementById('alerta-tipo').value;
            
            if (porcentaje <= 0 || porcentaje > 99) {
                alert('El porcentaje debe estar entre 1 y 99');
                return;
            }
            
            try {
                const response = await fetch('/api/alertas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nombre: activoActual.nombre,
                        ticker: activoActual.ticker,
                        isin: activoActual.isin || '',
                        tipo: tipo,
                        objetivo_pct: porcentaje
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    cerrarModalAlerta();
                    
                    // Mostrar confirmaci√≥n
                    const toast = document.createElement('div');
                    toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    toast.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span>‚úÖ</span>
                            <span>Alerta creada para ${activoActual.nombre}</span>
                        </div>
                    `;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 4000);
                } else {
                    alert('Error: ' + (result.error || 'No se pudo crear la alerta'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al crear la alerta');
            }
        }
        
        // Event listeners para actualizar precio objetivo
        document.addEventListener('DOMContentLoaded', function() {
            const porcentajeInput = document.getElementById('alerta-porcentaje');
            const tipoSelect = document.getElementById('alerta-tipo');
            
            if (porcentajeInput) {
                porcentajeInput.addEventListener('input', calcularPrecioObjetivo);
            }
            if (tipoSelect) {
                tipoSelect.addEventListener('change', calcularPrecioObjetivo);
            }
        });
        
        // =====================
        // FAVORITOS
        // =====================
        
        let esFavoritoActual = false;
        let favoritosColapsado = false;
        
        // Cargar favoritos al inicio
        document.addEventListener('DOMContentLoaded', cargarFavoritos);
        
        async function cargarFavoritos() {
            const loading = document.getElementById('favoritos-loading');
            const empty = document.getElementById('favoritos-empty');
            const grid = document.getElementById('favoritos-grid');
            
            loading.classList.remove('hidden');
            empty.classList.add('hidden');
            grid.classList.add('hidden');
            
            try {
                const response = await fetch('/api/favoritos');
                const result = await response.json();
                
                loading.classList.add('hidden');
                
                if (result.success && result.data.length > 0) {
                    renderizarFavoritos(result.data);
                    grid.classList.remove('hidden');
                } else {
                    empty.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error cargando favoritos:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        function renderizarFavoritos(favoritos) {
            const grid = document.getElementById('favoritos-grid');
            
            grid.innerHTML = favoritos.map(fav => {
                const precio = fav.precio_actual ? fav.precio_actual.toFixed(2) + '‚Ç¨' : '-';
                const cambio = fav.cambio_desde_agregado;
                const cambioClass = cambio > 0 ? 'text-green-400' : cambio < 0 ? 'text-red-400' : 'text-gray-400';
                const cambioText = cambio !== null && cambio !== undefined ? `${cambio >= 0 ? '+' : ''}${cambio.toFixed(2)}%` : '-';
                const cambioDiario = fav.cambio_diario;
                const cambioDiarioClass = cambioDiario > 0 ? 'text-green-400' : cambioDiario < 0 ? 'text-red-400' : 'text-gray-400';
                const cambioDiarioText = cambioDiario !== null && cambioDiario !== undefined ? `${cambioDiario >= 0 ? '+' : ''}${cambioDiario.toFixed(2)}%` : '-';
                const mensajeCierre = fav.mensaje_cierre || '';
                
                const fechaAgregado = fav.fecha_agregado ? new Date(fav.fecha_agregado).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' }) : '';
                
                return `
                    <div class="bg-gray-700/50 rounded-lg p-4 hover:bg-gray-700 transition cursor-pointer group relative" onclick="buscarRapido('${fav.ticker || fav.isin}')">
                        <button onclick="event.stopPropagation(); eliminarFavoritoDirecto('${fav.id}')" 
                            class="absolute top-2 right-2 p-1 text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition"
                            title="Eliminar de favoritos">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-white truncate" title="${fav.nombre}">${fav.nombre}</h3>
                                <p class="text-xs text-gray-400">${fav.ticker || fav.isin || ''}</p>
                            </div>
                        </div>
                        
                        <div class="flex items-end justify-between mb-2">
                            <div>
                                <div class="text-lg font-bold">${precio}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm ${cambioDiarioClass}">${cambioDiarioText}</div>
                                <div class="text-xs text-gray-500">${mensajeCierre || 'Hoy'}</div>
                            </div>
                        </div>
                        
                        <div class="pt-2 border-t border-gray-600/50">
                            <div class="flex justify-between items-center">
                                <div class="text-xs text-gray-500">üìÖ ${fechaAgregado}</div>
                                <div class="text-right">
                                    <span class="text-xs ${cambioClass}">${cambioText}</span>
                                    <span class="text-xs text-gray-500 ml-1">total</span>
                                </div>
                            </div>
                        </div>
                        
                        ${fav.notas ? `<div class="mt-2 text-xs text-gray-400 truncate" title="${fav.notas}">üìù ${fav.notas}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function toggleFavoritosSection() {
            const content = document.getElementById('favoritos-content');
            const icon = document.getElementById('favoritos-toggle-icon');
            
            favoritosColapsado = !favoritosColapsado;
            
            if (favoritosColapsado) {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(-90deg)';
            } else {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        async function eliminarFavoritoDirecto(id) {
            if (!confirm('¬øEliminar de favoritos?')) return;
            
            try {
                const response = await fetch(`/api/favoritos/${id}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (result.success) {
                    cargarFavoritos();
                    mostrarToast('Eliminado de favoritos', 'info');
                }
            } catch (error) {
                mostrarToast('Error al eliminar', 'error');
            }
        }
        
        async function verificarFavorito() {
            if (!activoActual) return;
            
            try {
                const response = await fetch('/api/favoritos/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ticker: activoActual.ticker,
                        isin: activoActual.isin
                    })
                });
                const result = await response.json();
                
                esFavoritoActual = result.es_favorito;
                actualizarIconoFavorito();
            } catch (error) {
                console.error('Error verificando favorito:', error);
            }
        }
        
        function actualizarIconoFavorito() {
            const icon = document.getElementById('icon-favorito');
            const btn = document.getElementById('btn-favorito');
            
            if (esFavoritoActual) {
                icon.classList.remove('text-gray-400');
                icon.classList.add('text-yellow-400');
                icon.setAttribute('fill', 'currentColor');
                btn.title = 'Quitar de favoritos';
            } else {
                icon.classList.remove('text-yellow-400');
                icon.classList.add('text-gray-400');
                icon.setAttribute('fill', 'none');
                btn.title = 'A√±adir a favoritos';
            }
        }
        
        async function toggleFavorito() {
            if (!activoActual) return;
            
            try {
                if (esFavoritoActual) {
                    // Quitar de favoritos - primero obtener el ID
                    const listResponse = await fetch('/api/favoritos');
                    const listResult = await listResponse.json();
                    
                    if (listResult.success) {
                        const fav = listResult.data.find(f => 
                            f.ticker === activoActual.ticker || f.isin === activoActual.isin
                        );
                        
                        if (fav) {
                            await fetch(`/api/favoritos/${fav.id}`, { method: 'DELETE' });
                            esFavoritoActual = false;
                            actualizarIconoFavorito();
                            cargarFavoritos(); // Refrescar lista
                            mostrarToast('Eliminado de favoritos', 'info');
                        }
                    }
                } else {
                    // A√±adir a favoritos
                    const response = await fetch('/api/favoritos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ticker: activoActual.ticker,
                            isin: activoActual.isin,
                            nombre: activoActual.nombre
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        esFavoritoActual = true;
                        actualizarIconoFavorito();
                        cargarFavoritos(); // Refrescar lista
                        mostrarToast('A√±adido a favoritos ‚≠ê', 'success');
                    } else {
                        mostrarToast(result.error || 'Error al a√±adir', 'error');
                    }
                }
            } catch (error) {
                console.error('Error con favorito:', error);
                mostrarToast('Error al procesar favorito', 'error');
            }
        }
        
        function mostrarToast(mensaje, tipo = 'info') {
            // Crear toast
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300 ${
                tipo === 'success' ? 'bg-green-600' : 
                tipo === 'error' ? 'bg-red-600' : 'bg-blue-600'
            } text-white`;
            toast.textContent = mensaje;
            document.body.appendChild(toast);
            
            // Animar entrada
            setTimeout(() => toast.style.opacity = '1', 10);
            
            // Remover despu√©s de 3 segundos
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
    
    <!-- Modal Crear Alerta -->
    <div id="modal-alerta" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl border border-gray-700 p-6 max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <span>üîî</span> Crear Alerta de Precio
                </h3>
                <button onclick="cerrarModalAlerta()" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Info del activo -->
            <div class="bg-gray-700/50 rounded-lg p-4 mb-4">
                <div class="font-medium text-lg" id="alerta-nombre">-</div>
                <div class="text-sm text-gray-400" id="alerta-ticker">-</div>
                <div class="text-2xl font-bold mt-2 text-green-400" id="alerta-precio-actual">-</div>
            </div>
            
            <!-- Configuraci√≥n -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Tipo de alerta</label>
                    <select id="alerta-tipo" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2">
                        <option value="baja">üìâ Cuando BAJE</option>
                        <option value="sube">üìà Cuando SUBA</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Porcentaje de cambio</label>
                    <div class="flex items-center gap-2">
                        <input type="range" id="alerta-porcentaje" min="1" max="50" value="8" 
                            class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        <span class="text-xl font-bold w-16 text-right" id="alerta-pct-display">8%</span>
                    </div>
                    <script>
                        document.getElementById('alerta-porcentaje').addEventListener('input', function() {
                            document.getElementById('alerta-pct-display').textContent = this.value + '%';
                        });
                    </script>
                </div>
                
                <div class="bg-orange-900/30 border border-orange-700/50 rounded-lg p-3">
                    <div class="text-sm text-orange-300" id="alerta-descripcion">
                        Te avisaremos cuando baje un 8%
                    </div>
                    <div class="text-lg font-bold text-orange-400 mt-1">
                        Precio objetivo: <span id="alerta-precio-objetivo">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Botones -->
            <div class="flex gap-3 mt-6">
                <button onclick="cerrarModalAlerta()" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                    Cancelar
                </button>
                <button onclick="crearAlerta()" class="flex-1 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium transition flex items-center justify-center gap-2">
                    <span>üîî</span> Crear Alerta
                </button>
            </div>
            
            <p class="text-xs text-gray-500 text-center mt-4">
                üí° Las alertas se verifican cada vez que abres la app
            </p>
        </div>
    </div>
    
    <!-- Navegaci√≥n M√≥vil -->
    <nav class="mobile-nav fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700 px-1 py-2 md:hidden z-50" style="padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));">
        <div class="flex justify-around items-center">
            <a href="/" class="flex flex-col items-center text-gray-400 hover:text-blue-400 py-1 px-2 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="text-[10px] mt-0.5">Inicio</span>
            </a>
            <a href="/explorar" class="flex flex-col items-center text-purple-400 py-1 px-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <span class="text-[10px] mt-0.5">Explorar</span>
            </a>
            <a href="/heatmap" class="flex flex-col items-center text-gray-400 hover:text-rose-400 py-1 px-2 transition">
                <span class="text-lg">üî•</span>
                <span class="text-[10px] mt-0.5">Heatmap</span>
            </a>
            <a href="/add" class="flex flex-col items-center justify-center bg-blue-600 rounded-full w-12 h-12 -mt-5 shadow-lg">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </a>
            <a href="/alertas" class="relative flex flex-col items-center text-gray-400 hover:text-orange-400 py-1 px-2 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                </svg>
                <span class="text-[10px] mt-0.5">Alertas</span>
            </a>
            <a href="/settings" class="flex flex-col items-center text-gray-400 hover:text-gray-200 py-1 px-2 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span class="text-[10px] mt-0.5">Ajustes</span>
            </a>
        </div>
    </nav>
</body>
</html>
