<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Portfolio Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Portfolio Tracker">
    <meta name="description" content="Gestiona tu cartera de inversiones">
    <meta name="theme-color" content="#111827">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Portfolio">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Charts para Sankey -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- amCharts 5 para mapa mundial -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Dark.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* PWA: Ocultar scroll en iOS cuando est√° instalada */
        html {
            overscroll-behavior: none;
        }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinning {
            animation: spin 1s linear infinite;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #3b82f6; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                <span class="text-3xl">üìä</span> Portfolio Tracker
            </h1>
            <div class="flex items-center gap-2 md:gap-3">
                <!-- Indicador de √∫ltima actualizaci√≥n -->
                <div id="update-indicator" class="hidden text-xs text-gray-400 items-center gap-1 md:flex">
                    <span id="update-status-dot" class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span id="update-time">-</span>
                </div>
                
                <!-- Bot√≥n refrescar -->
                <button id="refresh-btn" onclick="refreshPrices()" 
                    class="text-gray-400 hover:text-white transition p-2 rounded-lg hover:bg-gray-700" 
                    title="Actualizar precios">
                    <svg id="refresh-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
                
                <!-- Admin (solo si es admin) -->
                {% if session.get('is_admin') %}
                <a href="/admin" class="hidden md:flex bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded-lg font-medium transition items-center gap-1 text-sm" title="Administraci√≥n">
                    üë• Admin
                </a>
                {% endif %}
                
                <!-- Navegaci√≥n desktop (oculta en m√≥vil) -->
                <a href="/settings" class="hidden md:block text-gray-400 hover:text-white transition p-2" title="Configuraci√≥n">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </a>
                <a href="/heatmap" class="hidden md:flex bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg font-medium transition items-center gap-2" title="Mapa de calor">
                    <span>üî•</span>
                    Heatmap
                </a>
                <a href="/explorar" class="hidden md:flex bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition items-center gap-2" title="Explorar activos">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Explorar
                </a>
                <a href="/alertas" class="hidden md:flex relative bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-medium transition items-center gap-2" title="Alertas de precio">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    Alertas
                    <span id="alertas-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">!</span>
                </a>
                <a href="/add" class="hidden md:flex bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    A√±adir Posici√≥n
                </a>
                
                <!-- Usuario y Logout -->
                {% if session.get('logged_in') %}
                <div class="hidden md:flex items-center gap-2 ml-2 pl-2 border-l border-gray-600">
                    <span class="text-sm text-gray-400">{{ session.get('nombre', session.get('username', '')) }}</span>
                    <a href="/logout" class="text-red-400 hover:text-red-300 p-1" title="Cerrar sesi√≥n">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8 pb-24 md:pb-8">
        <!-- Loading State -->
        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="loader mb-4"></div>
            <p class="text-gray-400">Cargando cartera...</p>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-20">
            <div class="text-6xl mb-4">üì≠</div>
            <h2 class="text-2xl font-semibold mb-2">Tu cartera est√° vac√≠a</h2>
            <p class="text-gray-400 mb-6">A√±ade tu primera posici√≥n para empezar a hacer seguimiento</p>
            <a href="/add" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition inline-flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                A√±adir Primera Posici√≥n
            </a>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="hidden">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <!-- Valor Total -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Valor Total</span>
                        <span class="text-2xl">üí∞</span>
                    </div>
                    <div class="text-3xl font-bold" id="valor-total">0 ‚Ç¨</div>
                </div>

                <!-- Total Invertido -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Total Invertido</span>
                        <span class="text-2xl">üíµ</span>
                    </div>
                    <div class="text-3xl font-bold" id="total-invertido">0 ‚Ç¨</div>
                </div>

                <!-- Beneficio -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Beneficio</span>
                        <span class="text-2xl">üìà</span>
                    </div>
                    <div class="text-3xl font-bold" id="beneficio">0 ‚Ç¨</div>
                    <div class="text-sm mt-1" id="rentabilidad">0%</div>
                </div>

                <!-- Posiciones -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Posiciones</span>
                        <span class="text-2xl">üìä</span>
                    </div>
                    <div class="text-3xl font-bold" id="num-posiciones">0</div>
                    <div class="text-sm mt-1 text-gray-400">
                        <span class="text-green-400" id="ganadoras">0</span> ‚úì ¬∑ 
                        <span class="text-red-400" id="perdedoras">0</span> ‚úó
                    </div>
                </div>
            </div>

            <!-- Rentabilidad por Per√≠odo -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-8">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <span>üìä</span> Rentabilidad por Per√≠odo
                </h3>
                <div id="returns-loader" class="flex items-center justify-center py-4">
                    <div class="loader"></div>
                </div>
                <div id="returns-grid" class="hidden grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Portfolio Evolution Chart -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold flex items-center gap-2">
                            <span>üìà</span> Evoluci√≥n de Cartera
                        </h3>
                        <select id="evolution-period" onchange="loadEvolution()" 
                            class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                            <option value="1mo">1 Mes</option>
                            <option value="3mo">3 Meses</option>
                            <option value="6mo">6 Meses</option>
                            <option value="1y" selected>1 A√±o</option>
                            <option value="2y">2 A√±os</option>
                            <option value="5y">5 A√±os</option>
                            <option value="max">üìÖ Desde inicio</option>
                        </select>
                    </div>
                    <div class="h-64 relative">
                        <div id="evolution-loader" class="absolute inset-0 flex items-center justify-center">
                            <div class="loader"></div>
                        </div>
                        <canvas id="evolution-chart"></canvas>
                    </div>
                    <div id="evolution-summary" class="mt-4 hidden">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div class="bg-gray-700/50 rounded-lg p-3">
                                <div class="text-xs text-gray-400 mb-1" id="evolution-inicio-label">Inicio per√≠odo</div>
                                <div class="font-medium" id="evolution-inicio">-</div>
                            </div>
                            <div class="bg-gray-700/50 rounded-lg p-3">
                                <div class="text-xs text-gray-400 mb-1">Valor Actual</div>
                                <div class="font-medium" id="evolution-actual">-</div>
                            </div>
                            <div class="bg-gray-700/50 rounded-lg p-3">
                                <div class="text-xs text-gray-400 mb-1">Rentab. per√≠odo</div>
                                <div class="font-bold" id="evolution-rentabilidad">-</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
                            <span id="evolution-desde"></span>
                            <span id="evolution-total" class="bg-gray-700/30 px-2 py-1 rounded"></span>
                        </div>
                    </div>
                </div>

                <!-- Benchmark Comparison -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold flex items-center gap-2">
                            <span>üéØ</span> Comparar con Benchmarks
                        </h3>
                        <select id="benchmark-period" onchange="loadBenchmarks()" 
                            class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                            <option value="1mo">1 Mes</option>
                            <option value="3mo">3 Meses</option>
                            <option value="6mo">6 Meses</option>
                            <option value="1y" selected>1 A√±o</option>
                            <option value="ytd">A√±o actual</option>
                        </select>
                    </div>
                    <div id="benchmark-content">
                        <div id="benchmark-loader" class="flex items-center justify-center py-8">
                            <div class="loader"></div>
                        </div>
                        <div id="benchmark-data" class="hidden">
                            <div class="mb-4 p-3 bg-gray-700/50 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">üìä Tu Cartera</span>
                                    <span id="my-portfolio-return" class="font-bold text-xl">-</span>
                                </div>
                            </div>
                            <div class="space-y-3" id="benchmark-list">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categories and Distribution -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Categories Distribution -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold flex items-center gap-2">
                            <span>üè∑Ô∏è</span> Distribuci√≥n por Categor√≠a
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="showCategoriesModal()" 
                                class="text-xs bg-gray-600/50 hover:bg-gray-600 text-gray-200 px-3 py-1 rounded-full transition flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Nueva
                            </button>
                            <button onclick="autoAssignCategories()" id="auto-assign-btn"
                                class="text-xs bg-purple-600/50 hover:bg-purple-600 text-purple-200 px-3 py-1 rounded-full transition flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Auto-detectar
                            </button>
                        </div>
                    </div>
                    <div class="h-64 relative">
                        <div id="categories-loader" class="absolute inset-0 flex items-center justify-center">
                            <div class="loader"></div>
                        </div>
                        <canvas id="categories-chart"></canvas>
                    </div>
                </div>

                <!-- Categories Table -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>üìã</span> Detalle por Categor√≠a
                    </h3>
                    <div id="categories-table-content">
                        <div id="categories-table-loader" class="flex items-center justify-center py-8">
                            <div class="loader"></div>
                        </div>
                        <div id="categories-table" class="hidden space-y-2 max-h-64 overflow-y-auto">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Target Allocation -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <span>üéØ</span> Target Allocation
                    </h3>
                    <button onclick="showTargetModal()" class="text-sm bg-blue-600/50 hover:bg-blue-600 text-blue-200 px-3 py-1 rounded-full transition flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Configurar
                    </button>
                </div>
                <div id="allocation-loader" class="flex items-center justify-center py-8">
                    <div class="loader"></div>
                </div>
                <div id="allocation-content" class="hidden">
                    <div id="allocation-no-targets" class="hidden text-center py-8 text-gray-400">
                        <div class="text-4xl mb-2">üéØ</div>
                        <p>No has configurado objetivos de asignaci√≥n.</p>
                        <p class="text-sm">Click en "Configurar" para definir tu estrategia.</p>
                    </div>
                    <div id="allocation-grid" class="space-y-3">
                    </div>
                </div>
            </div>

            <!-- M√©tricas Avanzadas y Exposici√≥n Geogr√°fica -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- M√©tricas Avanzadas -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>üìâ</span> M√©tricas de Riesgo
                    </h3>
                    <div id="metrics-loader" class="flex items-center justify-center py-8">
                        <div class="loader"></div>
                    </div>
                    <div id="metrics-content" class="hidden">
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div class="text-center p-3 bg-gray-700/50 rounded-lg">
                                <div class="text-xs text-gray-400 mb-1">Volatilidad</div>
                                <div class="text-xl font-bold" id="metric-volatilidad">-</div>
                                <div class="text-xs mt-1" id="metric-volatilidad-int">-</div>
                            </div>
                            <div class="text-center p-3 bg-gray-700/50 rounded-lg">
                                <div class="text-xs text-gray-400 mb-1">Max Drawdown</div>
                                <div class="text-xl font-bold text-red-400" id="metric-drawdown">-</div>
                                <div class="text-xs mt-1" id="metric-drawdown-int">-</div>
                            </div>
                            <div class="text-center p-3 bg-gray-700/50 rounded-lg">
                                <div class="text-xs text-gray-400 mb-1">Sharpe Ratio</div>
                                <div class="text-xl font-bold" id="metric-sharpe">-</div>
                                <div class="text-xs mt-1" id="metric-sharpe-int">-</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="flex justify-between p-2 bg-gray-700/30 rounded">
                                <span class="text-gray-400">Mejor d√≠a</span>
                                <span class="text-green-400" id="metric-mejor-dia">-</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700/30 rounded">
                                <span class="text-gray-400">Peor d√≠a</span>
                                <span class="text-red-400" id="metric-peor-dia">-</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700/30 rounded">
                                <span class="text-gray-400">D√≠as positivos</span>
                                <span class="text-green-400" id="metric-dias-pos">-</span>
                            </div>
                            <div class="flex justify-between p-2 bg-gray-700/30 rounded">
                                <span class="text-gray-400">D√≠as negativos</span>
                                <span class="text-red-400" id="metric-dias-neg">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Exposici√≥n Geogr√°fica -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>üåç</span> Exposici√≥n Geogr√°fica
                    </h3>
                    <div id="geography-loader" class="flex items-center justify-center py-8">
                        <div class="loader"></div>
                    </div>
                    <div id="geography-content" class="hidden">
                        <!-- Mapa Mundial Interactivo -->
                        <div id="world-map" style="height: 250px; width: 100%; background: #1f2937; border-radius: 8px;"></div>
                        
                        <!-- Lista de pa√≠ses debajo del mapa -->
                        <div id="geography-list" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertas de Desviaci√≥n -->
            <div id="desviacion-alertas" class="hidden mb-6">
                <div class="bg-yellow-900/30 border border-yellow-600/50 rounded-xl p-4">
                    <h3 class="font-semibold text-yellow-400 mb-3 flex items-center gap-2">
                        <span>‚ö†Ô∏è</span> Alertas de Desviaci√≥n
                    </h3>
                    <div id="desviacion-lista" class="space-y-2">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Diagrama Sankey de Diversificaci√≥n -->
            <div class="bg-gray-800 rounded-xl border border-gray-700 mb-8 overflow-hidden">
                <div class="px-6 pt-4 pb-2">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <span>üåä</span> Diversificaci√≥n por Sectores
                    </h3>
                </div>
                <div id="sankey-loader" class="flex items-center justify-center py-8">
                    <div class="loader"></div>
                </div>
                <div id="sankey-content" class="hidden">
                    <div id="sankey-chart" style="width: 100%; height: 380px;"></div>
                    
                    <!-- Resumen de diversificaci√≥n -->
                    <div id="sankey-resumen" class="mx-6 mb-6 pt-4 border-t border-gray-700">
                        <div class="flex flex-wrap gap-4 justify-between items-start">
                            <!-- Stats r√°pidas -->
                            <div class="flex gap-6 text-sm">
                                <div>
                                    <span class="text-gray-400">Valor Total</span>
                                    <p id="sankey-valor-total" class="font-semibold text-lg text-white">‚Ç¨0</p>
                                </div>
                                <div>
                                    <span class="text-gray-400">Categor√≠as</span>
                                    <p id="sankey-num-categorias" class="font-semibold text-lg text-blue-400">0</p>
                                </div>
                                <div>
                                    <span class="text-gray-400">Posiciones</span>
                                    <p id="sankey-num-posiciones" class="font-semibold text-lg text-green-400">0</p>
                                </div>
                            </div>
                            
                            <!-- Lista de categor√≠as -->
                            <div id="sankey-categorias" class="flex flex-wrap gap-2">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>
                <div id="sankey-empty" class="hidden text-center py-8 px-6 text-gray-500">
                    <p>No hay suficientes datos para mostrar el diagrama de diversificaci√≥n</p>
                </div>
            </div>

            <!-- Calculadora de Rebalanceo Autom√°tico -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-8">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <span>ü§ñ</span> Calculadora de Rebalanceo Autom√°tico
                </h3>
                
                <!-- Opciones de rebalanceo -->
                <div class="bg-gray-700/50 rounded-lg p-4 mb-4">
                    <!-- Modo de rebalanceo -->
                    <div class="flex flex-wrap gap-4 mb-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="rebalance-modo" value="aportacion" checked 
                                class="w-4 h-4 text-blue-600" onchange="cambiarModoRebalanceo()">
                            <span class="text-sm">üí∞ Con aportaci√≥n nueva</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="rebalance-modo" value="puro" 
                                class="w-4 h-4 text-blue-600" onchange="cambiarModoRebalanceo()">
                            <span class="text-sm">üîÑ Rebalanceo puro (vender + comprar)</span>
                        </label>
                    </div>
                    
                    <!-- Input de aportaci√≥n -->
                    <div id="rebalance-aportacion-section">
                        <div class="flex flex-col sm:flex-row gap-4 items-end">
                            <div class="flex-1">
                                <label class="block text-sm text-gray-400 mb-1">¬øCu√°nto vas a aportar?</label>
                                <div class="relative">
                                    <input type="number" id="rebalance-aportacion" value="500" min="0" step="50"
                                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-xl font-bold focus:border-blue-500 outline-none"
                                        onkeypress="if(event.key === 'Enter') calcularRebalanceo()">
                                    <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-xl">‚Ç¨</span>
                                </div>
                            </div>
                            <button onclick="calcularRebalanceo()" 
                                class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition flex items-center gap-2">
                                <span>üîÑ</span> Calcular
                            </button>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="document.getElementById('rebalance-aportacion').value=100; calcularRebalanceo()" 
                                class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm">100‚Ç¨</button>
                            <button onclick="document.getElementById('rebalance-aportacion').value=250; calcularRebalanceo()" 
                                class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm">250‚Ç¨</button>
                            <button onclick="document.getElementById('rebalance-aportacion').value=500; calcularRebalanceo()" 
                                class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm">500‚Ç¨</button>
                            <button onclick="document.getElementById('rebalance-aportacion').value=1000; calcularRebalanceo()" 
                                class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm">1000‚Ç¨</button>
                        </div>
                    </div>
                    
                    <!-- Modo puro -->
                    <div id="rebalance-puro-section" class="hidden">
                        <div class="p-4 bg-purple-900/20 border border-purple-700/30 rounded-lg mb-4">
                            <h4 class="font-medium text-purple-300 mb-2">üîÑ ¬øC√≥mo funciona el rebalanceo puro?</h4>
                            <ol class="text-sm text-gray-400 space-y-1 list-decimal list-inside">
                                <li>Compara tu distribuci√≥n <strong>actual</strong> con la <strong>objetivo</strong> (Target Allocation)</li>
                                <li>Identifica activos <strong class="text-red-400">sobreponderados</strong> (tienes m√°s % del que deber√≠as)</li>
                                <li>Identifica activos <strong class="text-green-400">infraponderados</strong> (tienes menos % del que deber√≠as)</li>
                                <li>Sugiere <strong class="text-red-400">vender</strong> los sobreponderados</li>
                                <li>Usa ese dinero para <strong class="text-green-400">comprar</strong> los infraponderados</li>
                            </ol>
                            <p class="text-xs text-gray-500 mt-2">üí° No necesitas a√±adir dinero nuevo. El dinero de las ventas financia las compras.</p>
                        </div>
                        <div class="flex justify-center">
                            <button onclick="calcularRebalanceo()" 
                                class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition flex items-center gap-2">
                                <span>üîÑ</span> Calcular Rebalanceo Puro
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Loading -->
                <div id="rebalance-loader" class="hidden flex items-center justify-center py-8">
                    <div class="loader"></div>
                </div>
                
                <!-- Sin targets configurados -->
                <div id="rebalance-no-targets" class="hidden text-center py-8 text-gray-400">
                    <div class="text-4xl mb-2">‚öôÔ∏è</div>
                    <p class="mb-2">Primero configura tus objetivos de distribuci√≥n.</p>
                    <p class="text-sm">Ve a <strong>Target Allocation</strong> m√°s abajo y define qu√© % quieres de cada categor√≠a.</p>
                </div>
                
                <!-- Resultado del c√°lculo -->
                <div id="rebalance-result" class="hidden">
                    <!-- Resumen -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="p-3 bg-gray-700/50 rounded-lg text-center">
                            <div class="text-xs text-gray-400 mb-1">Cartera Actual</div>
                            <div class="text-lg font-bold" id="reb-valor-actual">0‚Ç¨</div>
                        </div>
                        <div class="p-3 bg-blue-900/30 rounded-lg text-center" id="reb-aportacion-box">
                            <div class="text-xs text-gray-400 mb-1">Aportaci√≥n</div>
                            <div class="text-lg font-bold text-blue-400" id="reb-aportacion">0‚Ç¨</div>
                        </div>
                        <div class="p-3 bg-green-900/30 rounded-lg text-center">
                            <div class="text-xs text-gray-400 mb-1">A Comprar</div>
                            <div class="text-lg font-bold text-green-400" id="reb-invertir">0‚Ç¨</div>
                        </div>
                        <div class="p-3 bg-red-900/30 rounded-lg text-center" id="reb-vender-box">
                            <div class="text-xs text-gray-400 mb-1">A Vender</div>
                            <div class="text-lg font-bold text-red-400" id="reb-vender">0‚Ç¨</div>
                        </div>
                        <div class="p-3 bg-yellow-900/30 rounded-lg text-center">
                            <div class="text-xs text-gray-400 mb-1">Sobrante</div>
                            <div class="text-lg font-bold text-yellow-400" id="reb-sobrante">0‚Ç¨</div>
                        </div>
                    </div>
                    
                    <!-- Lista de operaciones (ventas + compras) -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold flex items-center gap-2">
                                <span>üìã</span> Operaciones a Realizar
                            </h4>
                            <button onclick="copiarOrdenes()" 
                                class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm flex items-center gap-1 transition">
                                <span>üìã</span> Copiar √≥rdenes
                            </button>
                        </div>
                        
                        <!-- Ventas -->
                        <div id="rebalance-ventas" class="hidden mb-3">
                            <div class="text-sm text-red-400 font-medium mb-2">üîª VENTAS</div>
                            <div id="rebalance-ventas-list" class="space-y-2"></div>
                        </div>
                        
                        <!-- Compras -->
                        <div id="rebalance-compras-section">
                            <div class="text-sm text-green-400 font-medium mb-2">üî∫ COMPRAS</div>
                            <div id="rebalance-compras" class="space-y-2"></div>
                        </div>
                    </div>
                    
                    <!-- Texto para copiar (oculto) -->
                    <textarea id="ordenes-texto" class="hidden"></textarea>
                    
                    <!-- Comparativa antes/despu√©s -->
                    <div class="bg-gray-700/30 rounded-lg p-4">
                        <h4 class="font-semibold mb-3 flex items-center gap-2">
                            <span>üìä</span> Distribuci√≥n: Antes ‚Üí Despu√©s
                        </h4>
                        <div id="rebalance-comparativa" class="space-y-2">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simulador y Objetivos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Simulador What If -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>üîÆ</span> Simulador "What If"
                    </h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Capital inicial (‚Ç¨)</label>
                                <input type="number" id="sim-capital" value="0" min="0" 
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Aportaci√≥n mensual (‚Ç¨)</label>
                                <input type="number" id="sim-aportacion" value="500" min="0" 
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">A√±os</label>
                                <input type="number" id="sim-anos" value="10" min="1" max="50" 
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Rentabilidad anual (%)</label>
                                <input type="number" id="sim-rentabilidad" value="7" min="0" max="30" step="0.5"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                            </div>
                        </div>
                        <button onclick="runSimulation()" 
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg transition flex items-center justify-center gap-2">
                            <span>üöÄ</span> Simular
                        </button>
                        
                        <!-- Resultado simulaci√≥n -->
                        <div id="sim-result" class="hidden">
                            <div class="h-48 mb-4">
                                <canvas id="simulation-chart"></canvas>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-center text-sm">
                                <div class="bg-red-900/20 border border-red-800/30 rounded p-2">
                                    <div class="text-xs text-gray-400">Pesimista</div>
                                    <div class="font-bold text-red-400" id="sim-pesimista">-</div>
                                </div>
                                <div class="bg-green-900/20 border border-green-800/30 rounded p-2">
                                    <div class="text-xs text-gray-400">Esperado</div>
                                    <div class="font-bold text-green-400" id="sim-esperado">-</div>
                                </div>
                                <div class="bg-blue-900/20 border border-blue-800/30 rounded p-2">
                                    <div class="text-xs text-gray-400">Optimista</div>
                                    <div class="font-bold text-blue-400" id="sim-optimista">-</div>
                                </div>
                            </div>
                            <div class="mt-3 p-3 bg-gray-700/50 rounded-lg">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-400">Total aportado:</span>
                                    <span id="sim-aportado">-</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-400">Beneficio estimado:</span>
                                    <span class="text-green-400" id="sim-beneficio">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Objetivos de Ahorro -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold flex items-center gap-2">
                            <span>üéØ</span> Objetivos de Ahorro
                        </h3>
                        <button onclick="showGoalModal()" class="text-sm bg-green-600/50 hover:bg-green-600 text-green-200 px-3 py-1 rounded-full transition">
                            + Nuevo
                        </button>
                    </div>
                    <div id="goals-loader" class="flex items-center justify-center py-8">
                        <div class="loader"></div>
                    </div>
                    <div id="goals-content" class="hidden">
                        <div id="goals-empty" class="hidden text-center py-8 text-gray-400">
                            <div class="text-4xl mb-2">üéØ</div>
                            <p>No tienes objetivos definidos.</p>
                            <p class="text-sm">Crea uno para seguir tu progreso.</p>
                        </div>
                        <div id="goals-list" class="space-y-4 max-h-80 overflow-y-auto">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rentabilidad Chart -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Rentabilidad Chart -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>üìä</span> Comparativa de Rentabilidad
                    </h3>
                    <div class="h-64">
                        <canvas id="rentabilidad-chart"></canvas>
                    </div>
                </div>

                <!-- Distribution Chart -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>ü•ß</span> Distribuci√≥n de Cartera
                    </h3>
                    <div class="h-64">
                        <canvas id="distribucion-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Beneficios Chart -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-8">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <span>üíπ</span> Beneficio por Posici√≥n (‚Ç¨)
                </h3>
                <div class="h-64">
                    <canvas id="beneficios-chart"></canvas>
                </div>
            </div>

            <!-- Positions Comparison Chart - NEW -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-8">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <span>üìà</span> Comparativa de Posiciones
                    </h3>
                    <div class="flex items-center gap-3">
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" id="normalize-toggle" onchange="loadPositionsComparison()" 
                                class="w-4 h-4 rounded bg-gray-700 border-gray-600">
                            <span class="text-gray-400">Normalizar (base 100)</span>
                        </label>
                        <select id="comparison-period" onchange="loadPositionsComparison()" 
                            class="bg-gray-700 border border-gray-600 rounded px-3 py-1 text-sm">
                            <option value="1mo">1 Mes</option>
                            <option value="3mo">3 Meses</option>
                            <option value="6mo" selected>6 Meses</option>
                            <option value="1y">1 A√±o</option>
                            <option value="2y">2 A√±os</option>
                            <option value="max">Desde inicio</option>
                        </select>
                    </div>
                </div>
                
                <!-- Aviso de activos sin datos -->
                <div id="comparison-warning" class="hidden mb-4 p-3 bg-yellow-900/30 border border-yellow-700/50 rounded-lg">
                    <div class="flex items-start gap-3">
                        <span class="text-yellow-400 text-lg">‚ö†Ô∏è</span>
                        <div class="flex-1">
                            <div class="text-yellow-300 text-sm font-medium">
                                <span id="warning-count">0</span> activos sin datos hist√≥ricos
                            </div>
                            <div class="text-yellow-200/70 text-xs mt-1" id="warning-names"></div>
                        </div>
                    </div>
                </div>
                
                <div class="h-80 relative">
                    <div id="comparison-loader" class="absolute inset-0 flex items-center justify-center">
                        <div class="loader"></div>
                    </div>
                    <canvas id="positions-comparison-chart"></canvas>
                </div>
                <div id="comparison-legend" class="mt-4 flex flex-wrap gap-3 justify-center text-sm">
                </div>
            </div>

            <!-- Positions Table -->
            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                <div class="p-6 border-b border-gray-700">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <span>üìã</span> Posiciones
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-750">
                            <tr class="text-left text-gray-400 text-sm">
                                <th class="px-6 py-4 font-medium">Activo</th>
                                <th class="px-6 py-4 font-medium">Cantidad</th>
                                <th class="px-6 py-4 font-medium">P. Compra</th>
                                <th class="px-6 py-4 font-medium">P. Actual</th>
                                <th class="px-6 py-4 font-medium">Valor</th>
                                <th class="px-6 py-4 font-medium">Beneficio</th>
                                <th class="px-6 py-4 font-medium">Rent. %</th>
                                <th class="px-6 py-4 font-medium">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="positions-table" class="divide-y divide-gray-700">
                            <!-- Rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Matriz de Correlaci√≥n -->
            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden mt-6">
                <div class="p-6 border-b border-gray-700 flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <h3 class="text-lg font-semibold flex items-center gap-2">
                            <span>üîó</span> Matriz de Correlaci√≥n
                        </h3>
                        <p class="text-sm text-gray-400 mt-1">C√≥mo se relacionan tus activos entre s√≠</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <select id="matriz-periodo" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm">
                            <option value="1mo">1 mes</option>
                            <option value="3mo">3 meses</option>
                            <option value="6mo">6 meses</option>
                            <option value="1y" selected>1 a√±o</option>
                            <option value="5y">5 a√±os</option>
                            <option value="10y">10 a√±os</option>
                        </select>
                        <button onclick="calcularMatrizCorrelacion()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm transition flex items-center gap-2">
                            <span>üîÑ</span> Calcular
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="matriz-loading" class="hidden text-center py-8">
                        <div class="loader mx-auto mb-4"></div>
                        <p class="text-gray-400">Calculando correlaciones... esto puede tardar unos segundos</p>
                    </div>
                    <div id="matriz-placeholder" class="text-center py-8 text-gray-500">
                        <p>Pulsa "Calcular" para generar la matriz de correlaci√≥n</p>
                        <p class="text-sm mt-2">Selecciona el per√≠odo y compara todos tus activos</p>
                    </div>
                    <div id="matriz-container" class="hidden overflow-x-auto">
                        <div id="matriz-periodo-info" class="text-center text-sm text-gray-400 mb-4"></div>
                        <table id="matriz-table" class="w-full text-xs">
                            <!-- Se llena din√°micamente -->
                        </table>
                        <div class="flex items-center justify-center gap-6 mt-4 text-xs text-gray-400">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-red-600"></div>
                                <span>Alta (+70% a +100%)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-yellow-500"></div>
                                <span>Moderada (+40% a +70%)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-green-500"></div>
                                <span>Baja (-40% a +40%)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-blue-500"></div>
                                <span>Inversa (-100% a -40%)</span>
                            </div>
                        </div>
                        <p class="text-center text-xs text-gray-500 mt-3">
                            üí° <strong>Consejo:</strong> Diversifica con activos de baja correlaci√≥n (verde). Alta correlaci√≥n (rojo) = se mueven juntos.
                        </p>
                    </div>
                </div>
            </div>

            <!-- An√°lisis Experto de Cartera -->
            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden mt-6">
                <div class="p-6 border-b border-gray-700 flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <h3 class="text-lg font-semibold flex items-center gap-2">
                            <span>üß†</span> An√°lisis Experto de Cartera
                        </h3>
                        <p class="text-sm text-gray-400 mt-1">Diagn√≥stico completo con sugerencias de mejora</p>
                    </div>
                    <button onclick="analizarCartera()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm transition flex items-center gap-2">
                        <span>üîç</span> Analizar
                    </button>
                </div>
                <div class="p-6">
                    <div id="analisis-loading" class="hidden text-center py-8">
                        <div class="loader mx-auto mb-4"></div>
                        <p class="text-gray-400">Analizando tu cartera...</p>
                    </div>
                    <div id="analisis-placeholder" class="text-center py-8 text-gray-500">
                        <p>Pulsa "Analizar" para obtener un diagn√≥stico experto de tu cartera</p>
                        <p class="text-sm mt-2">Incluye: diversificaci√≥n, riesgos, sugerencias y activos recomendados</p>
                    </div>
                    <div id="analisis-container" class="hidden space-y-6">
                        <!-- Score General -->
                        <div id="analisis-score" class="text-center p-6 rounded-xl">
                            <!-- Se llena din√°micamente -->
                        </div>
                        
                        <!-- Grid de m√©tricas -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="analisis-metricas">
                            <!-- Se llena din√°micamente -->
                        </div>
                        
                        <!-- Problemas detectados -->
                        <div id="analisis-problemas" class="p-4 rounded-lg">
                            <!-- Se llena din√°micamente -->
                        </div>
                        
                        <!-- Sugerencias -->
                        <div id="analisis-sugerencias" class="p-4 bg-blue-900/20 border border-blue-700/50 rounded-lg">
                            <!-- Se llena din√°micamente -->
                        </div>
                        
                        <!-- Activos recomendados -->
                        <div id="analisis-recomendados" class="p-4 bg-purple-900/20 border border-purple-700/50 rounded-lg">
                            <!-- Se llena din√°micamente -->
                        </div>
                        
                        <!-- Comparaci√≥n con carteras modelo -->
                        <div id="analisis-modelos" class="p-4 bg-gray-700/30 rounded-lg">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-6 max-w-md mx-4 border border-gray-700">
            <h3 class="text-xl font-semibold mb-4">¬øEliminar posici√≥n?</h3>
            <p class="text-gray-400 mb-6">Esta acci√≥n no se puede deshacer.</p>
            <div class="flex gap-4">
                <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                    Cancelar
                </button>
                <button onclick="confirmDelete()" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-6 max-w-md mx-4 border border-gray-700 w-full">
            <h3 class="text-xl font-semibold mb-2">üè∑Ô∏è Asignar Categor√≠a</h3>
            <p class="text-gray-400 text-sm mb-4" id="category-position-name">-</p>
            
            <input type="hidden" id="category-position-id">
            
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-2">Categor√≠a</label>
                <select id="category-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3">
                    <option value="">Sin categor√≠a</option>
                    <!-- Se carga din√°micamente -->
                </select>
            </div>
            
            <div class="flex gap-4">
                <button onclick="closeCategoryModal()" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                    Cancelar
                </button>
                <button onclick="saveCategory()" class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Target Allocation Modal -->
    <div id="target-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-6 max-w-3xl mx-4 border border-gray-700 w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-semibold mb-2">üéØ Configurar Target Allocation</h3>
            <p class="text-gray-400 text-sm mb-4">Define el porcentaje objetivo para cada activo de tu cartera.</p>
            
            <!-- A√±adir activo nuevo -->
            <div class="mb-4 p-3 bg-blue-900/20 border border-blue-800/30 rounded-lg">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-blue-400">‚ûï</span>
                    <span class="text-sm font-medium text-blue-300">A√±adir activo nuevo al objetivo</span>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="nuevo-activo-isin" placeholder="ISIN (ej: IE00BKM4GZ66)" 
                        class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none"
                        onkeypress="if(event.key === 'Enter') buscarNuevoActivo()">
                    <button onclick="buscarNuevoActivo()" id="btn-buscar-nuevo" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm transition flex items-center gap-1">
                        <span id="buscar-nuevo-icon">üîç</span>
                        <span id="buscar-nuevo-loading" class="hidden">
                            <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                        Buscar
                    </button>
                </div>
                <div id="nuevo-activo-info" class="hidden mt-2 p-2 bg-green-900/30 border border-green-700/50 rounded flex items-center justify-between">
                    <div>
                        <div id="nuevo-activo-nombre" class="font-medium text-green-300 text-sm"></div>
                        <div id="nuevo-activo-categoria" class="text-xs text-gray-400"></div>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" id="nuevo-activo-pct" min="1" max="100" value="5" 
                            class="w-16 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-right text-sm">
                        <span class="text-gray-400 text-sm">%</span>
                        <button onclick="agregarNuevoActivo()" class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm">
                            ‚ûï A√±adir
                        </button>
                    </div>
                </div>
                <div id="nuevo-activo-error" class="hidden mt-2 text-xs text-red-400"></div>
            </div>
            
            <!-- Botones de ayuda -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button onclick="usarDistribucionActual()" class="px-3 py-1.5 bg-blue-600/30 hover:bg-blue-600/50 text-blue-300 rounded-lg text-sm transition flex items-center gap-1">
                    <span>üìä</span> Usar actual
                </button>
                <button onclick="distribuirEquitativamente()" class="px-3 py-1.5 bg-purple-600/30 hover:bg-purple-600/50 text-purple-300 rounded-lg text-sm transition flex items-center gap-1">
                    <span>‚öñÔ∏è</span> Equitativo
                </button>
                <button onclick="distribucionRecomendada()" class="px-3 py-1.5 bg-green-600/30 hover:bg-green-600/50 text-green-300 rounded-lg text-sm transition flex items-center gap-1">
                    <span>ü§ñ</span> Recomendada
                </button>
                <button onclick="limpiarTargets()" class="px-3 py-1.5 bg-gray-600/30 hover:bg-gray-600/50 text-gray-300 rounded-lg text-sm transition flex items-center gap-1">
                    <span>üóëÔ∏è</span> Limpiar
                </button>
            </div>
            
            <!-- Cabecera de la tabla -->
            <div class="flex items-center gap-2 mb-2 px-2 text-xs text-gray-500 font-medium">
                <div class="flex-1">ACTIVO</div>
                <div class="w-20 text-center">ACTUAL</div>
                <div class="w-24 text-center">OBJETIVO</div>
                <div class="w-16 text-center">DIFF</div>
                <div class="w-8"></div>
            </div>
            
            <div id="target-inputs" class="space-y-2 mb-4 max-h-[40vh] overflow-y-auto">
                <!-- Se llena din√°micamente -->
            </div>
            
            <!-- Total -->
            <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg mb-4">
                <span class="text-gray-400">Total objetivo:</span>
                <div class="flex items-center gap-4">
                    <span id="target-total" class="font-bold text-xl">0%</span>
                    <span id="target-status" class="text-sm"></span>
                </div>
            </div>
            
            <!-- Leyenda de distribuci√≥n recomendada -->
            <div id="recomendacion-info" class="hidden text-xs text-gray-400 mb-4 p-3 bg-green-900/20 border border-green-800/30 rounded-lg">
                <strong class="text-green-400">ü§ñ Distribuci√≥n recomendada:</strong>
                <ul class="mt-2 space-y-1 ml-4 list-disc">
                    <li><strong>Base diversificada (50-60%):</strong> Fondos globales/indexados</li>
                    <li><strong>Crecimiento (15-25%):</strong> Tecnolog√≠a, Small Caps</li>
                    <li><strong>Protecci√≥n (10-20%):</strong> Oro, materias primas</li>
                    <li><strong>Alto riesgo (5-10%):</strong> Crypto, emergentes</li>
                </ul>
            </div>
            
            <div class="flex gap-4">
                <button onclick="closeTargetModal()" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                    Cancelar
                </button>
                <button onclick="saveTargets()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition font-medium">
                    üíæ Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Goal Modal -->
    <div id="goal-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-6 max-w-md mx-4 border border-gray-700 w-full">
            <h3 class="text-xl font-semibold mb-4">üéØ Nuevo Objetivo de Ahorro</h3>
            
            <input type="hidden" id="goal-edit-id">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Nombre del objetivo</label>
                    <input type="text" id="goal-nombre" placeholder="Ej: Libertad financiera, Casa, Jubilaci√≥n..."
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3">
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Objetivo (‚Ç¨)</label>
                    <input type="number" id="goal-objetivo" placeholder="100000" min="0"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3">
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Fecha objetivo (opcional)</label>
                    <input type="date" id="goal-fecha"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3">
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Icono</label>
                    <div class="flex gap-2 flex-wrap">
                        <button type="button" onclick="selectGoalIcon('üéØ')" class="goal-icon-btn text-2xl p-2 rounded hover:bg-gray-700">üéØ</button>
                        <button type="button" onclick="selectGoalIcon('üè†')" class="goal-icon-btn text-2xl p-2 rounded hover:bg-gray-700">üè†</button>
                        <button type="button" onclick="selectGoalIcon('üöó')" class="goal-icon-btn text-2xl p-2 rounded hover:bg-gray-700">üöó</button>
                        <button type="button" onclick="selectGoalIcon('‚úàÔ∏è')" class="goal-icon-btn text-2xl p-2 rounded hover:bg-gray-700">‚úàÔ∏è</button>
                        <button type="button" onclick="selectGoalIcon('üéì')" class="goal-icon-btn text-2xl p-2 rounded hover:bg-gray-700">üéì</button>
                        <button type="button" onclick="selectGoalIcon('üë∂')" class="goal-icon-btn text-2xl p-2 rounded hover:bg-gray-700">üë∂</button>
                        <button type="button" onclick="selectGoalIcon('üí∞')" class="goal-icon-btn text-2xl p-2 rounded hover:bg-gray-700">üí∞</button>
                        <button type="button" onclick="selectGoalIcon('üèñÔ∏è')" class="goal-icon-btn text-2xl p-2 rounded hover:bg-gray-700">üèñÔ∏è</button>
                        <button type="button" onclick="selectGoalIcon('üíé')" class="goal-icon-btn text-2xl p-2 rounded hover:bg-gray-700">üíé</button>
                        <button type="button" onclick="selectGoalIcon('üî•')" class="goal-icon-btn text-2xl p-2 rounded hover:bg-gray-700">üî•</button>
                    </div>
                    <input type="hidden" id="goal-icono" value="üéØ">
                </div>
            </div>
            
            <div class="flex gap-4 mt-6">
                <button onclick="closeGoalModal()" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                    Cancelar
                </button>
                <button onclick="saveGoal()" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Categories Modal -->
    <div id="categories-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-6 max-w-lg mx-4 border border-gray-700 w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-semibold mb-4">üè∑Ô∏è Gestionar Categor√≠as</h3>
            
            <!-- Crear nueva categor√≠a -->
            <div class="mb-6 p-4 bg-gray-700/50 rounded-lg">
                <h4 class="text-sm font-medium text-gray-300 mb-3">Crear nueva categor√≠a</h4>
                <div class="space-y-3">
                    <div>
                        <input type="text" id="new-category-name" placeholder="Nombre de la categor√≠a (ej: Crypto, Small Caps...)"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                    </div>
                    <div>
                        <input type="text" id="new-category-keywords" placeholder="Palabras clave (separadas por coma): bitcoin, btc, eth..."
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                    </div>
                    <button onclick="createCategory()" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded transition text-sm">
                        + Crear Categor√≠a
                    </button>
                </div>
            </div>
            
            <!-- Lista de categor√≠as -->
            <div class="mb-4">
                <h4 class="text-sm font-medium text-gray-300 mb-3">Categor√≠as existentes</h4>
                <div id="categories-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
            
            <div class="flex gap-4">
                <button onclick="closeCategoriesModal()" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Charts
        let rentabilidadChart = null;
        let distribucionChart = null;
        let beneficiosChart = null;
        let deletePositionId = null;

        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2
            }).format(value);
        }

        // Format percentage
        function formatPercent(value) {
            const sign = value >= 0 ? '+' : '';
            return sign + value.toFixed(2) + '%';
        }

        // Load portfolio data
        async function loadPortfolio() {
            try {
                const response = await fetch('/api/portfolio');
                const result = await response.json();

                document.getElementById('loading').classList.add('hidden');

                if (!result.success) {
                    console.error('Error loading portfolio');
                    return;
                }

                const { resumen, posiciones, last_update } = result.data;

                // Actualizar indicador de √∫ltima actualizaci√≥n
                updateLastUpdateIndicator(last_update);

                if (posiciones.length === 0) {
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }

                document.getElementById('dashboard').classList.remove('hidden');
                updateSummary(resumen);
                updateTable(posiciones);
                loadComparison();

            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateLastUpdateIndicator(lastUpdate) {
            const indicator = document.getElementById('update-indicator');
            const timeEl = document.getElementById('update-time');
            const dotEl = document.getElementById('update-status-dot');
            
            if (!lastUpdate) {
                indicator.classList.add('hidden');
                return;
            }
            
            indicator.classList.remove('hidden');
            
            const updateTime = new Date(lastUpdate);
            const now = new Date();
            const diffMinutes = Math.round((now - updateTime) / 60000);
            
            if (diffMinutes < 1) {
                timeEl.textContent = 'Ahora';
                dotEl.className = 'w-2 h-2 rounded-full bg-green-500';
            } else if (diffMinutes < 60) {
                timeEl.textContent = `Hace ${diffMinutes} min`;
                dotEl.className = diffMinutes < 15 ? 'w-2 h-2 rounded-full bg-green-500' : 'w-2 h-2 rounded-full bg-yellow-500';
            } else {
                const hours = Math.round(diffMinutes / 60);
                timeEl.textContent = `Hace ${hours}h`;
                dotEl.className = 'w-2 h-2 rounded-full bg-red-500';
            }
        }

        async function refreshPrices() {
            const btn = document.getElementById('refresh-btn');
            const icon = document.getElementById('refresh-icon');
            
            btn.disabled = true;
            icon.classList.add('spinning');
            
            try {
                const response = await fetch('/api/cache/refresh', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showToast('Precios actualizados', 'success');
                    // Recargar todo
                    loadPortfolio();
                    loadEvolution();
                    loadBenchmarks();
                    loadReturns();
                    loadMetrics();
                    loadAllocation();
                    loadRebalance();
                } else {
                    showToast('Error actualizando precios', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error de conexi√≥n', 'error');
            }
            
            btn.disabled = false;
            icon.classList.remove('spinning');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Update summary cards
        function updateSummary(resumen) {
            document.getElementById('valor-total').textContent = formatCurrency(resumen.valor_actual);
            document.getElementById('total-invertido').textContent = formatCurrency(resumen.total_invertido);
            
            const beneficioEl = document.getElementById('beneficio');
            const rentabilidadEl = document.getElementById('rentabilidad');
            
            beneficioEl.textContent = (resumen.beneficio_total >= 0 ? '+' : '') + formatCurrency(resumen.beneficio_total);
            beneficioEl.className = 'text-3xl font-bold ' + (resumen.beneficio_total >= 0 ? 'text-green-400' : 'text-red-400');
            
            rentabilidadEl.textContent = formatPercent(resumen.rentabilidad_pct);
            rentabilidadEl.className = 'text-sm mt-1 ' + (resumen.rentabilidad_pct >= 0 ? 'text-green-400' : 'text-red-400');
            
            document.getElementById('num-posiciones').textContent = resumen.num_posiciones;
            document.getElementById('ganadoras').textContent = resumen.posiciones_ganadoras;
            document.getElementById('perdedoras').textContent = resumen.posiciones_perdedoras;
        }

        // Update positions table
        function updateTable(posiciones) {
            const tbody = document.getElementById('positions-table');
            tbody.innerHTML = '';

            posiciones.forEach(pos => {
                const colorClass = pos.beneficio >= 0 ? 'text-green-400' : 'text-red-400';
                const sign = pos.beneficio >= 0 ? '+' : '';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-750 transition';
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-medium">${pos.nombre}</div>
                        <div class="text-sm text-gray-400">${pos.isin}</div>
                        <div class="flex items-center gap-2 mt-1">
                            ${pos.num_aportaciones > 1 ? `<span class="text-xs bg-blue-600/30 text-blue-300 px-2 py-0.5 rounded-full">${pos.num_aportaciones} aportaciones</span>` : ''}
                            ${pos.categoria ? `<span class="text-xs bg-purple-600/30 text-purple-300 px-2 py-0.5 rounded-full">${pos.categoria}</span>` : `<button onclick="showCategoryModal('${pos.id}', '${pos.nombre}')" class="text-xs bg-gray-600/50 text-gray-400 px-2 py-0.5 rounded-full hover:bg-gray-600">+ Categor√≠a</button>`}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div>${pos.cantidad.toFixed(4)}</div>
                        ${pos.num_aportaciones > 1 ? `<div class="text-xs text-gray-400">PM: ${formatCurrency(pos.precio_medio)}</div>` : ''}
                    </td>
                    <td class="px-6 py-4">${formatCurrency(pos.precio_compra)}</td>
                    <td class="px-6 py-4">${formatCurrency(pos.precio_actual)}</td>
                    <td class="px-6 py-4 font-medium">${formatCurrency(pos.valor_actual)}</td>
                    <td class="px-6 py-4 ${colorClass} font-medium">${sign}${formatCurrency(pos.beneficio)}</td>
                    <td class="px-6 py-4 ${colorClass} font-medium">${formatPercent(pos.rentabilidad_pct)}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <button onclick="showCategoryModal('${pos.id}', '${pos.nombre}', '${pos.categoria || ''}')" class="text-purple-400 hover:text-purple-300 transition" title="Editar categor√≠a">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                            </button>
                            <a href="/details?id=${pos.id}" class="text-blue-400 hover:text-blue-300 transition" title="Ver detalles">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </a>
                            <button onclick="showDeleteModal('${pos.id}')" class="text-red-400 hover:text-red-300 transition" title="Eliminar">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load comparison data and render charts
        async function loadComparison() {
            try {
                const response = await fetch('/api/portfolio/comparison');
                const result = await response.json();

                if (!result.success) return;

                const data = result.data;
                renderCharts(data);

            } catch (error) {
                console.error('Error loading comparison:', error);
            }
        }

        // Render all charts
        function renderCharts(data) {
            // Destroy existing charts
            if (rentabilidadChart) rentabilidadChart.destroy();
            if (distribucionChart) distribucionChart.destroy();
            if (beneficiosChart) beneficiosChart.destroy();

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 800,
                    easing: 'easeOutQuart'
                },
                plugins: {
                    legend: {
                        labels: { color: '#9ca3af' }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.95)',
                        titleColor: '#fff',
                        bodyColor: '#9ca3af',
                        borderColor: '#374151',
                        borderWidth: 1,
                        padding: 12
                    }
                }
            };

            // Rentabilidad Chart (Bar horizontal)
            rentabilidadChart = new Chart(document.getElementById('rentabilidad-chart'), {
                type: 'bar',
                data: {
                    labels: data.nombres,
                    datasets: [{
                        label: 'Rentabilidad %',
                        data: data.rentabilidades,
                        backgroundColor: data.colores.map(c => c + 'cc'),
                        borderColor: data.colores,
                        borderWidth: 2,
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: false },
                        tooltip: {
                            ...chartOptions.plugins.tooltip,
                            callbacks: {
                                label: (ctx) => {
                                    const sign = ctx.raw >= 0 ? '+' : '';
                                    return `Rentabilidad: ${sign}${ctx.raw.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#374151' },
                            ticks: { 
                                color: '#9ca3af',
                                callback: (val) => val + '%'
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af' }
                        }
                    },
                    onHover: (event, elements) => {
                        event.native.target.style.cursor = elements.length ? 'pointer' : 'default';
                    }
                }
            });

            // Distribution Chart (Doughnut con animaci√≥n)
            distribucionChart = new Chart(document.getElementById('distribucion-chart'), {
                type: 'doughnut',
                data: {
                    labels: data.nombres,
                    datasets: [{
                        data: data.valores,
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                            '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1'
                        ],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    ...chartOptions,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { 
                                color: '#9ca3af',
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            ...chartOptions.plugins.tooltip,
                            callbacks: {
                                label: (ctx) => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = ((ctx.raw / total) * 100).toFixed(1);
                                    return `${formatCurrency(ctx.raw)} (${pct}%)`;
                                }
                            }
                        }
                    },
                    onHover: (event, elements) => {
                        event.native.target.style.cursor = elements.length ? 'pointer' : 'default';
                    }
                }
            });

            // Beneficios Chart (Bar con gradientes)
            const beneficiosCtx = document.getElementById('beneficios-chart').getContext('2d');
            
            beneficiosChart = new Chart(beneficiosCtx, {
                type: 'bar',
                data: {
                    labels: data.nombres,
                    datasets: [{
                        label: 'Beneficio ‚Ç¨',
                        data: data.beneficios,
                        backgroundColor: data.beneficios.map(b => b >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                        borderColor: data.beneficios.map(b => b >= 0 ? '#10b981' : '#ef4444'),
                        borderWidth: 2,
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: false },
                        tooltip: {
                            ...chartOptions.plugins.tooltip,
                            callbacks: {
                                label: (ctx) => {
                                    const sign = ctx.raw >= 0 ? '+' : '';
                                    return `Beneficio: ${sign}${formatCurrency(ctx.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af' }
                        },
                        y: {
                            grid: { color: '#374151' },
                            ticks: { 
                                color: '#9ca3af',
                                callback: (val) => formatCurrency(val)
                            }
                        }
                    },
                    onHover: (event, elements) => {
                        event.native.target.style.cursor = elements.length ? 'pointer' : 'default';
                    }
                }
            });
        }

        // Delete modal functions
        function showDeleteModal(id) {
            deletePositionId = id;
            document.getElementById('delete-modal').classList.remove('hidden');
            document.getElementById('delete-modal').classList.add('flex');
        }

        function closeDeleteModal() {
            deletePositionId = null;
            document.getElementById('delete-modal').classList.add('hidden');
            document.getElementById('delete-modal').classList.remove('flex');
        }

        async function confirmDelete() {
            if (!deletePositionId) return;

            try {
                const response = await fetch(`/api/position/delete/${deletePositionId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    closeDeleteModal();
                    loadPortfolio();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // =====================
        // EVOLUCI√ìN DE CARTERA
        // =====================
        let evolutionChart = null;
        let myPortfolioReturn = 0;

        async function loadEvolution() {
            const periodo = document.getElementById('evolution-period').value;
            document.getElementById('evolution-loader').classList.remove('hidden');
            document.getElementById('evolution-summary').classList.add('hidden');
            
            try {
                const response = await fetch(`/api/portfolio/evolution?periodo=${periodo}`);
                const result = await response.json();
                
                document.getElementById('evolution-loader').classList.add('hidden');
                
                if (result.success) {
                    renderEvolutionChart(result.data);
                    myPortfolioReturn = result.data.rentabilidad;
                    
                    // Mostrar resumen con stats
                    document.getElementById('evolution-summary').classList.remove('hidden');
                    
                    // Valor al inicio del per√≠odo seleccionado
                    document.getElementById('evolution-inicio').textContent = formatCurrency(result.data.valor_inicial);
                    
                    // Etiqueta seg√∫n per√≠odo
                    const periodoLabels = {
                        '1mo': '1 mes atr√°s',
                        '3mo': '3 meses atr√°s', 
                        '6mo': '6 meses atr√°s',
                        '1y': '1 a√±o atr√°s',
                        '2y': '2 a√±os atr√°s',
                        '5y': '5 a√±os atr√°s',
                        'max': 'Inicio'
                    };
                    document.getElementById('evolution-inicio-label').textContent = periodoLabels[periodo] || 'Inicio per√≠odo';
                    
                    // Valor actual
                    document.getElementById('evolution-actual').textContent = formatCurrency(result.data.valor_final);
                    
                    // Rentabilidad del per√≠odo
                    const rentEl = document.getElementById('evolution-rentabilidad');
                    const sign = result.data.rentabilidad >= 0 ? '+' : '';
                    rentEl.textContent = `${sign}${result.data.rentabilidad.toFixed(2)}%`;
                    rentEl.className = `font-bold ${result.data.rentabilidad >= 0 ? 'text-green-400' : 'text-red-400'}`;
                    
                    // Mostrar fecha de primera compra
                    let infoText = '';
                    if (result.data.fecha_primera_compra) {
                        const fecha = new Date(result.data.fecha_primera_compra);
                        const fechaStr = fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
                        infoText = `Primera inversi√≥n: ${fechaStr}`;
                    }
                    
                    // Advertencia si hay posiciones sin hist√≥rico
                    if (result.data.posiciones_sin_historico && result.data.posiciones_sin_historico.length > 0) {
                        infoText += ` ‚ö†Ô∏è Sin hist√≥rico: ${result.data.posiciones_sin_historico.join(', ')}`;
                    }
                    document.getElementById('evolution-desde').textContent = infoText;
                    
                    // Mostrar rentabilidad total (vs invertido)
                    if (result.data.rentabilidad_total !== undefined) {
                        const signTotal = result.data.rentabilidad_total >= 0 ? '+' : '';
                        const colorTotal = result.data.rentabilidad_total >= 0 ? 'text-green-400' : 'text-red-400';
                        document.getElementById('evolution-total').innerHTML = 
                            `Total vs invertido: <span class="${colorTotal}">${signTotal}${result.data.rentabilidad_total.toFixed(2)}%</span>`;
                    }
                    
                    // Los benchmarks ahora calculan su propia rentabilidad independientemente
                } else {
                    // Mostrar error
                    console.error('Error en evoluci√≥n:', result.error);
                    document.getElementById('evolution-summary').classList.remove('hidden');
                    document.getElementById('evolution-desde').textContent = `‚ö†Ô∏è ${result.error || 'Error cargando datos'}`;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('evolution-loader').classList.add('hidden');
            }
        }

        function renderEvolutionChart(data) {
            if (evolutionChart) evolutionChart.destroy();
            
            const ctx = document.getElementById('evolution-chart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 250);
            
            if (data.rentabilidad >= 0) {
                gradient.addColorStop(0, 'rgba(16, 185, 129, 0.4)');
                gradient.addColorStop(0.5, 'rgba(16, 185, 129, 0.1)');
                gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');
            } else {
                gradient.addColorStop(0, 'rgba(239, 68, 68, 0.4)');
                gradient.addColorStop(0.5, 'rgba(239, 68, 68, 0.1)');
                gradient.addColorStop(1, 'rgba(239, 68, 68, 0)');
            }
            
            // Encontrar min y max para anotaciones
            const minVal = Math.min(...data.valores);
            const maxVal = Math.max(...data.valores);
            const minIdx = data.valores.indexOf(minVal);
            const maxIdx = data.valores.indexOf(maxVal);
            
            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.fechas,
                    datasets: [{
                        label: 'Valor Cartera',
                        data: data.valores,
                        borderColor: data.rentabilidad >= 0 ? '#10b981' : '#ef4444',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: data.rentabilidad >= 0 ? '#10b981' : '#ef4444',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#9ca3af',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            borderColor: '#374151',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                title: (items) => {
                                    const date = new Date(items[0].label);
                                    return date.toLocaleDateString('es-ES', { 
                                        day: 'numeric', 
                                        month: 'short', 
                                        year: 'numeric' 
                                    });
                                },
                                label: (ctx) => {
                                    const value = ctx.raw;
                                    const initial = data.valores[0];
                                    const change = ((value - initial) / initial) * 100;
                                    const sign = change >= 0 ? '+' : '';
                                    return [
                                        `Valor: ${formatCurrency(value)}`,
                                        `Cambio: ${sign}${change.toFixed(2)}%`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#9ca3af',
                                maxTicksLimit: 6,
                                callback: function(value, index) {
                                    const date = new Date(this.getLabelForValue(value));
                                    return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                                }
                            }
                        },
                        y: {
                            grid: { color: '#374151' },
                            ticks: { 
                                color: '#9ca3af',
                                callback: (val) => formatCurrency(val)
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        // =====================
        // BENCHMARKS
        // =====================
        async function loadBenchmarks() {
            const periodo = document.getElementById('benchmark-period').value;
            document.getElementById('benchmark-loader').classList.remove('hidden');
            document.getElementById('benchmark-data').classList.add('hidden');
            
            try {
                const response = await fetch(`/api/benchmarks?periodo=${periodo}`);
                const result = await response.json();
                
                document.getElementById('benchmark-loader').classList.add('hidden');
                document.getElementById('benchmark-data').classList.remove('hidden');
                
                if (result.success) {
                    // Usar la rentabilidad calculada espec√≠ficamente para este per√≠odo
                    const miRentabilidad = result.mi_cartera ? result.mi_cartera.rentabilidad : 0;
                    renderBenchmarks(result.data, miRentabilidad);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('benchmark-loader').classList.add('hidden');
            }
        }

        function updateMyPortfolioReturn() {
            // Esta funci√≥n ya no se usa para benchmarks, 
            // se mantiene solo por si se necesita en otro lugar
            const el = document.getElementById('my-portfolio-return');
            const sign = myPortfolioReturn >= 0 ? '+' : '';
            el.textContent = `${sign}${myPortfolioReturn.toFixed(2)}%`;
            el.className = `font-bold text-xl ${myPortfolioReturn >= 0 ? 'text-green-400' : 'text-red-400'}`;
        }

        function renderBenchmarks(data, miRentabilidadPeriodo) {
            // Actualizar "Tu Cartera" con la rentabilidad del per√≠odo de benchmarks
            const el = document.getElementById('my-portfolio-return');
            const sign = miRentabilidadPeriodo >= 0 ? '+' : '';
            el.textContent = `${sign}${miRentabilidadPeriodo.toFixed(2)}%`;
            el.className = `font-bold text-xl ${miRentabilidadPeriodo >= 0 ? 'text-green-400' : 'text-red-400'}`;
            
            const container = document.getElementById('benchmark-list');
            container.innerHTML = '';
            
            const benchmarks = Object.entries(data);
            benchmarks.forEach(([key, info]) => {
                const diff = miRentabilidadPeriodo - info.rentabilidad;
                const isWinning = diff > 0;
                const sign = info.rentabilidad >= 0 ? '+' : '';
                const diffSign = diff >= 0 ? '+' : '';
                
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-700/30 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>${info.nombre}</span>
                    </div>
                    <div class="text-right">
                        <span class="${info.rentabilidad >= 0 ? 'text-green-400' : 'text-red-400'} font-medium">
                            ${sign}${info.rentabilidad}%
                        </span>
                        <span class="text-xs ml-2 px-2 py-1 rounded ${isWinning ? 'bg-green-900/50 text-green-300' : 'bg-red-900/50 text-red-300'}">
                            ${isWinning ? '‚úì' : '‚úó'} ${diffSign}${diff.toFixed(1)}%
                        </span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // =====================
        // CATEGOR√çAS
        // =====================
        let categoriesChart = null;

        async function showCategoryModal(positionId, positionName, currentCategory = '') {
            document.getElementById('category-position-id').value = positionId;
            document.getElementById('category-position-name').textContent = positionName;
            
            // Cargar categor√≠as din√°micamente (incluyendo custom)
            const select = document.getElementById('category-select');
            select.innerHTML = '<option value="">Sin categor√≠a</option>';
            
            try {
                const response = await fetch('/api/categories/list');
                const result = await response.json();
                
                if (result.success && result.data) {
                    result.data.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        if (cat === currentCategory) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error cargando categor√≠as:', error);
            }
            
            document.getElementById('category-modal').classList.remove('hidden');
            document.getElementById('category-modal').classList.add('flex');
        }

        function closeCategoryModal() {
            document.getElementById('category-modal').classList.add('hidden');
            document.getElementById('category-modal').classList.remove('flex');
        }

        async function saveCategory() {
            const positionId = document.getElementById('category-position-id').value;
            const categoria = document.getElementById('category-select').value;
            
            try {
                const response = await fetch(`/api/position/update/${positionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoria })
                });
                const result = await response.json();
                
                if (result.success) {
                    closeCategoryModal();
                    loadPortfolio();
                    loadCategories();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function autoAssignCategories() {
            const btn = document.getElementById('auto-assign-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loader w-3 h-3"></div> Detectando...';
            
            try {
                const response = await fetch('/api/categories/auto-assign', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    if (result.asignadas > 0) {
                        alert(`‚úÖ ${result.message}`);
                        loadPortfolio();
                        loadCategories();
                    } else {
                        alert('‚ÑπÔ∏è Todas las posiciones ya tienen categor√≠a asignada');
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
            }
            
            btn.disabled = false;
            btn.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg> Auto-detectar`;
        }

        async function loadCategories() {
            document.getElementById('categories-loader').classList.remove('hidden');
            document.getElementById('categories-table-loader').classList.remove('hidden');
            document.getElementById('categories-table').classList.add('hidden');
            
            try {
                const response = await fetch('/api/portfolio/categories');
                const result = await response.json();
                
                document.getElementById('categories-loader').classList.add('hidden');
                document.getElementById('categories-table-loader').classList.add('hidden');
                
                if (result.success) {
                    renderCategoriesChart(result.data);
                    renderCategoriesTable(result.data);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('categories-loader').classList.add('hidden');
                document.getElementById('categories-table-loader').classList.add('hidden');
            }
        }

        function renderCategoriesChart(data) {
            if (categoriesChart) categoriesChart.destroy();
            
            const labels = Object.keys(data);
            const valores = labels.map(k => data[k].valor);
            
            const colors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1'
            ];
            
            categoriesChart = new Chart(document.getElementById('categories-chart'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: valores,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { 
                                color: '#9ca3af',
                                padding: 10,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const cat = data[ctx.label];
                                    return `${formatCurrency(cat.valor)} (${cat.peso}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCategoriesTable(data) {
            const container = document.getElementById('categories-table');
            container.classList.remove('hidden');
            container.innerHTML = '';
            
            const sorted = Object.entries(data).sort((a, b) => b[1].peso - a[1].peso);
            
            sorted.forEach(([cat, info]) => {
                const rentColor = info.rentabilidad >= 0 ? 'text-green-400' : 'text-red-400';
                const rentSign = info.rentabilidad >= 0 ? '+' : '';
                
                const div = document.createElement('div');
                div.className = 'p-3 bg-gray-700/30 rounded-lg';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">${cat}</span>
                        <span class="${rentColor} font-medium">${rentSign}${info.rentabilidad.toFixed(1)}%</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-400">
                        <span>${info.num_posiciones} posici√≥n(es)</span>
                        <span>${formatCurrency(info.valor)} (${info.peso}%)</span>
                    </div>
                    <div class="mt-2 bg-gray-600 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" style="width: ${info.peso}%"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadPortfolio();
            loadEvolution();
            loadBenchmarks();
            loadCategories();
            loadPositionsComparison();
            loadReturns();
            loadAllocation();
            loadMetrics();
            loadGeography();
            loadRebalance();
            loadGoals();
            initSimulator();
            cargarSankey();
        });

        // =====================
        // RENTABILIDAD POR PER√çODO
        // =====================
        async function loadReturns() {
            document.getElementById('returns-loader').classList.remove('hidden');
            document.getElementById('returns-grid').classList.add('hidden');
            
            try {
                const response = await fetch('/api/portfolio/returns');
                const result = await response.json();
                
                document.getElementById('returns-loader').classList.add('hidden');
                document.getElementById('returns-grid').classList.remove('hidden');
                
                if (result.success) {
                    renderReturns(result.data.periodos);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('returns-loader').classList.add('hidden');
            }
        }

        function renderReturns(periodos) {
            const container = document.getElementById('returns-grid');
            container.innerHTML = '';
            
            // Orden de per√≠odos
            const orden = ['diaria', 'semanal', 'mensual', '30d', '90d', 'ytd', 'total'];
            
            for (const key of orden) {
                if (!periodos[key]) continue;
                
                const p = periodos[key];
                const rentColor = p.rentabilidad >= 0 ? 'text-green-400' : 'text-red-400';
                const bgColor = p.rentabilidad >= 0 ? 'bg-green-900/20 border-green-800/30' : 'bg-red-900/20 border-red-800/30';
                const sign = p.rentabilidad >= 0 ? '+' : '';
                const changeSign = p.cambio >= 0 ? '+' : '';
                
                const div = document.createElement('div');
                div.className = `${bgColor} border rounded-lg p-3 text-center`;
                div.innerHTML = `
                    <div class="text-xs text-gray-400 mb-1">${p.label}</div>
                    <div class="${rentColor} font-bold text-lg">${sign}${p.rentabilidad.toFixed(2)}%</div>
                    <div class="text-xs text-gray-500">${changeSign}${formatCurrency(p.cambio)}</div>
                `;
                container.appendChild(div);
            }
        }

        // =====================
        // TARGET ALLOCATION
        // =====================
        let currentTargets = {};

        async function loadAllocation() {
            document.getElementById('allocation-loader').classList.remove('hidden');
            document.getElementById('allocation-content').classList.add('hidden');
            
            try {
                const response = await fetch('/api/portfolio/allocation');
                const result = await response.json();
                
                document.getElementById('allocation-loader').classList.add('hidden');
                document.getElementById('allocation-content').classList.remove('hidden');
                
                if (result.success) {
                    if (!result.data.tiene_objetivos) {
                        document.getElementById('allocation-no-targets').classList.remove('hidden');
                        document.getElementById('allocation-grid').classList.add('hidden');
                    } else {
                        document.getElementById('allocation-no-targets').classList.add('hidden');
                        document.getElementById('allocation-grid').classList.remove('hidden');
                        renderAllocation(result.data.allocation);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('allocation-loader').classList.add('hidden');
            }
        }

        function renderAllocation(allocation) {
            const container = document.getElementById('allocation-grid');
            container.innerHTML = '';
            
            allocation.forEach(item => {
                if (item.peso_objetivo === 0 && item.peso_actual === 0) return;
                
                let statusIcon, statusColor, statusBg;
                switch (item.estado) {
                    case 'ok':
                        statusIcon = '‚úì';
                        statusColor = 'text-green-400';
                        statusBg = 'bg-green-900/20';
                        break;
                    case 'sobreponderado':
                        statusIcon = '‚Üë';
                        statusColor = 'text-yellow-400';
                        statusBg = 'bg-yellow-900/20';
                        break;
                    case 'infraponderado':
                        statusIcon = '‚Üì';
                        statusColor = 'text-red-400';
                        statusBg = 'bg-red-900/20';
                        break;
                    default:
                        statusIcon = '‚óã';
                        statusColor = 'text-gray-400';
                        statusBg = 'bg-gray-700/30';
                }
                
                const ajusteText = item.ajuste > 0 
                    ? `Comprar ${formatCurrency(item.ajuste)}` 
                    : item.ajuste < 0 
                        ? `Vender ${formatCurrency(Math.abs(item.ajuste))}` 
                        : 'OK';
                
                // Nombre corto para activos
                const nombre = item.categoria || item.nombre || 'Sin nombre';
                const nombreCorto = nombre.length > 25 ? nombre.substring(0, 25) + '...' : nombre;
                
                const div = document.createElement('div');
                div.className = `${statusBg} rounded-lg p-4`;
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2 min-w-0 flex-1">
                            <span class="${statusColor} text-lg flex-shrink-0">${statusIcon}</span>
                            <span class="font-medium truncate" title="${nombre}">${nombreCorto}</span>
                        </div>
                        <div class="text-right flex-shrink-0 ml-2">
                            <span class="${statusColor} font-bold">${item.peso_actual.toFixed(1)}%</span>
                            <span class="text-gray-500"> / ${item.peso_objetivo}%</span>
                        </div>
                    </div>
                    <div class="relative h-2 bg-gray-700 rounded-full overflow-hidden mb-2">
                        <div class="absolute h-full bg-gray-500 opacity-50" style="width: ${item.peso_objetivo}%"></div>
                        <div class="absolute h-full ${item.estado === 'ok' ? 'bg-green-500' : item.estado === 'sobreponderado' ? 'bg-yellow-500' : 'bg-red-500'}" style="width: ${Math.min(item.peso_actual, 100)}%"></div>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-400">${formatCurrency(item.valor)}</span>
                        <span class="${statusColor}">${item.estado !== 'sin_objetivo' ? ajusteText : ''}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Modal de Target Allocation
        let posicionesCartera = []; // Guardar info de posiciones actuales
        let activosNuevos = {}; // Activos a√±adidos que no est√°n en cartera {isin: {nombre, categoria, precio}}
        let valorTotalCartera = 0;
        
        async function showTargetModal() {
            // Cargar targets actuales por posici√≥n
            const responseTargets = await fetch('/api/targets/positions');
            const resultTargets = await responseTargets.json();
            currentTargets = resultTargets.success ? resultTargets.data : {};
            
            // Cargar activos nuevos guardados
            if (resultTargets.nuevosActivos) {
                activosNuevos = resultTargets.nuevosActivos;
            }
            
            // Cargar posiciones de la cartera
            const responsePortfolio = await fetch('/api/portfolio');
            const resultPortfolio = await responsePortfolio.json();
            
            // Limpiar b√∫squeda de nuevo activo
            document.getElementById('nuevo-activo-isin').value = '';
            document.getElementById('nuevo-activo-info').classList.add('hidden');
            document.getElementById('nuevo-activo-error').classList.add('hidden');
            
            renderTargetInputs(resultPortfolio);
            
            document.getElementById('target-modal').classList.remove('hidden');
            document.getElementById('target-modal').classList.add('flex');
        }
        
        function renderTargetInputs(resultPortfolio) {
            const container = document.getElementById('target-inputs');
            container.innerHTML = '';
            
            // Primero procesar posiciones de cartera
            if (resultPortfolio && resultPortfolio.success && resultPortfolio.data.posiciones && resultPortfolio.data.posiciones.length > 0) {
                posicionesCartera = resultPortfolio.data.posiciones;
                valorTotalCartera = resultPortfolio.data.valor_total || posicionesCartera.reduce((sum, p) => sum + (p.valor_actual || 0), 0);
                
                // Ordenar por valor (mayor primero)
                posicionesCartera.sort((a, b) => (b.valor_actual || 0) - (a.valor_actual || 0));
                posicionesCartera.sort((a, b) => (b.valor_actual || 0) - (a.valor_actual || 0));
                
                // Crear filas para cada activo en cartera
                posicionesCartera.forEach(pos => {
                    const pctActual = valorTotalCartera > 0 ? ((pos.valor_actual || 0) / valorTotalCartera * 100) : 0;
                    const key = pos.isin || pos.id;
                    const targetValue = currentTargets[key] || 0;
                    
                    agregarFilaTarget(container, {
                        key: key,
                        nombre: pos.nombre,
                        categoria: pos.categoria,
                        pctActual: pctActual,
                        targetValue: targetValue,
                        enCartera: true
                    });
                });
                
                // A√±adir activos en targets que NO est√°n en cartera (activos nuevos/planificados)
                Object.keys(currentTargets).forEach(isin => {
                    const yaEnCartera = posicionesCartera.some(p => (p.isin || p.id) === isin);
                    if (!yaEnCartera && activosNuevos[isin]) {
                        agregarFilaTarget(container, {
                            key: isin,
                            nombre: activosNuevos[isin].nombre,
                            categoria: activosNuevos[isin].categoria,
                            pctActual: 0,
                            targetValue: currentTargets[isin],
                            enCartera: false,
                            precio: activosNuevos[isin].precio
                        });
                    }
                });
            } else {
                // Si no hay posiciones en cartera, igual mostrar activos nuevos
                Object.keys(currentTargets).forEach(isin => {
                    if (activosNuevos[isin]) {
                        agregarFilaTarget(container, {
                            key: isin,
                            nombre: activosNuevos[isin].nombre,
                            categoria: activosNuevos[isin].categoria,
                            pctActual: 0,
                            targetValue: currentTargets[isin],
                            enCartera: false,
                            precio: activosNuevos[isin].precio
                        });
                    }
                });
                
                if (Object.keys(activosNuevos).length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <div class="text-4xl mb-2">üìä</div>
                            <p>A√±ade posiciones a tu cartera o busca activos nuevos arriba.</p>
                        </div>
                    `;
                }
            }
            
            updateTargetTotal();
            document.getElementById('recomendacion-info').classList.add('hidden');
        }
        
        function agregarFilaTarget(container, data) {
            const { key, nombre, categoria, pctActual, targetValue, enCartera, precio } = data;
            
            const diff = targetValue > 0 ? (pctActual - targetValue).toFixed(1) : '-';
            const diffColor = targetValue > 0 ? (
                Math.abs(pctActual - targetValue) <= 2 ? 'text-green-400' :
                Math.abs(pctActual - targetValue) <= 5 ? 'text-yellow-400' : 'text-red-400'
            ) : 'text-gray-500';
            
            const nombreCorto = nombre.length > 35 ? nombre.substring(0, 35) + '...' : nombre;
            
            const catColors = {
                'Tecnolog√≠a': 'bg-purple-500',
                'Global/Diversificado': 'bg-blue-500',
                'Oro/Materias Primas': 'bg-yellow-500',
                'Crypto': 'bg-orange-500',
                'Small Caps': 'bg-green-500',
                'Renta Fija': 'bg-gray-500',
                'Mercados Emergentes': 'bg-teal-500'
            };
            const catColor = catColors[categoria] || 'bg-gray-500';
            
            const div = document.createElement('div');
            div.className = `flex items-center gap-2 p-2 rounded-lg hover:bg-gray-700/50 transition ${enCartera ? 'bg-gray-700/30' : 'bg-green-900/20 border border-green-700/30'}`;
            div.id = `target-row-${key.replace(/[^a-zA-Z0-9]/g, '_')}`;
            
            div.innerHTML = `
                <div class="w-1 h-10 ${catColor} rounded-full"></div>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-sm truncate flex items-center gap-2" title="${nombre}">
                        ${nombreCorto}
                        ${!enCartera ? '<span class="px-1.5 py-0.5 bg-green-600/50 text-green-300 text-xs rounded">NUEVO</span>' : ''}
                    </div>
                    <div class="text-xs text-gray-500">${categoria || 'Sin categor√≠a'} ${precio ? '‚Ä¢ ' + precio.toFixed(2) + '‚Ç¨' : ''}</div>
                </div>
                <div class="w-20 text-center">
                    <span class="text-gray-400 font-mono text-sm">${pctActual.toFixed(1)}%</span>
                </div>
                <div class="w-24 flex items-center justify-center gap-1">
                    <input type="number" min="0" max="100" step="1" value="${targetValue}" 
                        data-key="${key}"
                        data-actual="${pctActual}"
                        data-categoria="${categoria || ''}"
                        data-en-cartera="${enCartera}"
                        data-precio="${precio || 0}"
                        onchange="updateTargetTotal()"
                        oninput="updateTargetTotal()"
                        class="w-16 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-right text-sm target-input focus:border-blue-500 outline-none">
                    <span class="text-gray-400 text-xs">%</span>
                </div>
                <div class="w-16 text-center">
                    <span class="${diffColor} font-mono text-xs" id="diff-${key.replace(/[^a-zA-Z0-9]/g, '_')}">${diff !== '-' ? (diff > 0 ? '+' : '') + diff + '%' : '-'}</span>
                </div>
                <div class="w-8">
                    ${!enCartera ? `<button onclick="eliminarActivoNuevo('${key}')" class="text-red-400 hover:text-red-300 text-sm" title="Eliminar">üóëÔ∏è</button>` : ''}
                </div>
            `;
            container.appendChild(div);
        }
        
        // Buscar nuevo activo por ISIN
        let nuevoActivoData = null;
        
        async function buscarNuevoActivo() {
            const isin = document.getElementById('nuevo-activo-isin').value.trim().toUpperCase();
            if (!isin) return;
            
            // Verificar si ya est√° en la cartera
            if (posicionesCartera.some(p => p.isin === isin)) {
                document.getElementById('nuevo-activo-error').textContent = 'Este activo ya est√° en tu cartera. Ajusta su % objetivo arriba.';
                document.getElementById('nuevo-activo-error').classList.remove('hidden');
                document.getElementById('nuevo-activo-info').classList.add('hidden');
                return;
            }
            
            // Mostrar loading
            document.getElementById('buscar-nuevo-icon').classList.add('hidden');
            document.getElementById('buscar-nuevo-loading').classList.remove('hidden');
            document.getElementById('nuevo-activo-error').classList.add('hidden');
            document.getElementById('nuevo-activo-info').classList.add('hidden');
            
            try {
                const response = await fetch(`/api/historical/${isin}?period=1d`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    nuevoActivoData = {
                        isin: isin,
                        nombre: result.data.nombre || isin,
                        categoria: detectarCategoria(result.data.nombre || ''),
                        precio: result.data.precio_actual || result.data.precios?.[result.data.precios.length - 1]?.close || 0
                    };
                    
                    document.getElementById('nuevo-activo-nombre').textContent = nuevoActivoData.nombre;
                    document.getElementById('nuevo-activo-categoria').textContent = `${nuevoActivoData.categoria} ‚Ä¢ ${nuevoActivoData.precio.toFixed(2)}‚Ç¨`;
                    document.getElementById('nuevo-activo-info').classList.remove('hidden');
                } else {
                    document.getElementById('nuevo-activo-error').textContent = 'No se encontr√≥ el activo. Verifica el ISIN.';
                    document.getElementById('nuevo-activo-error').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('nuevo-activo-error').textContent = 'Error al buscar el activo.';
                document.getElementById('nuevo-activo-error').classList.remove('hidden');
            }
            
            document.getElementById('buscar-nuevo-icon').classList.remove('hidden');
            document.getElementById('buscar-nuevo-loading').classList.add('hidden');
        }
        
        function detectarCategoria(nombre) {
            const n = nombre.toLowerCase();
            if (n.includes('emerging') || n.includes('em ') || n.includes('emergentes')) return 'Mercados Emergentes';
            if (n.includes('gold') || n.includes('oro') || n.includes('commodity')) return 'Oro/Materias Primas';
            if (n.includes('tech') || n.includes('nasdaq') || n.includes('technology')) return 'Tecnolog√≠a';
            if (n.includes('small') || n.includes('russell')) return 'Small Caps';
            if (n.includes('crypto') || n.includes('bitcoin') || n.includes('ethereum')) return 'Crypto';
            if (n.includes('bond') || n.includes('treasury') || n.includes('renta fija')) return 'Renta Fija';
            if (n.includes('world') || n.includes('global') || n.includes('msci') || n.includes('all')) return 'Global/Diversificado';
            return 'Otros';
        }
        
        async function agregarNuevoActivo() {
            if (!nuevoActivoData) return;
            
            const pct = parseFloat(document.getElementById('nuevo-activo-pct').value) || 5;
            
            // Guardar en activosNuevos
            activosNuevos[nuevoActivoData.isin] = {
                nombre: nuevoActivoData.nombre,
                categoria: nuevoActivoData.categoria,
                precio: nuevoActivoData.precio
            };
            
            // A√±adir a currentTargets
            currentTargets[nuevoActivoData.isin] = pct;
            
            // A√±adir fila al container
            const container = document.getElementById('target-inputs');
            agregarFilaTarget(container, {
                key: nuevoActivoData.isin,
                nombre: nuevoActivoData.nombre,
                categoria: nuevoActivoData.categoria,
                pctActual: 0,
                targetValue: pct,
                enCartera: false,
                precio: nuevoActivoData.precio
            });
            
            // Limpiar formulario
            document.getElementById('nuevo-activo-isin').value = '';
            document.getElementById('nuevo-activo-info').classList.add('hidden');
            nuevoActivoData = null;
            
            updateTargetTotal();
        }
        
        function eliminarActivoNuevo(isin) {
            delete activosNuevos[isin];
            delete currentTargets[isin];
            
            const row = document.getElementById(`target-row-${isin.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (row) row.remove();
            
            updateTargetTotal();
        }

        function closeTargetModal() {
            document.getElementById('target-modal').classList.add('hidden');
            document.getElementById('target-modal').classList.remove('flex');
        }

        function updateTargetTotal() {
            const inputs = document.querySelectorAll('.target-input');
            let total = 0;
            
            inputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                const actual = parseFloat(input.dataset.actual) || 0;
                const key = input.dataset.key;
                total += value;
                
                // Actualizar diff
                const diffEl = document.getElementById('diff-' + key.replace(/[^a-zA-Z0-9]/g, '_'));
                if (diffEl && value > 0) {
                    const diff = (actual - value).toFixed(1);
                    diffEl.textContent = (diff > 0 ? '+' : '') + diff + '%';
                    diffEl.className = 'font-mono text-xs ' + (
                        Math.abs(diff) <= 2 ? 'text-green-400' :
                        Math.abs(diff) <= 5 ? 'text-yellow-400' : 'text-red-400'
                    );
                } else if (diffEl) {
                    diffEl.textContent = '-';
                    diffEl.className = 'font-mono text-xs text-gray-500';
                }
            });
            
            const totalEl = document.getElementById('target-total');
            const statusEl = document.getElementById('target-status');
            
            totalEl.textContent = `${total.toFixed(0)}%`;
            
            if (total === 100) {
                totalEl.className = 'font-bold text-xl text-green-400';
                statusEl.textContent = '‚úÖ Perfecto';
                statusEl.className = 'text-sm text-green-400';
            } else if (total > 100) {
                totalEl.className = 'font-bold text-xl text-red-400';
                statusEl.textContent = `‚ö†Ô∏è Sobra ${(total - 100).toFixed(0)}%`;
                statusEl.className = 'text-sm text-red-400';
            } else {
                totalEl.className = 'font-bold text-xl text-yellow-400';
                statusEl.textContent = `‚ö†Ô∏è Falta ${(100 - total).toFixed(0)}%`;
                statusEl.className = 'text-sm text-yellow-400';
            }
        }
        
        function usarDistribucionActual() {
            const inputs = document.querySelectorAll('.target-input');
            inputs.forEach(input => {
                const actual = parseFloat(input.dataset.actual) || 0;
                input.value = Math.round(actual);
            });
            updateTargetTotal();
            document.getElementById('recomendacion-info').classList.add('hidden');
        }
        
        function distribuirEquitativamente() {
            const inputs = document.querySelectorAll('.target-input');
            const numActivos = inputs.length;
            if (numActivos === 0) return;
            
            const valorBase = Math.floor(100 / numActivos);
            const resto = 100 - (valorBase * numActivos);
            
            inputs.forEach((input, index) => {
                input.value = valorBase + (index < resto ? 1 : 0);
            });
            updateTargetTotal();
            document.getElementById('recomendacion-info').classList.add('hidden');
        }
        
        function distribucionRecomendada() {
            // Estrategia recomendada basada en categor√≠as
            const inputs = document.querySelectorAll('.target-input');
            
            // Definir pesos por categor√≠a
            const pesosRecomendados = {
                'Global/Diversificado': 50,  // Base diversificada
                'Tecnolog√≠a': 15,            // Crecimiento
                'Small Caps': 10,            // Crecimiento
                'Oro/Materias Primas': 15,   // Protecci√≥n
                'Crypto': 5,                 // Alto riesgo
                'Renta Fija': 5,             // Estabilidad
                'Mercados Emergentes': 5,    // Diversificaci√≥n
                'default': 5
            };
            
            // Agrupar activos por categor√≠a
            const porCategoria = {};
            inputs.forEach(input => {
                const cat = input.dataset.categoria || 'default';
                if (!porCategoria[cat]) porCategoria[cat] = [];
                porCategoria[cat].push(input);
            });
            
            // Asignar pesos
            let totalAsignado = 0;
            const asignaciones = [];
            
            Object.entries(porCategoria).forEach(([cat, inputsCategoria]) => {
                const pesoCategoria = pesosRecomendados[cat] || pesosRecomendados['default'];
                const pesoPorActivo = Math.floor(pesoCategoria / inputsCategoria.length);
                
                inputsCategoria.forEach((input, idx) => {
                    let peso = pesoPorActivo;
                    // El primer activo de cada categor√≠a se lleva el resto
                    if (idx === 0) {
                        peso += pesoCategoria - (pesoPorActivo * inputsCategoria.length);
                    }
                    asignaciones.push({ input, peso });
                    totalAsignado += peso;
                });
            });
            
            // Ajustar para que sume 100
            if (totalAsignado !== 100 && asignaciones.length > 0) {
                const diff = 100 - totalAsignado;
                // A√±adir/quitar del activo m√°s grande (Global/Diversificado normalmente)
                const mayor = asignaciones.reduce((max, a) => a.peso > max.peso ? a : max, asignaciones[0]);
                mayor.peso += diff;
            }
            
            // Aplicar
            asignaciones.forEach(({ input, peso }) => {
                input.value = Math.max(0, peso);
            });
            
            updateTargetTotal();
            document.getElementById('recomendacion-info').classList.remove('hidden');
        }
        
        function limpiarTargets() {
            const inputs = document.querySelectorAll('.target-input');
            inputs.forEach(input => {
                input.value = 0;
            });
            updateTargetTotal();
            document.getElementById('recomendacion-info').classList.add('hidden');
        }

        async function saveTargets() {
            const inputs = document.querySelectorAll('.target-input');
            const targets = {};
            const nuevosActivos = {};
            
            inputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                const key = input.dataset.key;
                const enCartera = input.dataset.enCartera === 'true';
                
                if (value > 0) {
                    targets[key] = value;
                    
                    // Si es un activo nuevo, guardar sus datos
                    if (!enCartera && activosNuevos[key]) {
                        nuevosActivos[key] = {
                            nombre: activosNuevos[key].nombre,
                            categoria: activosNuevos[key].categoria || input.dataset.categoria,
                            precio: parseFloat(input.dataset.precio) || activosNuevos[key].precio
                        };
                    }
                }
            });
            
            try {
                // Guardar targets por posici√≥n
                const response = await fetch('/api/targets/positions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targets, nuevosActivos })
                });
                const result = await response.json();
                
                if (result.success) {
                    closeTargetModal();
                    loadAllocation();
                    loadRebalance();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // =====================
        // M√âTRICAS AVANZADAS
        // =====================
        async function loadMetrics() {
            document.getElementById('metrics-loader').classList.remove('hidden');
            document.getElementById('metrics-content').classList.add('hidden');
            
            try {
                const response = await fetch('/api/portfolio/metrics');
                const result = await response.json();
                
                document.getElementById('metrics-loader').classList.add('hidden');
                
                if (result.success) {
                    document.getElementById('metrics-content').classList.remove('hidden');
                    renderMetrics(result.data);
                } else {
                    document.getElementById('metrics-content').innerHTML = `
                        <div class="text-center py-4 text-gray-400">
                            <p>${result.error || 'Error cargando m√©tricas'}</p>
                        </div>
                    `;
                    document.getElementById('metrics-content').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('metrics-loader').classList.add('hidden');
            }
        }

        function renderMetrics(data) {
            // Volatilidad
            const volColor = data.volatilidad.interpretacion === 'Baja' ? 'text-green-400' : 
                            data.volatilidad.interpretacion === 'Media' ? 'text-yellow-400' : 'text-red-400';
            document.getElementById('metric-volatilidad').textContent = `${data.volatilidad.valor}%`;
            document.getElementById('metric-volatilidad').className = `text-xl font-bold ${volColor}`;
            document.getElementById('metric-volatilidad-int').textContent = data.volatilidad.interpretacion;
            document.getElementById('metric-volatilidad-int').className = `text-xs mt-1 ${volColor}`;
            
            // Max Drawdown
            const ddColor = data.max_drawdown.interpretacion === 'Bajo' ? 'text-green-400' : 
                           data.max_drawdown.interpretacion === 'Moderado' ? 'text-yellow-400' : 'text-red-400';
            document.getElementById('metric-drawdown').textContent = `-${data.max_drawdown.valor}%`;
            document.getElementById('metric-drawdown').className = `text-xl font-bold ${ddColor}`;
            document.getElementById('metric-drawdown-int').textContent = data.max_drawdown.interpretacion;
            document.getElementById('metric-drawdown-int').className = `text-xs mt-1 ${ddColor}`;
            
            // Sharpe Ratio
            const shColor = data.sharpe_ratio.interpretacion === 'Excelente' ? 'text-green-400' : 
                           data.sharpe_ratio.interpretacion === 'Bueno' ? 'text-blue-400' : 
                           data.sharpe_ratio.interpretacion === 'Bajo' ? 'text-yellow-400' : 'text-red-400';
            document.getElementById('metric-sharpe').textContent = data.sharpe_ratio.valor;
            document.getElementById('metric-sharpe').className = `text-xl font-bold ${shColor}`;
            document.getElementById('metric-sharpe-int').textContent = data.sharpe_ratio.interpretacion;
            document.getElementById('metric-sharpe-int').className = `text-xs mt-1 ${shColor}`;
            
            // Mejor y peor d√≠a
            document.getElementById('metric-mejor-dia').textContent = `+${data.mejor_dia}%`;
            document.getElementById('metric-peor-dia').textContent = `${data.peor_dia}%`;
            
            // D√≠as positivos/negativos
            document.getElementById('metric-dias-pos').textContent = `${data.dias_positivos} (${data.ratio_dias}%)`;
            document.getElementById('metric-dias-neg').textContent = `${data.dias_negativos}`;
        }

        // =====================
        // EXPOSICI√ìN GEOGR√ÅFICA
        // =====================
        // Variable del mapa eliminada - ahora se declara en renderGeography

        async function loadGeography() {
            document.getElementById('geography-loader').classList.remove('hidden');
            document.getElementById('geography-content').classList.add('hidden');
            
            try {
                const response = await fetch('/api/portfolio/geography');
                const result = await response.json();
                
                document.getElementById('geography-loader').classList.add('hidden');
                
                if (result.success) {
                    document.getElementById('geography-content').classList.remove('hidden');
                    renderGeography(result.data);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('geography-loader').classList.add('hidden');
            }
        }

        let worldMapChart = null;
        
        function renderGeography(data) {
            const exposicion = data.exposicion;
            
            // Colores para el mapa y lista
            const geoColors = {
                'USA': '#3b82f6',
                'Europa': '#10b981',
                'Jap√≥n': '#f59e0b',
                'UK': '#ef4444',
                'China': '#ec4899',
                'Emergentes': '#8b5cf6',
                'Global': '#6366f1',
                'Alemania': '#14b8a6',
                'Espa√±a': '#f97316',
                'Taiw√°n': '#06b6d4',
                'India': '#a855f7',
                'Corea': '#22c55e',
                'Brasil': '#eab308',
                'Canada': '#0ea5e9',
                'Mexico': '#84cc16',
                'Australia': '#f43f5e',
                'Rusia': '#64748b',
                'Africa': '#78716c'
            };
            
            // Mapeo de nombres de pa√≠s a c√≥digos ISO
            const paisToISO = {
                'USA': 'US',
                'Europa': ['DE', 'FR', 'IT', 'ES', 'NL', 'BE', 'AT', 'PT', 'IE', 'FI', 'SE', 'DK', 'NO', 'CH', 'PL', 'CZ', 'HU', 'GR'],
                'Jap√≥n': 'JP',
                'UK': 'GB',
                'China': 'CN',
                'Alemania': 'DE',
                'Espa√±a': 'ES',
                'Taiw√°n': 'TW',
                'India': 'IN',
                'Corea': 'KR',
                'Brasil': 'BR',
                'Canada': 'CA',
                'Mexico': 'MX',
                'Australia': 'AU',
                'Rusia': 'RU',
                'Global': null,
                'Emergentes': ['CN', 'IN', 'BR', 'MX', 'ZA', 'ID', 'TH', 'MY', 'PH', 'VN'],
                'Africa': ['ZA', 'EG', 'NG', 'KE', 'MA']
            };
            
            const defaultColors = ['#64748b', '#475569', '#334155', '#1e293b'];
            const colors = exposicion.map((e, i) => geoColors[e.pais] || defaultColors[i % defaultColors.length]);
            
            // ==================
            // MAPA MUNDIAL CON AMCHARTS
            // ==================
            
            // Limpiar mapa anterior
            if (worldMapChart) {
                worldMapChart.dispose();
            }
            
            // Crear ra√≠z del mapa
            const root = am5.Root.new("world-map");
            
            // Aplicar tema oscuro
            root.setThemes([am5themes_Dark.new(root)]);
            
            // Crear mapa
            const chart = root.container.children.push(
                am5map.MapChart.new(root, {
                    panX: "translateX",
                    panY: "translateY",
                    projection: am5map.geoNaturalEarth1(),
                    homeZoomLevel: 1,
                    homeGeoPoint: { longitude: 10, latitude: 30 },
                    minZoomLevel: 1,
                    maxZoomLevel: 10
                })
            );
            
            // A√±adir pa√≠ses base (gris)
            const polygonSeries = chart.series.push(
                am5map.MapPolygonSeries.new(root, {
                    geoJSON: am5geodata_worldLow,
                    exclude: ["AQ"] // Excluir Ant√°rtida
                })
            );
            
            polygonSeries.mapPolygons.template.setAll({
                fill: am5.color(0x374151),
                strokeWidth: 0.5,
                stroke: am5.color(0x1f2937),
                tooltipText: "{name}",
                interactive: true
            });
            
            polygonSeries.mapPolygons.template.states.create("hover", {
                fill: am5.color(0x4b5563)
            });
            
            // Crear datos para colorear pa√≠ses
            const countryData = [];
            const exposicionMap = {};
            
            exposicion.forEach((item, index) => {
                const color = colors[index];
                exposicionMap[item.pais] = {
                    porcentaje: item.porcentaje,
                    valor: item.valor,
                    color: color
                };
                
                const isoCodes = paisToISO[item.pais];
                if (isoCodes) {
                    if (Array.isArray(isoCodes)) {
                        // M√∫ltiples pa√≠ses (Europa, Emergentes, etc.)
                        isoCodes.forEach(iso => {
                            countryData.push({
                                id: iso,
                                value: item.porcentaje,
                                fill: am5.color(color),
                                pais: item.pais,
                                porcentaje: item.porcentaje,
                                valor: item.valor
                            });
                        });
                    } else {
                        // Un solo pa√≠s
                        countryData.push({
                            id: isoCodes,
                            value: item.porcentaje,
                            fill: am5.color(color),
                            pais: item.pais,
                            porcentaje: item.porcentaje,
                            valor: item.valor
                        });
                    }
                }
            });
            
            // Aplicar colores a los pa√≠ses
            polygonSeries.mapPolygons.template.adapters.add("fill", function(fill, target) {
                const dataItem = countryData.find(d => d.id === target.dataItem.get("id"));
                if (dataItem) {
                    return dataItem.fill;
                }
                return fill;
            });
            
            // Tooltip personalizado
            polygonSeries.mapPolygons.template.adapters.add("tooltipText", function(text, target) {
                const id = target.dataItem.get("id");
                const dataItem = countryData.find(d => d.id === id);
                if (dataItem) {
                    return `[bold]${dataItem.pais}[/]\n${dataItem.porcentaje.toFixed(1)}% ¬∑ ‚Ç¨${dataItem.valor.toLocaleString()}`;
                }
                return "{name}";
            });
            
            // Zoom con rueda del rat√≥n
            chart.set("zoomControl", am5map.ZoomControl.new(root, {}));
            
            // Guardar referencia
            worldMapChart = root;
            
            // ==================
            // LISTA DE PA√çSES
            // ==================
            
            const listContainer = document.getElementById('geography-list');
            listContainer.innerHTML = '';
            
            exposicion.forEach((item, index) => {
                const color = colors[index];
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-700/30 rounded px-2 py-1';
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full" style="background-color: ${color}"></span>
                        <span class="text-gray-300">${item.pais}</span>
                    </div>
                    <div class="text-right">
                        <span class="font-semibold">${item.porcentaje.toFixed(1)}%</span>
                        <span class="text-gray-500 text-xs ml-1">${formatCurrency(item.valor)}</span>
                    </div>
                `;
                listContainer.appendChild(div);
            });
        }

        // =====================
        // DIAGRAMA SANKEY DE DIVERSIFICACI√ìN
        // =====================
        
        let sankeyChartLoaded = false;
        let sankeyDataCache = null;
        
        // Cargar Google Charts
        google.charts.load('current', {'packages':['sankey']});
        google.charts.setOnLoadCallback(function() {
            sankeyChartLoaded = true;
        });
        
        async function cargarSankey() {
            const loader = document.getElementById('sankey-loader');
            const content = document.getElementById('sankey-content');
            const empty = document.getElementById('sankey-empty');
            
            loader.classList.remove('hidden');
            content.classList.add('hidden');
            empty.classList.add('hidden');
            
            try {
                const response = await fetch('/api/portfolio/sankey');
                const result = await response.json();
                
                if (!result.success || !result.data.sankey || result.data.sankey.length < 2) {
                    loader.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }
                
                sankeyDataCache = result.data;
                
                // Esperar a que Google Charts est√© listo
                if (!sankeyChartLoaded) {
                    await new Promise(resolve => {
                        const checkInterval = setInterval(() => {
                            if (sankeyChartLoaded) {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                // Ajustar altura del contenedor seg√∫n recomendaci√≥n del API
                const alturaRecomendada = result.data.altura_recomendada || 380;
                document.getElementById('sankey-chart').style.height = alturaRecomendada + 'px';
                
                // Llenar el resumen
                document.getElementById('sankey-valor-total').textContent = formatCurrency(result.data.valor_total);
                document.getElementById('sankey-num-categorias').textContent = result.data.num_categorias;
                document.getElementById('sankey-num-posiciones').textContent = result.data.num_posiciones;
                
                // Llenar categor√≠as con badges
                const categoriasContainer = document.getElementById('sankey-categorias');
                categoriasContainer.innerHTML = '';
                
                const coloresCat = {
                    'Global/Diversificado': 'bg-blue-500/20 text-blue-400 border-blue-500/30',
                    'Oro/Materias Primas': 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
                    'Tecnolog√≠a': 'bg-green-500/20 text-green-400 border-green-500/30',
                    'Mercados Emergentes': 'bg-purple-500/20 text-purple-400 border-purple-500/30',
                    'Small Caps': 'bg-pink-500/20 text-pink-400 border-pink-500/30',
                    'Crypto': 'bg-orange-500/20 text-orange-400 border-orange-500/30',
                    'Renta Fija': 'bg-cyan-500/20 text-cyan-400 border-cyan-500/30',
                    'Inmobiliario': 'bg-lime-500/20 text-lime-400 border-lime-500/30',
                    'Dividendos': 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'
                };
                
                result.data.resumen.forEach(cat => {
                    const colorClass = coloresCat[cat.categoria] || 'bg-gray-500/20 text-gray-400 border-gray-500/30';
                    const badge = document.createElement('span');
                    badge.className = `px-3 py-1 rounded-full text-xs font-medium border ${colorClass}`;
                    badge.innerHTML = `${cat.categoria} <span class="font-bold">${cat.porcentaje}%</span> <span class="opacity-60">(${cat.num_posiciones})</span>`;
                    categoriasContainer.appendChild(badge);
                });
                
                // Mostrar contenido primero
                loader.classList.add('hidden');
                content.classList.remove('hidden');
                
                // Esperar un frame para que el contenedor tenga dimensiones correctas
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        renderSankeyGoogle(result.data.sankey, result.data.altura_recomendada);
                    }, 50);
                });
                
            } catch (error) {
                console.error('Error cargando Sankey:', error);
                loader.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        function renderSankeyGoogle(sankeyDataArray, alturaRecomendada) {
            const container = document.getElementById('sankey-chart');
            if (!container || container.offsetWidth === 0) {
                // Si el contenedor no tiene ancho, reintentar
                setTimeout(() => renderSankeyGoogle(sankeyDataArray, alturaRecomendada), 100);
                return;
            }
            
            const containerWidth = container.offsetWidth;
            const isMobile = containerWidth < 500;
            const isSmallMobile = containerWidth < 380;
            
            // Ajustar altura seg√∫n dispositivo
            let altura = alturaRecomendada || 380;
            if (isMobile) {
                altura = Math.max(altura, 450); // M√°s altura en m√≥vil para que quepa mejor
            }
            
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'From');
            data.addColumn('string', 'To');
            data.addColumn('number', 'Weight');
            
            // En m√≥vil, acortar nombres largos
            const processedData = sankeyDataArray.map(row => {
                let from = row[0];
                let to = row[1];
                
                if (isMobile) {
                    // Acortar nombres > 20 caracteres
                    const maxLen = isSmallMobile ? 15 : 20;
                    if (from.length > maxLen) {
                        from = from.substring(0, maxLen - 2) + '..';
                    }
                    if (to.length > maxLen) {
                        to = to.substring(0, maxLen - 2) + '..';
                    }
                }
                
                return [from, to, row[2]];
            });
            
            data.addRows(processedData);
            
            // Colores personalizados para las categor√≠as
            const colores = {
                'Portfolio': '#6366f1',
                'Global/Diversificado': '#3b82f6',
                'Oro/Materias Primas': '#f59e0b',
                'Tecnolog√≠a': '#10b981',
                'Mercados Emergentes': '#8b5cf6',
                'Small Caps': '#ec4899',
                'Crypto': '#f97316',
                'Renta Fija': '#06b6d4',
                'Inmobiliario': '#84cc16',
                'Dividendos': '#22c55e',
                'Financials': '#0ea5e9',
                'Energy': '#eab308',
                'Healthcare': '#ef4444',
                'Consumer': '#a855f7',
                'Industrials': '#14b8a6',
                'Utilities': '#64748b',
                'Technology': '#10b981',
                'Communication Services': '#f43f5e',
                'Materials': '#78716c',
                'Real Estate': '#84cc16',
                'Tabaco/Consumo': '#f59e0b',
                'Telecomunicaciones': '#06b6d4',
                'REITs/Inmobiliario': '#84cc16',
                'Ocio/Cruceros': '#ec4899',
                'BDC/Financiero': '#0ea5e9',
                'Energ√≠a/Petr√≥leo': '#eab308',
                'Consumo/Bebidas': '#a855f7',
                'Consumo B√°sico': '#22c55e',
                'Servicios Financieros': '#3b82f6',
                'Petroqu√≠mica': '#78716c',
                'REITs/Salud': '#ef4444',
                'Otros': '#6b7280'
            };
            
            // Generar colores para los nodos bas√°ndose en el nombre base (sin porcentaje)
            const nodeColors = [];
            const uniqueNodes = new Set();
            processedData.forEach(row => {
                uniqueNodes.add(row[0]);
                uniqueNodes.add(row[1]);
            });
            
            uniqueNodes.forEach(node => {
                // Extraer nombre base sin el porcentaje
                const nombreBase = node.replace(/\s*\([^)]*\)\s*$/, '').replace(/\.\.$/,'').trim();
                const color = colores[nombreBase] || colores[node] || '#4b5563';
                nodeColors.push(color);
            });
            
            // Ajustar tama√±os seg√∫n dispositivo
            const fontSize = isSmallMobile ? 9 : (isMobile ? 10 : 11);
            const nodePadding = isSmallMobile ? 8 : (isMobile ? 10 : 12);
            const nodeWidth = isSmallMobile ? 10 : (isMobile ? 12 : 15);
            
            const options = {
                height: altura,
                sankey: {
                    node: {
                        colors: nodeColors,
                        label: {
                            fontName: 'Inter',
                            fontSize: fontSize,
                            color: '#ffffff',
                            bold: true
                        },
                        nodePadding: nodePadding,
                        width: nodeWidth,
                        interactivity: true
                    },
                    link: {
                        colorMode: 'gradient',
                        colors: nodeColors
                    },
                    iterations: 64
                },
                tooltip: {
                    isHtml: true,
                    textStyle: {
                        fontName: 'Inter',
                        fontSize: 12
                    }
                },
                backgroundColor: 'transparent'
            };
            
            const chart = new google.visualization.Sankey(container);
            chart.draw(data, options);
        }

        // =====================
        // CALCULADORA DE REBALANCEO
        // =====================
        // =====================
        // REBALANCEO AUTOM√ÅTICO
        // =====================
        
        function cambiarModoRebalanceo() {
            const modo = document.querySelector('input[name="rebalance-modo"]:checked').value;
            if (modo === 'aportacion') {
                document.getElementById('rebalance-aportacion-section').classList.remove('hidden');
                document.getElementById('rebalance-puro-section').classList.add('hidden');
            } else {
                document.getElementById('rebalance-aportacion-section').classList.add('hidden');
                document.getElementById('rebalance-puro-section').classList.remove('hidden');
            }
        }
        
        async function calcularRebalanceo() {
            const modo = document.querySelector('input[name="rebalance-modo"]:checked').value;
            const aportacion = modo === 'aportacion' ? (parseFloat(document.getElementById('rebalance-aportacion').value) || 0) : 0;
            const soloCompras = modo === 'aportacion';
            
            document.getElementById('rebalance-loader').classList.remove('hidden');
            document.getElementById('rebalance-result').classList.add('hidden');
            document.getElementById('rebalance-no-targets').classList.add('hidden');
            
            try {
                const response = await fetch('/api/portfolio/rebalance/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ aportacion: aportacion, solo_compras: soloCompras })
                });
                const result = await response.json();
                
                document.getElementById('rebalance-loader').classList.add('hidden');
                
                if (result.success) {
                    renderRebalanceoCalculado(result.data, modo);
                } else {
                    document.getElementById('rebalance-no-targets').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('rebalance-loader').classList.add('hidden');
                document.getElementById('rebalance-no-targets').classList.remove('hidden');
            }
        }

        function renderRebalanceoCalculado(data, modo) {
            document.getElementById('rebalance-result').classList.remove('hidden');
            
            // Mostrar/ocultar cajas seg√∫n modo
            const aportacionBox = document.getElementById('reb-aportacion-box');
            const venderBox = document.getElementById('reb-vender-box');
            
            if (modo === 'puro') {
                aportacionBox.classList.add('hidden');
                venderBox.classList.remove('hidden');
            } else {
                aportacionBox.classList.remove('hidden');
                venderBox.classList.add('hidden');
            }
            
            // Resumen
            document.getElementById('reb-valor-actual').textContent = formatCurrency(data.valor_actual);
            document.getElementById('reb-aportacion').textContent = formatCurrency(data.aportacion);
            document.getElementById('reb-invertir').textContent = formatCurrency(data.total_a_comprar || data.total_a_invertir);
            document.getElementById('reb-vender').textContent = formatCurrency(data.total_a_vender || 0);
            document.getElementById('reb-sobrante').textContent = formatCurrency(data.sobrante);
            
            // Lista de ventas (solo en modo puro)
            const ventasSection = document.getElementById('rebalance-ventas');
            const ventasList = document.getElementById('rebalance-ventas-list');
            
            if (data.ventas && data.ventas.length > 0) {
                ventasSection.classList.remove('hidden');
                ventasList.innerHTML = data.ventas.map(venta => {
                    if (!venta.importe_redondeado || venta.importe_redondeado <= 0) return '';
                    return `
                        <div class="bg-red-900/20 border border-red-800/30 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-red-400 font-bold">üì§ VENDER</span>
                                        <span class="px-2 py-0.5 bg-gray-700 rounded text-xs">${venta.categoria}</span>
                                    </div>
                                    <div class="font-medium text-white">${venta.nombre}</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${venta.isin || ''} ${venta.ticker ? '‚Ä¢ ' + venta.ticker : ''}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-red-400">${venta.unidades_redondeadas}</div>
                                    <div class="text-xs text-gray-400">participaciones</div>
                                    <div class="text-sm text-gray-300 mt-1">
                                        √ó ${formatCurrency(venta.precio_actual)} = <strong class="text-red-400">${formatCurrency(venta.importe_redondeado)}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                ventasSection.classList.add('hidden');
            }
            
            // Lista de compras
            const comprasContainer = document.getElementById('rebalance-compras');
            const compras = data.compras || [];
            
            if (compras.length === 0 || compras.every(c => !c.importe_redondeado || c.importe_redondeado <= 0)) {
                comprasContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-400">
                        <span class="text-2xl">‚úÖ</span>
                        <p class="mt-2">¬°Tu cartera ya est√° equilibrada!</p>
                    </div>
                `;
            } else {
                comprasContainer.innerHTML = compras.map(compra => {
                    if (!compra.importe_redondeado || compra.importe_redondeado <= 0) return '';
                    
                    return `
                        <div class="bg-green-900/20 border border-green-800/30 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-green-400 font-bold">üì• COMPRAR</span>
                                        <span class="px-2 py-0.5 bg-gray-700 rounded text-xs">${compra.categoria}</span>
                                    </div>
                                    <div class="font-medium text-white">${compra.nombre}</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${compra.isin || ''} ${compra.ticker ? '‚Ä¢ ' + compra.ticker : ''}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-green-400">${compra.unidades_redondeadas}</div>
                                    <div class="text-xs text-gray-400">participaciones</div>
                                    <div class="text-sm text-gray-300 mt-1">
                                        √ó ${formatCurrency(compra.precio_actual)} = <strong class="text-green-400">${formatCurrency(compra.importe_redondeado)}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Guardar datos para copiar
            generarTextoOrdenes(data);
            
            // Comparativa antes/despu√©s
            const comparativaContainer = document.getElementById('rebalance-comparativa');
            comparativaContainer.innerHTML = data.nueva_distribucion.map(dist => {
                const colorAntes = getColorDesviacion(dist.pct_antes, dist.pct_objetivo);
                const colorDespues = getColorDesviacion(dist.pct_despues, dist.pct_objetivo);
                const flechaMejora = dist.mejora < 0 ? '‚úÖ' : (dist.mejora > 0 ? '‚ö†Ô∏è' : '‚û°Ô∏è');
                
                return `
                    <div class="flex items-center gap-3 p-2 rounded bg-gray-700/30">
                        <div class="w-32 font-medium truncate">${dist.categoria}</div>
                        <div class="flex-1 flex items-center gap-2">
                            <div class="text-right w-16">
                                <span class="${colorAntes} font-mono">${dist.pct_antes.toFixed(1)}%</span>
                            </div>
                            <span class="text-gray-500">‚Üí</span>
                            <div class="w-16">
                                <span class="${colorDespues} font-mono font-bold">${dist.pct_despues.toFixed(1)}%</span>
                            </div>
                            <div class="w-20 text-center">
                                <span class="text-xs text-gray-500">(obj: ${dist.pct_objetivo}%)</span>
                            </div>
                            <span>${flechaMejora}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getColorDesviacion(actual, objetivo) {
            const diff = Math.abs(actual - objetivo);
            if (diff <= 2) return 'text-green-400';
            if (diff <= 5) return 'text-yellow-400';
            return 'text-red-400';
        }
        
        function generarTextoOrdenes(data) {
            let texto = 'üìã √ìRDENES DE REBALANCEO\n';
            texto += '=' .repeat(40) + '\n\n';
            texto += `üìÖ Fecha: ${new Date().toLocaleDateString('es-ES')}\n`;
            texto += `üíº Valor cartera: ${formatCurrency(data.valor_actual)}\n`;
            if (data.aportacion > 0) {
                texto += `üí∞ Aportaci√≥n: ${formatCurrency(data.aportacion)}\n`;
            }
            texto += '\n';
            
            // Ventas
            if (data.ventas && data.ventas.length > 0) {
                texto += 'üîª VENTAS:\n';
                texto += '-'.repeat(40) + '\n';
                data.ventas.forEach(v => {
                    if (v.importe_redondeado > 0) {
                        texto += `‚Ä¢ ${v.nombre}\n`;
                        texto += `  VENDER ${v.unidades_redondeadas} uds √ó ${v.precio_actual.toFixed(2)}‚Ç¨ = ${v.importe_redondeado.toFixed(2)}‚Ç¨\n`;
                        if (v.isin) texto += `  ISIN: ${v.isin}\n`;
                        texto += '\n';
                    }
                });
            }
            
            // Compras
            if (data.compras && data.compras.length > 0) {
                texto += 'üî∫ COMPRAS:\n';
                texto += '-'.repeat(40) + '\n';
                data.compras.forEach(c => {
                    if (c.importe_redondeado > 0) {
                        texto += `‚Ä¢ ${c.nombre}\n`;
                        texto += `  COMPRAR ${c.unidades_redondeadas} uds √ó ${c.precio_actual.toFixed(2)}‚Ç¨ = ${c.importe_redondeado.toFixed(2)}‚Ç¨\n`;
                        if (c.isin) texto += `  ISIN: ${c.isin}\n`;
                        texto += '\n';
                    }
                });
            }
            
            texto += '=' .repeat(40) + '\n';
            texto += `üíµ Total a invertir: ${formatCurrency(data.total_a_comprar || data.total_a_invertir)}\n`;
            if (data.sobrante > 0) {
                texto += `üí∞ Sobrante: ${formatCurrency(data.sobrante)}\n`;
            }
            
            document.getElementById('ordenes-texto').value = texto;
        }
        
        function copiarOrdenes() {
            const texto = document.getElementById('ordenes-texto').value;
            navigator.clipboard.writeText(texto).then(() => {
                // Mostrar confirmaci√≥n
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>‚úÖ</span> ¬°Copiado!';
                btn.classList.add('bg-green-600');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-600');
                }, 2000);
            }).catch(err => {
                console.error('Error al copiar:', err);
                alert('No se pudo copiar. Texto:\n\n' + texto);
            });
        }
        
        // Verificar desviaciones al cargar
        async function verificarDesviaciones() {
            try {
                const response = await fetch('/api/portfolio/desviaciones');
                const result = await response.json();
                
                if (result.success && result.data.alertas && result.data.alertas.length > 0) {
                    mostrarAlertasDesviacion(result.data.alertas);
                }
            } catch (error) {
                console.error('Error verificando desviaciones:', error);
            }
        }
        
        function mostrarAlertasDesviacion(alertas) {
            const container = document.getElementById('desviacion-alertas');
            const lista = document.getElementById('desviacion-lista');
            
            lista.innerHTML = alertas.map(a => {
                const icon = a.tipo === 'sobreponderado' ? 'üìà' : 'üìâ';
                const color = a.tipo === 'sobreponderado' ? 'text-red-400' : 'text-blue-400';
                const bgColor = a.tipo === 'sobreponderado' ? 'bg-red-900/20' : 'bg-blue-900/20';
                
                return `
                    <div class="${bgColor} rounded-lg p-3 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">${icon}</span>
                            <div>
                                <span class="font-medium">${a.categoria}</span>
                                <span class="text-gray-400 mx-2">est√°</span>
                                <span class="${color} font-bold">${a.tipo === 'sobreponderado' ? 'sobreponderada' : 'infraponderada'}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="${color} font-mono font-bold">${a.actual.toFixed(1)}%</div>
                            <div class="text-xs text-gray-500">objetivo: ${a.objetivo}%</div>
                            <div class="text-xs ${color}">${a.diferencia > 0 ? '+' : ''}${a.diferencia.toFixed(1)}%</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.classList.remove('hidden');
        }
        
        // Compatibilidad con funci√≥n antigua
        async function loadRebalance() {
            verificarDesviaciones();
        }

        // =====================
        // SIMULADOR WHAT IF
        // =====================
        let simulationChart = null;

        function initSimulator() {
            // Pre-cargar con valor actual de la cartera
            const valorActual = document.getElementById('valor-total')?.textContent;
            if (valorActual && valorActual !== '0 ‚Ç¨') {
                const valor = parseFloat(valorActual.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
                document.getElementById('sim-capital').value = Math.round(valor);
            }
        }

        async function runSimulation() {
            const capital = parseFloat(document.getElementById('sim-capital').value) || 0;
            const aportacion = parseFloat(document.getElementById('sim-aportacion').value) || 0;
            const anos = parseInt(document.getElementById('sim-anos').value) || 10;
            const rentabilidad = parseFloat(document.getElementById('sim-rentabilidad').value) || 7;
            
            try {
                const response = await fetch('/api/simulator/projection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        capital_inicial: capital,
                        aportacion_mensual: aportacion,
                        anos: anos,
                        rentabilidad_anual: rentabilidad
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('sim-result').classList.remove('hidden');
                    renderSimulation(result.data);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderSimulation(data) {
            const { proyeccion, resumen, escenarios } = data;
            
            // Renderizar gr√°fico
            const ctx = document.getElementById('simulation-chart').getContext('2d');
            
            if (simulationChart) {
                simulationChart.destroy();
            }
            
            // Filtrar solo puntos anuales para el gr√°fico
            const puntosAnuales = proyeccion.filter(p => p.label !== null);
            
            simulationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: puntosAnuales.map(p => p.label),
                    datasets: [
                        {
                            label: 'Valor proyectado',
                            data: puntosAnuales.map(p => p.valor),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Total aportado',
                            data: puntosAnuales.map(p => p.aportado),
                            borderColor: '#6b7280',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#9ca3af', boxWidth: 12, font: { size: 10 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#9ca3af', font: { size: 10 } }, grid: { color: '#374151' } },
                        y: { 
                            ticks: { 
                                color: '#9ca3af',
                                callback: value => formatCurrency(value)
                            }, 
                            grid: { color: '#374151' } 
                        }
                    }
                }
            });
            
            // Escenarios
            document.getElementById('sim-pesimista').textContent = formatCurrency(escenarios.pesimista.valor_final);
            document.getElementById('sim-esperado').textContent = formatCurrency(escenarios.esperado.valor_final);
            document.getElementById('sim-optimista').textContent = formatCurrency(escenarios.optimista.valor_final);
            
            // Resumen
            document.getElementById('sim-aportado').textContent = formatCurrency(resumen.total_aportado);
            document.getElementById('sim-beneficio').textContent = formatCurrency(resumen.beneficio);
        }

        // =====================
        // OBJETIVOS DE AHORRO
        // =====================
        let selectedGoalIcon = 'üéØ';

        async function loadGoals() {
            document.getElementById('goals-loader').classList.remove('hidden');
            document.getElementById('goals-content').classList.add('hidden');
            
            try {
                const response = await fetch('/api/goals');
                const result = await response.json();
                
                document.getElementById('goals-loader').classList.add('hidden');
                document.getElementById('goals-content').classList.remove('hidden');
                
                if (result.success) {
                    renderGoals(result.data);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('goals-loader').classList.add('hidden');
            }
        }

        function renderGoals(goals) {
            const container = document.getElementById('goals-list');
            const emptyState = document.getElementById('goals-empty');
            
            if (goals.length === 0) {
                emptyState.classList.remove('hidden');
                container.classList.add('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            container.classList.remove('hidden');
            container.innerHTML = '';
            
            goals.forEach(goal => {
                const progreso = Math.min(goal.progreso, 100);
                
                let statusColor, statusBg, statusText;
                switch (goal.estado) {
                    case 'completado':
                        statusColor = 'text-green-400';
                        statusBg = 'bg-green-900/20 border-green-800/30';
                        statusText = '‚úÖ Completado';
                        break;
                    case 'en_camino':
                        statusColor = 'text-blue-400';
                        statusBg = 'bg-blue-900/20 border-blue-800/30';
                        statusText = 'üìà En camino';
                        break;
                    case 'retrasado':
                        statusColor = 'text-yellow-400';
                        statusBg = 'bg-yellow-900/20 border-yellow-800/30';
                        statusText = '‚ö†Ô∏è Retrasado';
                        break;
                    case 'vencido':
                        statusColor = 'text-red-400';
                        statusBg = 'bg-red-900/20 border-red-800/30';
                        statusText = '‚ùå Vencido';
                        break;
                    default:
                        statusColor = 'text-gray-400';
                        statusBg = 'bg-gray-700/30';
                        statusText = '‚è≥ En progreso';
                }
                
                const div = document.createElement('div');
                div.className = `${statusBg} border rounded-lg p-4`;
                div.innerHTML = `
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${goal.icono || 'üéØ'}</span>
                            <div>
                                <div class="font-medium">${goal.nombre}</div>
                                <div class="text-xs ${statusColor}">${statusText}</div>
                            </div>
                        </div>
                        <button onclick="deleteGoal('${goal.id}')" class="text-gray-500 hover:text-red-400 text-sm">‚úï</button>
                    </div>
                    
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-400">${formatCurrency(goal.valor_actual)} / ${formatCurrency(goal.objetivo)}</span>
                            <span class="${statusColor} font-bold">${progreso.toFixed(1)}%</span>
                        </div>
                        <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full ${goal.estado === 'completado' ? 'bg-green-500' : 'bg-blue-500'} transition-all duration-500" 
                                style="width: ${progreso}%"></div>
                        </div>
                    </div>
                    
                    ${goal.fecha_objetivo ? `
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>Faltan ${goal.meses_restantes || 0} meses</span>
                            ${goal.ahorro_mensual_necesario > 0 ? `
                                <span>Necesitas ${formatCurrency(goal.ahorro_mensual_necesario)}/mes</span>
                            ` : ''}
                        </div>
                    ` : ''}
                `;
                container.appendChild(div);
            });
        }

        function showGoalModal() {
            document.getElementById('goal-edit-id').value = '';
            document.getElementById('goal-nombre').value = '';
            document.getElementById('goal-objetivo').value = '';
            document.getElementById('goal-fecha').value = '';
            selectGoalIcon('üéØ');
            
            document.getElementById('goal-modal').classList.remove('hidden');
            document.getElementById('goal-modal').classList.add('flex');
        }

        function closeGoalModal() {
            document.getElementById('goal-modal').classList.add('hidden');
            document.getElementById('goal-modal').classList.remove('flex');
        }

        function selectGoalIcon(icon) {
            selectedGoalIcon = icon;
            document.getElementById('goal-icono').value = icon;
            
            // Resaltar el seleccionado
            document.querySelectorAll('.goal-icon-btn').forEach(btn => {
                btn.classList.remove('bg-gray-600', 'ring-2', 'ring-blue-500');
                if (btn.textContent.trim() === icon) {
                    btn.classList.add('bg-gray-600', 'ring-2', 'ring-blue-500');
                }
            });
        }

        async function saveGoal() {
            const nombre = document.getElementById('goal-nombre').value.trim();
            const objetivo = parseFloat(document.getElementById('goal-objetivo').value) || 0;
            const fecha = document.getElementById('goal-fecha').value;
            const icono = document.getElementById('goal-icono').value || 'üéØ';
            const editId = document.getElementById('goal-edit-id').value;
            
            if (!nombre || objetivo <= 0) {
                alert('Introduce un nombre y un objetivo v√°lido');
                return;
            }
            
            try {
                const url = editId ? `/api/goals/${editId}` : '/api/goals';
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nombre,
                        objetivo,
                        fecha_objetivo: fecha || null,
                        icono
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    closeGoalModal();
                    loadGoals();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function deleteGoal(goalId) {
            if (!confirm('¬øEliminar este objetivo?')) return;
            
            try {
                const response = await fetch(`/api/goals/${goalId}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (result.success) {
                    loadGoals();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // =====================
        // CATEGOR√çAS PERSONALIZADAS
        // =====================
        
        async function showCategoriesModal() {
            document.getElementById('new-category-name').value = '';
            document.getElementById('new-category-keywords').value = '';
            
            document.getElementById('categories-modal').classList.remove('hidden');
            document.getElementById('categories-modal').classList.add('flex');
            
            await loadCategoriesList();
        }

        function closeCategoriesModal() {
            document.getElementById('categories-modal').classList.add('hidden');
            document.getElementById('categories-modal').classList.remove('flex');
        }

        async function loadCategoriesList() {
            const container = document.getElementById('categories-list');
            container.innerHTML = '<div class="text-center py-4 text-gray-400">Cargando...</div>';
            
            try {
                // Obtener todas las categor√≠as
                const catResponse = await fetch('/api/categories/list');
                const catResult = await catResponse.json();
                
                // Obtener categor√≠as custom con keywords
                const customResponse = await fetch('/api/categories/custom');
                const customResult = await customResponse.json();
                
                const categorias = catResult.data || [];
                const customData = customResult.data || { categories: [], keywords: {} };
                
                container.innerHTML = '';
                
                categorias.forEach(cat => {
                    const isCustom = customData.categories.includes(cat);
                    const keywords = customData.keywords[cat] || [];
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-gray-700/30 rounded-lg';
                    div.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="font-medium">${cat}</span>
                                ${isCustom ? '<span class="text-xs bg-blue-600/30 text-blue-300 px-2 py-0.5 rounded-full">Custom</span>' : ''}
                            </div>
                            ${keywords.length > 0 ? `
                                <div class="text-xs text-gray-500 mt-1">
                                    Keywords: ${keywords.join(', ')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editCategoryKeywords('${cat}')" 
                                class="text-gray-400 hover:text-blue-400 text-sm" title="Editar keywords">
                                ‚úèÔ∏è
                            </button>
                            ${isCustom ? `
                                <button onclick="deleteCategory('${cat}')" 
                                    class="text-gray-400 hover:text-red-400 text-sm" title="Eliminar">
                                    üóëÔ∏è
                                </button>
                            ` : ''}
                        </div>
                    `;
                    container.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = '<div class="text-center py-4 text-red-400">Error cargando categor√≠as</div>';
            }
        }

        async function createCategory() {
            const nombre = document.getElementById('new-category-name').value.trim();
            const keywordsStr = document.getElementById('new-category-keywords').value.trim();
            
            if (!nombre) {
                showToast('Introduce un nombre para la categor√≠a', 'error');
                return;
            }
            
            const keywords = keywordsStr ? keywordsStr.split(',').map(k => k.trim()).filter(k => k) : [];
            
            try {
                const response = await fetch('/api/categories/custom', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre, keywords })
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast(`Categor√≠a "${nombre}" creada`, 'success');
                    document.getElementById('new-category-name').value = '';
                    document.getElementById('new-category-keywords').value = '';
                    loadCategoriesList();
                    loadCategories(); // Actualizar gr√°fico
                } else {
                    showToast(result.error || 'Error creando categor√≠a', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error de conexi√≥n', 'error');
            }
        }

        async function deleteCategory(nombre) {
            if (!confirm(`¬øEliminar la categor√≠a "${nombre}"?`)) return;
            
            try {
                const response = await fetch(`/api/categories/custom/${encodeURIComponent(nombre)}`, { 
                    method: 'DELETE' 
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast(`Categor√≠a "${nombre}" eliminada`, 'success');
                    loadCategoriesList();
                    loadCategories();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function editCategoryKeywords(nombre) {
            const customResponse = await fetch('/api/categories/custom');
            const customResult = await customResponse.json();
            const currentKeywords = customResult.data?.keywords?.[nombre] || [];
            
            const newKeywords = prompt(
                `Editar palabras clave para "${nombre}"\n(separadas por coma):`,
                currentKeywords.join(', ')
            );
            
            if (newKeywords === null) return; // Cancelado
            
            const keywords = newKeywords.split(',').map(k => k.trim()).filter(k => k);
            
            try {
                const response = await fetch(`/api/categories/custom/${encodeURIComponent(nombre)}/keywords`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keywords })
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast('Keywords actualizadas', 'success');
                    loadCategoriesList();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // COMPARATIVA POSICIONES
        let positionsComparisonChart = null;
        const chartColors = [
            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
            '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1',
            '#14b8a6', '#f43f5e', '#a855f7', '#22c55e', '#eab308'
        ];

        async function loadPositionsComparison() {
            const periodo = document.getElementById('comparison-period').value;
            const normalized = document.getElementById('normalize-toggle').checked;
            
            document.getElementById('comparison-loader').classList.remove('hidden');
            document.getElementById('comparison-warning').classList.add('hidden');
            
            try {
                const response = await fetch(`/api/portfolio/positions-evolution?periodo=${periodo}&normalized=${normalized}`);
                const result = await response.json();
                
                document.getElementById('comparison-loader').classList.add('hidden');
                
                if (result.success) {
                    // Mostrar warning si hay activos sin datos
                    const sinDatos = result.data.sin_datos || [];
                    if (sinDatos.length > 0) {
                        document.getElementById('comparison-warning').classList.remove('hidden');
                        document.getElementById('warning-count').textContent = sinDatos.length;
                        
                        const nombres = sinDatos.map(a => a.nombre.substring(0, 25)).join(', ');
                        document.getElementById('warning-names').textContent = nombres;
                    }
                    
                    if (result.data.posiciones && result.data.posiciones.length > 0) {
                        renderPositionsComparison(result.data, normalized);
                    } else {
                        // No hay datos para mostrar
                        document.getElementById('comparison-legend').innerHTML = `
                            <div class="text-gray-400 text-center py-8">
                                No hay datos hist√≥ricos disponibles.<br>
                                <span class="text-sm">Verifica que los ISINs son correctos.</span>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('comparison-loader').classList.add('hidden');
            }
        }

        function renderPositionsComparison(data, normalized) {
            if (positionsComparisonChart) positionsComparisonChart.destroy();
            
            const ctx = document.getElementById('positions-comparison-chart').getContext('2d');
            
            // Crear datasets para cada posici√≥n
            const datasets = data.posiciones.map((pos, index) => ({
                label: pos.nombre,
                data: pos.precios,
                borderColor: chartColors[index % chartColors.length],
                backgroundColor: 'transparent',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: chartColors[index % chartColors.length]
            }));
            
            positionsComparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.fechas,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: false // Usamos leyenda custom
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#9ca3af',
                            borderColor: '#374151',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: (ctx) => {
                                    const value = ctx.raw;
                                    if (normalized) {
                                        const change = value - 100;
                                        const sign = change >= 0 ? '+' : '';
                                        return `${ctx.dataset.label}: ${sign}${change.toFixed(1)}%`;
                                    }
                                    return `${ctx.dataset.label}: ${formatCurrency(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#9ca3af',
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            grid: { color: '#374151' },
                            ticks: { 
                                color: '#9ca3af',
                                callback: (val) => normalized ? val.toFixed(0) : formatCurrency(val)
                            }
                        }
                    }
                }
            });
            
            // Renderizar leyenda custom
            renderComparisonLegend(data.posiciones);
        }

        function renderComparisonLegend(posiciones) {
            const container = document.getElementById('comparison-legend');
            container.innerHTML = '';
            
            posiciones.forEach((pos, index) => {
                const color = chartColors[index % chartColors.length];
                const rentColor = pos.rentabilidad >= 0 ? 'text-green-400' : 'text-red-400';
                const sign = pos.rentabilidad >= 0 ? '+' : '';
                const fuenteIcon = pos.fuente === 'justETF' ? 'üî∑' : 'üìà';
                
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 px-3 py-1 bg-gray-700/50 rounded-full cursor-pointer hover:bg-gray-700 transition';
                div.title = `Datos de ${pos.fuente || 'Yahoo Finance'}`;
                div.innerHTML = `
                    <span class="w-3 h-3 rounded-full" style="background-color: ${color}"></span>
                    <span class="text-gray-300">${pos.nombre}</span>
                    <span class="${rentColor} font-medium">${sign}${pos.rentabilidad}%</span>
                    <span class="text-xs opacity-50">${fuenteIcon}</span>
                `;
                
                // Toggle visibility on click
                div.onclick = () => toggleDataset(index, div);
                
                container.appendChild(div);
            });
        }

        function toggleDataset(index, element) {
            const chart = positionsComparisonChart;
            const meta = chart.getDatasetMeta(index);
            meta.hidden = !meta.hidden;
            chart.update();
            
            // Update legend style
            if (meta.hidden) {
                element.classList.add('opacity-40');
            } else {
                element.classList.remove('opacity-40');
            }
        }

        // =====================
        // MATRIZ DE CORRELACI√ìN
        // =====================
        
        let datosHistoricosCache = {};
        let ultimoPeriodoMatriz = null;
        
        async function calcularMatrizCorrelacion() {
            document.getElementById('matriz-placeholder').classList.add('hidden');
            document.getElementById('matriz-container').classList.add('hidden');
            document.getElementById('matriz-loading').classList.remove('hidden');
            
            // Obtener per√≠odo seleccionado
            const periodoSelect = document.getElementById('matriz-periodo');
            const periodo = periodoSelect.value;
            const periodoTexto = periodoSelect.options[periodoSelect.selectedIndex].text;
            
            // Limpiar cach√© si cambi√≥ el per√≠odo
            if (ultimoPeriodoMatriz !== periodo) {
                datosHistoricosCache = {};
                ultimoPeriodoMatriz = periodo;
            }
            
            try {
                // Obtener posiciones
                const response = await fetch('/api/portfolio');
                const result = await response.json();
                
                if (!result.success || !result.data.posiciones || result.data.posiciones.length < 2) {
                    document.getElementById('matriz-loading').classList.add('hidden');
                    document.getElementById('matriz-placeholder').classList.remove('hidden');
                    document.getElementById('matriz-placeholder').innerHTML = '<p class="text-yellow-400">Necesitas al menos 2 activos para calcular correlaciones</p>';
                    return;
                }
                
                const posiciones = result.data.posiciones.filter(p => p.ticker || p.isin);
                
                if (posiciones.length < 2) {
                    document.getElementById('matriz-loading').classList.add('hidden');
                    document.getElementById('matriz-placeholder').classList.remove('hidden');
                    document.getElementById('matriz-placeholder').innerHTML = '<p class="text-yellow-400">Necesitas al menos 2 activos con ticker/ISIN para calcular correlaciones</p>';
                    return;
                }
                
                // Obtener datos hist√≥ricos de cada posici√≥n
                const datosHistoricos = {};
                
                for (const pos of posiciones) {
                    try {
                        const ticker = pos.ticker || pos.isin;
                        const isin = pos.isin || '';
                        const cacheKey = `${ticker}_${isin}_${periodo}`;
                        
                        // Usar cach√© si existe
                        if (datosHistoricosCache[cacheKey]) {
                            datosHistoricos[pos.id] = datosHistoricosCache[cacheKey];
                            continue;
                        }
                        
                        const histResponse = await fetch(`/api/historical/${encodeURIComponent(ticker)}?periodo=${periodo}&isin=${encodeURIComponent(isin)}`);
                        const histResult = await histResponse.json();
                        
                        if (histResult.success && histResult.data.precios && histResult.data.fechas) {
                            // Calcular retornos por fecha
                            const retornosPorFecha = {};
                            const precios = histResult.data.precios;
                            const fechas = histResult.data.fechas;
                            
                            for (let i = 1; i < precios.length; i++) {
                                const retorno = (precios[i] - precios[i-1]) / precios[i-1];
                                retornosPorFecha[fechas[i]] = retorno;
                            }
                            
                            datosHistoricos[pos.id] = {
                                nombre: pos.nombre.length > 20 ? pos.nombre.substring(0, 20) + '...' : pos.nombre,
                                nombreCompleto: pos.nombre,
                                retornosPorFecha: retornosPorFecha
                            };
                            
                            // Guardar en cach√©
                            datosHistoricosCache[cacheKey] = datosHistoricos[pos.id];
                        }
                    } catch (e) {
                        console.error('Error obteniendo datos de', pos.nombre, e);
                    }
                }
                
                // Calcular matriz de correlaci√≥n
                const ids = Object.keys(datosHistoricos);
                
                if (ids.length < 2) {
                    document.getElementById('matriz-loading').classList.add('hidden');
                    document.getElementById('matriz-placeholder').classList.remove('hidden');
                    document.getElementById('matriz-placeholder').innerHTML = '<p class="text-yellow-400">No se pudieron obtener datos hist√≥ricos suficientes</p>';
                    return;
                }
                
                const matriz = {};
                
                for (const id1 of ids) {
                    matriz[id1] = {};
                    for (const id2 of ids) {
                        if (id1 === id2) {
                            matriz[id1][id2] = 1; // Correlaci√≥n consigo mismo = 1
                        } else if (matriz[id2] && matriz[id2][id1] !== undefined) {
                            matriz[id1][id2] = matriz[id2][id1]; // Matriz sim√©trica
                        } else {
                            // Calcular correlaci√≥n
                            const datos1 = datosHistoricos[id1].retornosPorFecha;
                            const datos2 = datosHistoricos[id2].retornosPorFecha;
                            
                            // Encontrar fechas comunes
                            const fechasComunes = Object.keys(datos1).filter(f => datos2.hasOwnProperty(f));
                            
                            if (fechasComunes.length >= 30) {
                                const retornos1 = fechasComunes.map(f => datos1[f]);
                                const retornos2 = fechasComunes.map(f => datos2[f]);
                                matriz[id1][id2] = calcularCorrelacion(retornos1, retornos2);
                            } else {
                                matriz[id1][id2] = null; // No hay suficientes datos
                            }
                        }
                    }
                }
                
                // Mostrar matriz
                mostrarMatrizCorrelacion(datosHistoricos, matriz, ids, periodoTexto);
                
                document.getElementById('matriz-loading').classList.add('hidden');
                document.getElementById('matriz-container').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error calculando matriz:', error);
                document.getElementById('matriz-loading').classList.add('hidden');
                document.getElementById('matriz-placeholder').classList.remove('hidden');
                document.getElementById('matriz-placeholder').innerHTML = '<p class="text-red-400">Error al calcular la matriz</p>';
            }
        }
        
        function calcularCorrelacion(x, y) {
            const n = x.length;
            if (n < 10) return null;
            
            const mediaX = x.reduce((a, b) => a + b, 0) / n;
            const mediaY = y.reduce((a, b) => a + b, 0) / n;
            
            let numerador = 0;
            let sumCuadX = 0;
            let sumCuadY = 0;
            
            for (let i = 0; i < n; i++) {
                const difX = x[i] - mediaX;
                const difY = y[i] - mediaY;
                numerador += difX * difY;
                sumCuadX += difX * difX;
                sumCuadY += difY * difY;
            }
            
            const denominador = Math.sqrt(sumCuadX * sumCuadY);
            if (denominador === 0) return 0;
            
            return numerador / denominador;
        }
        
        function getColorCorrelacion(corr) {
            if (corr === null) return { bg: 'bg-gray-700', text: 'text-gray-500' };
            if (corr === 1) return { bg: 'bg-gray-600', text: 'text-gray-300' };
            if (corr >= 0.7) return { bg: 'bg-red-600', text: 'text-white' };
            if (corr >= 0.4) return { bg: 'bg-yellow-600', text: 'text-white' };
            if (corr >= -0.4) return { bg: 'bg-green-600', text: 'text-white' };
            if (corr >= -0.7) return { bg: 'bg-blue-500', text: 'text-white' };
            return { bg: 'bg-blue-700', text: 'text-white' };
        }
        
        function mostrarMatrizCorrelacion(datos, matriz, ids, periodoTexto) {
            const table = document.getElementById('matriz-table');
            
            // Mostrar info del per√≠odo
            const infoElement = document.getElementById('matriz-periodo-info');
            infoElement.innerHTML = `üìÖ Correlaciones calculadas con datos de <strong>${periodoTexto}</strong> (${ids.length} activos)`;
            
            // Header
            let html = '<thead><tr><th class="p-2 text-left text-gray-400 font-normal"></th>';
            for (const id of ids) {
                html += `<th class="p-2 text-center text-gray-300 font-normal text-xs" title="${datos[id].nombreCompleto}">${datos[id].nombre}</th>`;
            }
            html += '</tr></thead>';
            
            // Body
            html += '<tbody>';
            for (const id1 of ids) {
                html += `<tr><td class="p-2 text-gray-300 text-xs whitespace-nowrap" title="${datos[id1].nombreCompleto}">${datos[id1].nombre}</td>`;
                
                for (const id2 of ids) {
                    const corr = matriz[id1][id2];
                    const colors = getColorCorrelacion(corr);
                    
                    if (corr === null) {
                        html += `<td class="p-1"><div class="${colors.bg} ${colors.text} rounded p-2 text-center text-xs">-</div></td>`;
                    } else if (id1 === id2) {
                        html += `<td class="p-1"><div class="${colors.bg} ${colors.text} rounded p-2 text-center text-xs">‚Äî</div></td>`;
                    } else {
                        const corrPct = (corr * 100).toFixed(0);
                        html += `<td class="p-1"><div class="${colors.bg} ${colors.text} rounded p-2 text-center text-xs font-medium cursor-help" title="${datos[id1].nombreCompleto} vs ${datos[id2].nombreCompleto}: ${corrPct}%">${corr >= 0 ? '+' : ''}${corrPct}%</div></td>`;
                    }
                }
                
                html += '</tr>';
            }
            html += '</tbody>';
            
            table.innerHTML = html;
        }

        // =====================
        // AN√ÅLISIS EXPERTO DE CARTERA
        // =====================
        
        async function analizarCartera() {
            document.getElementById('analisis-placeholder').classList.add('hidden');
            document.getElementById('analisis-container').classList.add('hidden');
            document.getElementById('analisis-loading').classList.remove('hidden');
            
            try {
                // Obtener datos del portfolio
                const response = await fetch('/api/portfolio');
                const result = await response.json();
                
                if (!result.success || !result.data.posiciones || result.data.posiciones.length === 0) {
                    mostrarErrorAnalisis('No hay posiciones en la cartera para analizar');
                    return;
                }
                
                const portfolio = result.data;
                const posiciones = portfolio.posiciones;
                const valorTotal = portfolio.valor_total || posiciones.reduce((sum, p) => sum + (p.valor_actual || 0), 0);
                
                // Calcular m√©tricas
                const metricas = calcularMetricasCartera(posiciones, valorTotal);
                const problemas = detectarProblemas(posiciones, metricas);
                const sugerencias = generarSugerencias(posiciones, metricas, problemas);
                const recomendados = generarRecomendaciones(posiciones, metricas);
                const comparacionModelos = compararConModelos(metricas);
                
                // Calcular score general
                const score = calcularScoreCartera(metricas, problemas);
                
                // Mostrar resultados
                mostrarResultadosAnalisis(score, metricas, problemas, sugerencias, recomendados, comparacionModelos);
                
                document.getElementById('analisis-loading').classList.add('hidden');
                document.getElementById('analisis-container').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error analizando cartera:', error);
                mostrarErrorAnalisis('Error al analizar la cartera');
            }
        }
        
        function mostrarErrorAnalisis(mensaje) {
            document.getElementById('analisis-loading').classList.add('hidden');
            document.getElementById('analisis-placeholder').classList.remove('hidden');
            document.getElementById('analisis-placeholder').innerHTML = `<p class="text-red-400">${mensaje}</p>`;
        }
        
        function calcularMetricasCartera(posiciones, valorTotal) {
            // Distribuci√≥n por categor√≠as
            const categorias = {};
            posiciones.forEach(p => {
                const cat = p.categoria || 'Sin categor√≠a';
                if (!categorias[cat]) categorias[cat] = 0;
                categorias[cat] += p.valor_actual || 0;
            });
            
            // Convertir a porcentajes
            const distribucionCategorias = {};
            for (const [cat, valor] of Object.entries(categorias)) {
                distribucionCategorias[cat] = (valor / valorTotal) * 100;
            }
            
            // Concentraci√≥n (peso del activo m√°s grande)
            const pesosActivos = posiciones.map(p => ((p.valor_actual || 0) / valorTotal) * 100);
            const maxPeso = Math.max(...pesosActivos);
            const top3Peso = pesosActivos.sort((a, b) => b - a).slice(0, 3).reduce((a, b) => a + b, 0);
            
            // N√∫mero de activos
            const numActivos = posiciones.length;
            
            // N√∫mero de categor√≠as
            const numCategorias = Object.keys(categorias).length;
            
            // Funci√≥n helper para detectar categor√≠as (case insensitive)
            const categoriasLower = Object.keys(distribucionCategorias).map(c => c.toLowerCase());
            const tieneCategoria = (palabras) => categoriasLower.some(c => 
                palabras.some(p => c.includes(p.toLowerCase()))
            );
            
            // Clasificar tipos de activos
            const tieneRentaVariable = tieneCategoria([
                'variable', 'acciones', 'equity', 'stock', 'global', 'diversificado', 
                'world', 'tecnolog√≠a', 'tecnologia', 'tech', 'small', 'emergentes',
                'eeuu', 'usa', 'europa', 'asia', 'msci', 'ftse', 'index'
            ]);
            const tieneRentaFija = tieneCategoria([
                'fija', 'bonos', 'bond', 'treasury', 'deuda', 'monetario'
            ]);
            const tieneOro = tieneCategoria([
                'oro', 'gold', 'plata', 'silver', 'materias', 'commodit'
            ]);
            const tieneCrypto = tieneCategoria([
                'crypto', 'bitcoin', 'ethereum', 'cripto'
            ]);
            const tieneEmergentes = tieneCategoria([
                'emergentes', 'emerging', 'em '
            ]);
            const tieneSmallCaps = tieneCategoria([
                'small', 'peque√±as', 'small cap'
            ]);
            
            // Calcular % de renta variable vs resto
            let pctRentaVariable = 0;
            let pctRentaFija = 0;
            let pctAlternativos = 0;
            
            for (const [cat, pct] of Object.entries(distribucionCategorias)) {
                const catLower = cat.toLowerCase();
                // Renta Variable: acciones, fondos de renta variable, √≠ndices burs√°tiles
                if (catLower.includes('variable') || catLower.includes('acciones') || catLower.includes('equity') || 
                    catLower.includes('tech') || catLower.includes('tecnolog√≠a') || catLower.includes('tecnologia') ||
                    catLower.includes('small') || catLower.includes('emergentes') || catLower.includes('emerging') ||
                    catLower.includes('global') || catLower.includes('diversificado') || catLower.includes('world') ||
                    catLower.includes('stock') || catLower.includes('index') || catLower.includes('eeuu') ||
                    catLower.includes('usa') || catLower.includes('europa') || catLower.includes('europe') ||
                    catLower.includes('asia') || catLower.includes('sp500') || catLower.includes('s&p') ||
                    catLower.includes('nasdaq') || catLower.includes('msci') || catLower.includes('ftse')) {
                    pctRentaVariable += pct;
                } else if (catLower.includes('fija') || catLower.includes('bonos') || catLower.includes('bond') ||
                           catLower.includes('treasury') || catLower.includes('deuda') || catLower.includes('monetario')) {
                    pctRentaFija += pct;
                } else if (catLower.includes('oro') || catLower.includes('gold') || catLower.includes('plata') ||
                           catLower.includes('silver') || catLower.includes('materias') || catLower.includes('commodit')) {
                    // Materias primas van a alternativos pero no son ni RV ni RF
                    pctAlternativos += pct;
                } else if (catLower.includes('crypto') || catLower.includes('bitcoin') || catLower.includes('ethereum')) {
                    // Crypto va a alternativos
                    pctAlternativos += pct;
                } else {
                    // Por defecto, si no sabemos qu√© es, lo ponemos en alternativos
                    pctAlternativos += pct;
                }
            }
            
            return {
                distribucionCategorias,
                numActivos,
                numCategorias,
                maxPeso,
                top3Peso,
                tieneRentaVariable,
                tieneRentaFija,
                tieneOro,
                tieneCrypto,
                tieneEmergentes,
                tieneSmallCaps,
                pctRentaVariable,
                pctRentaFija,
                pctAlternativos,
                valorTotal
            };
        }
        
        function detectarProblemas(posiciones, metricas) {
            const problemas = [];
            
            // Concentraci√≥n excesiva
            if (metricas.maxPeso > 40) {
                problemas.push({
                    tipo: 'grave',
                    titulo: 'Concentraci√≥n muy alta',
                    descripcion: `Un solo activo representa el ${metricas.maxPeso.toFixed(1)}% de tu cartera. Riesgo elevado.`
                });
            } else if (metricas.maxPeso > 25) {
                problemas.push({
                    tipo: 'moderado',
                    titulo: 'Concentraci√≥n alta',
                    descripcion: `Un activo representa el ${metricas.maxPeso.toFixed(1)}% de tu cartera.`
                });
            }
            
            // Top 3 muy concentrado
            if (metricas.top3Peso > 80 && metricas.numActivos > 3) {
                problemas.push({
                    tipo: 'moderado',
                    titulo: 'Cartera muy concentrada',
                    descripcion: `Los 3 mayores activos representan el ${metricas.top3Peso.toFixed(1)}% del total.`
                });
            }
            
            // Pocas categor√≠as
            if (metricas.numCategorias < 3 && metricas.numActivos >= 3) {
                problemas.push({
                    tipo: 'moderado',
                    titulo: 'Poca diversificaci√≥n por tipo',
                    descripcion: `Solo tienes ${metricas.numCategorias} categor√≠as diferentes.`
                });
            }
            
            // Solo renta variable
            if (metricas.pctRentaVariable > 90 && !metricas.tieneRentaFija && !metricas.tieneOro) {
                problemas.push({
                    tipo: 'moderado',
                    titulo: 'Sin activos defensivos',
                    descripcion: 'Tu cartera es 100% renta variable. En ca√≠das del mercado, caer√° todo junto.'
                });
            }
            
            // Crypto muy alto
            if (metricas.tieneCrypto) {
                const pctCrypto = metricas.distribucionCategorias['Crypto'] || 0;
                if (pctCrypto > 20) {
                    problemas.push({
                        tipo: 'grave',
                        titulo: 'Exposici√≥n crypto muy alta',
                        descripcion: `${pctCrypto.toFixed(1)}% en crypto. Alta volatilidad y riesgo.`
                    });
                } else if (pctCrypto > 10) {
                    problemas.push({
                        tipo: 'leve',
                        titulo: 'Exposici√≥n crypto elevada',
                        descripcion: `${pctCrypto.toFixed(1)}% en crypto. Considera si es adecuado para tu perfil.`
                    });
                }
            }
            
            // Pocos activos
            if (metricas.numActivos < 4) {
                problemas.push({
                    tipo: 'leve',
                    titulo: 'Pocos activos',
                    descripcion: `Solo tienes ${metricas.numActivos} activos. Considera diversificar m√°s.`
                });
            }
            
            return problemas;
        }
        
        function generarSugerencias(posiciones, metricas, problemas) {
            const sugerencias = [];
            
            // Basadas en problemas
            if (problemas.some(p => p.titulo.includes('Concentraci√≥n'))) {
                sugerencias.push({
                    icono: '‚öñÔ∏è',
                    texto: 'Considera reducir el peso de los activos m√°s grandes y distribuir en m√°s posiciones.'
                });
            }
            
            if (!metricas.tieneRentaFija && metricas.pctRentaVariable > 70) {
                sugerencias.push({
                    icono: 'üõ°Ô∏è',
                    texto: 'A√±adir renta fija (bonos) podr√≠a reducir la volatilidad de tu cartera.'
                });
            }
            
            if (!metricas.tieneOro && metricas.valorTotal > 5000) {
                sugerencias.push({
                    icono: 'ü•á',
                    texto: 'El oro (5-10% de la cartera) puede actuar como cobertura en crisis.'
                });
            }
            
            if (!metricas.tieneEmergentes && metricas.pctRentaVariable > 50) {
                sugerencias.push({
                    icono: 'üåç',
                    texto: 'Mercados emergentes pueden aportar diversificaci√≥n geogr√°fica y mayor potencial.'
                });
            }
            
            if (!metricas.tieneSmallCaps && metricas.numActivos >= 4) {
                sugerencias.push({
                    icono: 'üöÄ',
                    texto: 'Small Caps pueden a√±adir potencial de crecimiento (aunque con m√°s volatilidad).'
                });
            }
            
            // Sugerencia general
            if (metricas.numActivos >= 5 && problemas.length === 0) {
                sugerencias.push({
                    icono: '‚úÖ',
                    texto: '¬°Tu cartera tiene buena estructura! Mant√©n la disciplina y aporta regularmente.'
                });
            }
            
            // Rebalanceo
            if (metricas.maxPeso > 30) {
                sugerencias.push({
                    icono: 'üîÑ',
                    texto: 'Considera rebalancear cada 6-12 meses para mantener tus pesos objetivo.'
                });
            }
            
            return sugerencias;
        }
        
        function generarRecomendaciones(posiciones, metricas) {
            const recomendaciones = [];
            
            // ETFs recomendados seg√∫n lo que falta
            if (!metricas.tieneRentaFija) {
                recomendaciones.push({
                    nombre: 'Vanguard Global Aggregate Bond',
                    isin: 'IE00BG47KH54',
                    tipo: 'Renta Fija Global',
                    razon: 'Diversificaci√≥n y reducci√≥n de volatilidad'
                });
            }
            
            if (!metricas.tieneOro) {
                recomendaciones.push({
                    nombre: 'Invesco Physical Gold',
                    isin: 'IE00B579F325',
                    tipo: 'Oro',
                    razon: 'Cobertura contra inflaci√≥n y crisis'
                });
            }
            
            if (!metricas.tieneEmergentes) {
                recomendaciones.push({
                    nombre: 'iShares Core MSCI EM IMI',
                    isin: 'IE00BKM4GZ66',
                    tipo: 'Renta Variable Emergentes',
                    razon: 'Diversificaci√≥n geogr√°fica'
                });
            }
            
            if (!metricas.tieneSmallCaps) {
                recomendaciones.push({
                    nombre: 'iShares MSCI World Small Cap',
                    isin: 'IE00BF4RFH31',
                    tipo: 'Small Caps Global',
                    razon: 'Mayor potencial de crecimiento'
                });
            }
            
            // Si tiene mucha renta variable USA, sugerir Europa
            const tieneUSA = Object.keys(metricas.distribucionCategorias).some(c => 
                c.includes('EEUU') || c.includes('USA') || c.includes('S&P')
            );
            if (tieneUSA && metricas.pctRentaVariable > 60) {
                recomendaciones.push({
                    nombre: 'Vanguard FTSE Developed Europe',
                    isin: 'IE00BK5BQX27',
                    tipo: 'Renta Variable Europa',
                    razon: 'Reducir concentraci√≥n en USA'
                });
            }
            
            // Si no tiene nada global
            const tieneGlobal = Object.keys(metricas.distribucionCategorias).some(c => 
                c.includes('Global') || c.includes('World') || c.includes('Mundial')
            );
            if (!tieneGlobal && metricas.numActivos < 5) {
                recomendaciones.push({
                    nombre: 'Vanguard FTSE All-World',
                    isin: 'IE00BK5BQT80',
                    tipo: 'Renta Variable Global',
                    razon: 'Base s√≥lida de diversificaci√≥n mundial'
                });
            }
            
            return recomendaciones.slice(0, 4); // M√°ximo 4 recomendaciones
        }
        
        function compararConModelos(metricas) {
            const modelos = [
                {
                    nombre: 'Conservadora (40/60)',
                    descripcion: '40% RV, 60% RF',
                    rv: 40, rf: 60, alt: 0,
                    perfil: 'Bajo riesgo, preservar capital'
                },
                {
                    nombre: 'Moderada (60/40)',
                    descripcion: '60% RV, 40% RF',
                    rv: 60, rf: 40, alt: 0,
                    perfil: 'Equilibrio riesgo/rentabilidad'
                },
                {
                    nombre: 'Agresiva (80/20)',
                    descripcion: '80% RV, 20% RF',
                    rv: 80, rf: 20, alt: 0,
                    perfil: 'Crecimiento a largo plazo'
                },
                {
                    nombre: 'All-Weather',
                    descripcion: '30% RV, 55% RF, 15% Oro',
                    rv: 30, rf: 55, alt: 15,
                    perfil: 'Resistir cualquier escenario'
                },
                {
                    nombre: 'Growth',
                    descripcion: '90% RV, 5% RF, 5% Crypto',
                    rv: 90, rf: 5, alt: 5,
                    perfil: 'M√°ximo crecimiento, alto riesgo'
                }
            ];
            
            // Calcular similitud con cada modelo
            const tuCartera = {
                rv: metricas.pctRentaVariable,
                rf: metricas.pctRentaFija,
                alt: metricas.pctAlternativos
            };
            
            return modelos.map(modelo => {
                const diffRV = Math.abs(modelo.rv - tuCartera.rv);
                const diffRF = Math.abs(modelo.rf - tuCartera.rf);
                const diffAlt = Math.abs(modelo.alt - tuCartera.alt);
                const similitud = 100 - (diffRV + diffRF + diffAlt) / 3;
                
                return {
                    ...modelo,
                    similitud: Math.max(0, similitud)
                };
            }).sort((a, b) => b.similitud - a.similitud);
        }
        
        function calcularScoreCartera(metricas, problemas) {
            let score = 100;
            
            // Penalizar por problemas
            problemas.forEach(p => {
                if (p.tipo === 'grave') score -= 20;
                else if (p.tipo === 'moderado') score -= 10;
                else score -= 5;
            });
            
            // Bonus por diversificaci√≥n
            if (metricas.numCategorias >= 4) score += 5;
            if (metricas.numActivos >= 5) score += 5;
            if (metricas.tieneOro) score += 3;
            if (metricas.tieneRentaFija) score += 5;
            if (metricas.tieneEmergentes) score += 3;
            
            // Penalizar por concentraci√≥n
            if (metricas.maxPeso > 50) score -= 15;
            else if (metricas.maxPeso > 30) score -= 5;
            
            return Math.max(0, Math.min(100, score));
        }
        
        function mostrarResultadosAnalisis(score, metricas, problemas, sugerencias, recomendados, comparacionModelos) {
            // Score
            let scoreColor, scoreEmoji, scoreTexto;
            if (score >= 80) {
                scoreColor = 'bg-green-900/30 border-green-500';
                scoreEmoji = 'üåü';
                scoreTexto = 'Excelente';
            } else if (score >= 60) {
                scoreColor = 'bg-yellow-900/30 border-yellow-500';
                scoreEmoji = 'üëç';
                scoreTexto = 'Buena';
            } else if (score >= 40) {
                scoreColor = 'bg-orange-900/30 border-orange-500';
                scoreEmoji = '‚ö†Ô∏è';
                scoreTexto = 'Mejorable';
            } else {
                scoreColor = 'bg-red-900/30 border-red-500';
                scoreEmoji = 'üö®';
                scoreTexto = 'Necesita mejoras';
            }
            
            document.getElementById('analisis-score').className = `text-center p-6 rounded-xl border-2 ${scoreColor}`;
            document.getElementById('analisis-score').innerHTML = `
                <div class="text-4xl mb-2">${scoreEmoji}</div>
                <div class="text-5xl font-bold mb-2">${score}</div>
                <div class="text-xl text-gray-300">${scoreTexto}</div>
                <div class="text-sm text-gray-500 mt-2">Puntuaci√≥n de salud de la cartera</div>
            `;
            
            // M√©tricas
            document.getElementById('analisis-metricas').innerHTML = `
                <div class="p-4 bg-gray-700/30 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-400">${metricas.numActivos}</div>
                    <div class="text-xs text-gray-400">Activos</div>
                </div>
                <div class="p-4 bg-gray-700/30 rounded-lg text-center">
                    <div class="text-2xl font-bold text-purple-400">${metricas.numCategorias}</div>
                    <div class="text-xs text-gray-400">Categor√≠as</div>
                </div>
                <div class="p-4 bg-gray-700/30 rounded-lg text-center">
                    <div class="text-2xl font-bold ${metricas.maxPeso > 30 ? 'text-red-400' : 'text-green-400'}">${metricas.maxPeso.toFixed(0)}%</div>
                    <div class="text-xs text-gray-400">Mayor posici√≥n</div>
                </div>
                <div class="p-4 bg-gray-700/30 rounded-lg text-center">
                    <div class="text-2xl font-bold text-cyan-400">${metricas.pctRentaVariable.toFixed(0)}%</div>
                    <div class="text-xs text-gray-400">Renta Variable</div>
                </div>
            `;
            
            // Problemas
            if (problemas.length > 0) {
                document.getElementById('analisis-problemas').className = 'p-4 bg-red-900/20 border border-red-700/50 rounded-lg';
                document.getElementById('analisis-problemas').innerHTML = `
                    <h4 class="font-semibold text-red-400 mb-3 flex items-center gap-2">
                        <span>‚ö†Ô∏è</span> Problemas detectados (${problemas.length})
                    </h4>
                    <div class="space-y-2">
                        ${problemas.map(p => `
                            <div class="flex items-start gap-2 text-sm">
                                <span class="${p.tipo === 'grave' ? 'text-red-400' : p.tipo === 'moderado' ? 'text-yellow-400' : 'text-blue-400'}">
                                    ${p.tipo === 'grave' ? 'üî¥' : p.tipo === 'moderado' ? 'üü°' : 'üîµ'}
                                </span>
                                <div>
                                    <strong>${p.titulo}</strong>
                                    <p class="text-gray-400">${p.descripcion}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                document.getElementById('analisis-problemas').className = 'p-4 bg-green-900/20 border border-green-700/50 rounded-lg';
                document.getElementById('analisis-problemas').innerHTML = `
                    <h4 class="font-semibold text-green-400 flex items-center gap-2">
                        <span>‚úÖ</span> No se detectaron problemas importantes
                    </h4>
                `;
            }
            
            // Sugerencias
            document.getElementById('analisis-sugerencias').innerHTML = `
                <h4 class="font-semibold text-blue-400 mb-3 flex items-center gap-2">
                    <span>üí°</span> Sugerencias de mejora
                </h4>
                <div class="space-y-2">
                    ${sugerencias.map(s => `
                        <div class="flex items-start gap-2 text-sm">
                            <span>${s.icono}</span>
                            <span class="text-gray-300">${s.texto}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Recomendados
            if (recomendados.length > 0) {
                document.getElementById('analisis-recomendados').innerHTML = `
                    <h4 class="font-semibold text-purple-400 mb-3 flex items-center gap-2">
                        <span>üéØ</span> Activos que podr√≠an complementar tu cartera
                    </h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        ${recomendados.map(r => `
                            <div class="p-3 bg-gray-800/50 rounded-lg">
                                <div class="font-medium text-white text-sm">${r.nombre}</div>
                                <div class="text-xs text-gray-500">${r.isin}</div>
                                <div class="text-xs text-purple-400 mt-1">${r.tipo}</div>
                                <div class="text-xs text-gray-400 mt-1">‚Üí ${r.razon}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                document.getElementById('analisis-recomendados').innerHTML = `
                    <h4 class="font-semibold text-purple-400 flex items-center gap-2">
                        <span>‚úÖ</span> Tu cartera ya est√° bien diversificada
                    </h4>
                `;
            }
            
            // Comparaci√≥n con modelos
            const modeloMasCercano = comparacionModelos[0];
            document.getElementById('analisis-modelos').innerHTML = `
                <h4 class="font-semibold text-gray-300 mb-3 flex items-center gap-2">
                    <span>üìä</span> Tu cartera se parece m√°s a...
                </h4>
                <div class="flex items-center gap-4 mb-4">
                    <div class="text-3xl font-bold text-cyan-400">${modeloMasCercano.nombre}</div>
                    <div class="text-sm text-gray-400">(${modeloMasCercano.similitud.toFixed(0)}% similar)</div>
                </div>
                <div class="text-sm text-gray-400 mb-4">${modeloMasCercano.descripcion} - ${modeloMasCercano.perfil}</div>
                <div class="grid grid-cols-2 sm:grid-cols-5 gap-2 text-xs">
                    ${comparacionModelos.map(m => `
                        <div class="p-2 rounded ${m === modeloMasCercano ? 'bg-cyan-900/30 border border-cyan-700' : 'bg-gray-700/30'}">
                            <div class="font-medium ${m === modeloMasCercano ? 'text-cyan-400' : 'text-gray-400'}">${m.nombre}</div>
                            <div class="text-gray-500">${m.similitud.toFixed(0)}%</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // =====================
        // PWA: Registrar Service Worker
        // =====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('‚ùå Service Worker error:', error);
                    });
            });
        }
        
        // PWA: Detectar si est√° instalada
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Mostrar bot√≥n de instalaci√≥n si quieres
            console.log('üì± PWA lista para instalar');
        });
        
        // PWA: Detectar cuando se instala
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA instalada');
            deferredPrompt = null;
        });
    </script>
    
    <!-- Barra de navegaci√≥n m√≥vil (solo visible en pantallas peque√±as) -->
    <nav class="mobile-nav fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700 px-1 py-2 md:hidden z-50" style="padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));">
        <div class="flex justify-around items-center">
            <a href="/" class="flex flex-col items-center text-blue-400 py-1 px-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="text-[10px] mt-0.5">Inicio</span>
            </a>
            <a href="/explorar" class="flex flex-col items-center text-gray-400 hover:text-purple-400 py-1 px-2 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <span class="text-[10px] mt-0.5">Explorar</span>
            </a>
            <a href="/heatmap" class="flex flex-col items-center text-gray-400 hover:text-rose-400 py-1 px-2 transition">
                <span class="text-lg">üî•</span>
                <span class="text-[10px] mt-0.5">Heatmap</span>
            </a>
            <a href="/add" class="flex flex-col items-center justify-center bg-blue-600 rounded-full w-12 h-12 -mt-5 shadow-lg">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </a>
            <a href="/alertas" class="relative flex flex-col items-center text-gray-400 hover:text-orange-400 py-1 px-2 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                </svg>
                <span class="text-[10px] mt-0.5">Alertas</span>
                <span id="alertas-badge-mobile" class="hidden absolute -top-0.5 right-0 w-3.5 h-3.5 bg-red-500 text-white text-[8px] rounded-full flex items-center justify-center">!</span>
            </a>
            <a href="/settings" class="flex flex-col items-center text-gray-400 hover:text-gray-200 py-1 px-2 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span class="text-[10px] mt-0.5">Ajustes</span>
            </a>
        </div>
    </nav>
</body>
</html>
